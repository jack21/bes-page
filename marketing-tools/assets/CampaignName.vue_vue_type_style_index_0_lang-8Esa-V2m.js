import{o as g,a as G,b as w,d as O,u as Y,r as F,c as A,w as ie,P as Q,e,f as t,i as P,j,t as $,s as Fe,v as le,x as ze,z as Me,p as E,A as Ee,y as Ve,k as pe,B as _e,C as De,n as Ue,g as r,F as te,h as D,D as se,E as Ce,G as Pe,I as Ae,H as Re,Q as je,J as He,K as fe,L as ve,O as he,M as ge,N as be,R as Se,Y as Oe,U as ae,V as Ye,W as Le,T as Ie,X as ye,S as We,q as Ne,Z as Ze,$ as qe,a0 as Je}from"./index-yJRNPwA5.js";import{_ as ue}from"./download-lUU2CSuZ.js";import{_ as Qe}from"./delete-outline-JDy_see7.js";const Ke={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},Xe=w("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"},null,-1),et=[Xe];function tt(V,s){return g(),G("svg",Ke,[...et])}const $e={name:"mdi-close",render:tt},st={class:"export-sms-file"},nt=w("span",null,"門號 (商務簡訊)",-1),ot={key:0,class:"ms-4 mt-2"},lt={class:"d-flex mt-2 align-items-center w-100"},at={key:0,class:"hint"},it=O({__name:"ExportSmsFile",props:{disabled:{type:Boolean}},setup(V){const s=V,l=Y(),d=F(!1),v=F([]),S=F([]),b=F(0),y=F(0),C=F(new Set),f=F([]),a=F(!1),i={text:"匯入 91 優惠券",value:"upload-file"},m=A(()=>{const n=Array.from(l.userArgSet).map(c=>({text:c,value:c}));return n.push(i),n}),_=A(()=>v.value.findIndex(n=>n===i.value)>=0);ie(S,()=>{b.value=S.value.length,S.value.forEach(n=>L(n))});const L=n=>{a.value=!0,Q.parse(n,{header:!0,skipEmptyLines:!0,encoding:"big5",transformHeader:(c,o)=>(console.log(`Header: ${o}`,c),c==="領取券號"?"couponCode":c==="是否領取"?"isRedeem":c),complete:c=>{if(c.errors.length>0){alert("Parse Error"),a.value=!1;return}const o=f.value.length;c.data.forEach(N=>{if(N.isRedeem.indexOf("否")===-1){console.log(`[ExportSmsFile] Coupon Code redeem: ${N.couponCode} -> ${N.isRedeem}`);return}if(C.value.has(N.couponCode)){console.log(`[ExportSmsFile] Coupon Code duplicated: ${N.couponCode}`);return}C.value.add(N.couponCode),f.value.push(N.couponCode)});const I=f.value.length;console.log(`[ExportSmsFile] read ${c.data.length} -> ${I-o} coupon Code`),b.value--,y.value++,a.value=!1}})},k=A(()=>b.value>0),T=()=>{d.value=!0},z=async()=>{a.value=!0;const n=u(),c="export-sms-file-"+l.hashCode(l.campaignName);l.saveZip(n.fileName,n.downloadFileList,c),a.value=!1,d.value=!1},u=()=>{const n=[],c=le(new Date,"yyyyMMdd");let o=0,I=0;const N=l.smsGroupList,B=[],W=[],Z=[];for(let K=0;K<N.length;K++){const q=N[K];let ee=0;const M=[];console.log(`[ExportSmsFile] smsGroup: ${q.name}: ${q.smsSendInfoList.length}`);for(let H=0;H<q.smsSendInfoList.length;H++){const re=q.smsSendInfoList[H];o++;const X=h(re);I+=X.length,ee+=X.length,console.log(`[ExportSmsFile] smsGroup: ${q.name}: [${H+1}] ${X.length}`),Z.push(X.length);const de=l.partition(X,5e3);for(let ne=0;ne<de.length;ne++){const me=de[ne],Ge=Q.unparse(me,{delimiter:"	"}),Te=q.smsSendInfoList.length===1?"":`_${H+1}`,Be=de.length===1?"":`_${ne+1}`,we=`${l.campaignName}_商務簡訊_${c}_${K+1}${Te}${Be}_${q.name}_${me.length}.txt`;n.push({fileName:we,data:Ge}),B.push({smsText:re.text,phoneNumberFileName:we,smsCount:me.length})}M.push({smsText:re.text,smsCount:X.length})}W.push({taName:q.name,smsCount:ee,smsItemList:M})}const U={};U.sendHour=ze.Hour18,U.sendMinute=Me.Minute00,U.smsList=B,U.smsGroupList=W;const R=`${l.campaignName}_商務簡訊_${c}_${N.length}受眾_${o}群_${I}.cfg`,J=JSON.stringify(U);n.push({fileName:R,data:J});const ce=`${l.campaignName}_商務簡訊_${c}_${N.length}受眾_${o}群_${I}.zip`;return console.log(`受眾表用
${Z.join(`
`)}`),{fileName:ce,downloadFileList:n}},p=new Set(["0979940180","0937654385","0937573896","0970646973","0980317712"]),h=n=>{const c=[],o=n.phoneNumberList;for(let I=0;I<o.length;I++){const N=o[I];if(p.has(N))continue;const B=l.phoneNumberUserMap.get(N);if(!B)continue;const W=[N];for(let Z=0;Z<m.value.length;Z++){const U=m.value[Z];if(v.value.findIndex(J=>J===U.value)>=0)if(U.value===i.value){const J=f.value[c.length];B.couponCode=J,W.push(J)}else B.params&&W.push(B.params[U.value])}c.push(W)}return c},x=()=>{S.value=[],y.value=0,f.value.length=0,C.value.clear()};return(n,c)=>{const o=ue,I=E,N=Ee,B=Ve,W=$e,Z=pe,U=_e;return g(),G("div",st,[e(I,{variant:"outline-primary",size:"sm",onClick:T,disabled:s.disabled},{default:t(()=>[e(o),nt]),_:1},8,["disabled"]),e(U,{modelValue:d.value,"onUpdate:modelValue":c[2]||(c[2]=R=>d.value=R),"ok-title":"匯出","cancel-title":"取消","cancel-variant":"outline-secondary",title:"參數",class:"args-modal",busy:a.value,onOk:z,onCancel:c[3]||(c[3]=R=>d.value=!1),onClose:c[4]||(c[4]=R=>d.value=!1),onHide:c[5]||(c[5]=Fe(()=>{},["prevent"]))},{default:t(()=>[e(N,{modelValue:v.value,"onUpdate:modelValue":c[0]||(c[0]=R=>v.value=R),options:m.value,stacked:""},null,8,["modelValue","options"]),_.value?(g(),G("div",ot,[w("div",lt,[e(B,{modelValue:S.value,"onUpdate:modelValue":c[1]||(c[1]=R=>S.value=R),id:"dsc-file",accept:"text/csv",multiple:""},null,8,["modelValue"]),C.value.size>0&&!k.value?(g(),P(I,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:x},{default:t(()=>[e(W)]),_:1})):j("",!0),k.value?(g(),P(Z,{key:1,variant:"primary",class:"ms-1"})):j("",!0)]),y.value?(g(),G("small",at,"已讀取 "+$(y.value)+" 檔案, "+$(C.value.size)+" 筆記錄",1)):j("",!0)])):j("",!0)]),_:1},8,["modelValue","busy"])])}}}),ut={class:"export-sms-file"},ct=w("span",null,"門號 (客服)",-1),rt=O({__name:"ExportCustomServiceFile",props:{disabled:{type:Boolean}},setup(V){const s=V,l=Y(),d=()=>{const v=le(new Date,"yyyyMMdd"),S=l.smsGroupList.filter(a=>a.smsPhoneNumberFilted.length>0),b=[];let y=0,C=0;for(let a=0;a<S.length;a++){const i=S[a];for(let m=0;m<i.smsSendInfoList.length;m++){C++;const _=i.smsSendInfoList[m],L=`用戶分群: ${i.name}\r
簡訊內容: ${_.text}\r
發送數量: ${_.phoneNumberList.length}\r
`,k=`${l.campaignName}_客服_${v}_${C}_發送資訊.txt`;b.push({fileName:k,data:L});const T=[];_.phoneNumberList.forEach(u=>T.push([u])),y+=_.phoneNumberList.length;const z=l.partition(T,5e4);for(let u=0;u<z.length;u++){const p=z[u],h=Q.unparse(p),x=z.length===1?"":`_${u+1}`,n=`${l.campaignName}_客服_${v}_${C}_門號${x}_${p.length}.txt`;b.push({fileName:n,data:h})}}}const f=`${l.campaignName}_客服_${v}_${C}群_${y}人.zip`;l.downloadZip(f,b)};return(v,S)=>{const b=ue,y=E;return g(),G("div",ut,[e(y,{variant:"outline-primary",size:"sm",class:"mt-1",onClick:d,disabled:s.disabled},{default:t(()=>[e(b),ct]),_:1},8,["disabled"])])}}}),dt={class:"export-fb-device-id"},mt=w("span",null,"FB 自訂受眾",-1),pt=O({__name:"ExportFbAudience",props:{disabled:{type:Boolean}},setup(V){const s=V,l=Y(),d=async()=>{const v=new Set;l.smsGroupList.forEach(y=>{y.smsPhoneNumberFilted.forEach(C=>{const f=l.phoneNumberUserMap.get(C);f&&f.deviceId&&v.add(f.deviceId)})});const S=`madid
`+Array.from(v).join(`
`),b=new File([S],"fb-device-id.csv",{type:"text/csv"});await window.showSaveFilePicker({id:"market-fb-audience-export",suggestedName:`${l.campaignName}_FB 自訂受眾_${De().format("YYYYMMDD")}_${v.size}筆.csv`,types:[{accept:{"text/csv":[".csv"]}}]}).then(async y=>{const C=await y.createWritable();await C.write(b),await C.close()})};return(v,S)=>{const b=ue,y=E;return g(),G("div",dt,[e(y,{variant:"outline-primary",size:"sm",onClick:d,disabled:s.disabled},{default:t(()=>[e(b),mt]),_:1},8,["disabled"])])}}}),_t={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},ft=w("path",{fill:"currentColor",d:"M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 2v4h10V4zm0 6v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2z"},null,-1),vt=[ft];function ht(V,s){return g(),G("svg",_t,[...vt])}const xe={name:"mdi-calculator",render:ht},gt={key:0,class:"sms-send"},bt=w("h6",{class:"title"},"分群測試",-1),St={class:"section"},Lt=w("h6",{class:"title"},"簡訊內容",-1),$t={class:"sms-item section"},xt={class:"sms-header"},wt=["for"],Ct={class:"count"},It={class:"sms-footer"},yt=O({__name:"SmsSendModal",props:{smsGroup:{}},setup(V){const s=Ue(),l=Y(),d=V,v=F(!1),S=F(1),b=F(["","",""]),y=_=>{const L=d.smsGroup.smsPhoneNumberFilted;if(L.length===0)return[];const k=Math.ceil(L.length/S.value);return l.partition(L,k)[_]},C=()=>{S.value=Math.max(d.smsGroup.smsSendInfoList.length,1),console.log(`[SmsSendModal] smsTestGroupCount: ${S.value}`),b.value.length=0,d.smsGroup.smsSendInfoList.forEach(_=>{b.value.push(_.text)}),v.value=!0},f=()=>{if(!d.smsGroup)return;const _=b.value.splice(0,S.value);l.fillSmsSendInfo(d.smsGroup,_),s.setSmsText(d.smsGroup.name,_)},a=_=>_?_.length:0,i=_=>{const L=a(b.value[_]);return L===0?null:L<=70},m=(_,L)=>{if(L.phoneNumber){const k=l.sms(b.value[_],L.phoneNumber);console.log(`[SmsSend] URL: ${k}`),window.open(k,"_blank")}};return(_,L)=>{const k=E,T=Pe,z=Ae,u=Re,p=je,h=He,x=_e;return d.smsGroup?(g(),G("div",gt,[e(k,{variant:"outline-primary",size:"sm",onClick:C,disabled:d.smsGroup.smsPhoneNumberFilted.length===0},{default:t(()=>[w("span",null,"編輯 ("+$(d.smsGroup.smsSendInfoList.length)+")",1)]),_:1},8,["disabled"]),e(x,{modelValue:v.value,"onUpdate:modelValue":L[1]||(L[1]=n=>v.value=n),size:"lg","ok-title":"確定","cancel-title":"取消","cancel-variant":"outline-secondary",onOk:f,class:"sms-send-modal"},{default:t(()=>[w("section",null,[bt,w("div",St,[e(z,{modelValue:S.value,"onUpdate:modelValue":L[0]||(L[0]=n=>S.value=n),name:"sms-test-group"},{default:t(()=>[e(T,{value:1},{default:t(()=>[r("不測試")]),_:1}),e(T,{value:2},{default:t(()=>[r("2 群")]),_:1}),e(T,{value:3},{default:t(()=>[r("3 群")]),_:1}),e(T,{value:4},{default:t(()=>[r("4 群")]),_:1}),e(T,{value:5},{default:t(()=>[r("5 群")]),_:1}),e(T,{value:6},{default:t(()=>[r("6 群")]),_:1})]),_:1},8,["modelValue"])])]),w("section",null,[Lt,(g(!0),G(te,null,se(S.value,n=>(g(),G("div",$t,[w("div",xt,[w("label",{for:`sms-text-${n}`},"簡訊 "+$(n),9,wt),w("span",Ct,$(y(n-1).length)+" 人",1)]),e(u,{type:"text",size:"sm",id:`sms-text-${n}`,rows:"2",state:i(n-1),placeholder:"簡訊文案",modelValue:b.value[n-1],"onUpdate:modelValue":c=>b.value[n-1]=c},null,8,["id","state","modelValue","onUpdate:modelValue"]),w("div",It,[e(h,{right:"",variant:"outline-primary",size:"sm",text:"測試"},{default:t(()=>[(g(!0),G(te,null,se(D(l).userInfoListTest,c=>(g(),P(p,{onClick:o=>m(n-1,c),key:c.twmId},{default:t(()=>[r($(c.params.name),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024),w("span",{class:Ce(["sms-text",{warn:a(b.value[n-1])>70}])},$(a(b.value[n-1]))+" 個字 ",3)])]))),256))])]),_:1},8,["modelValue"])])):j("",!0)}}}),Nt={key:0,class:"ta-group-list-modal number"},kt={key:0,class:""},Gt={class:"summary"},oe=100,ke=O({__name:"TaGroupListModal",props:{twmIdList:{}},setup(V){const s=Y(),l=V,d=F(!1),v=F(1),S=()=>{d.value=!0},b=A(()=>{const i=[];if(!d.value)return i;const m=(v.value-1)*oe;return C.value.slice(m,m+oe)}),y=i=>oe*(v.value-1)+i+1,C=A(()=>{const i=[];return d.value&&(console.time("[TaGroupListModal] allUserList"),l.twmIdList.forEach(m=>{const _=s.twmIdUserMap.get(m);_&&i.push(_)}),console.timeEnd("[TaGroupListModal] allUserList")),i}),f=A(()=>d.value?C.value.filter(i=>!!i.phoneNumber).length:0),a=A(()=>d.value?C.value.filter(i=>!!i.couponCode).length:0);return(i,m)=>{const _=E,L=fe,k=ve,T=he,z=ge,u=be,p=Se,h=Oe,x=_e;return l.twmIdList?(g(),G("div",Nt,[l.twmIdList.length===0?(g(),G("span",kt,"0")):(g(),P(_,{key:1,variant:"link",onClick:S,class:""},{default:t(()=>[r($(l.twmIdList.length),1)]),_:1})),e(x,{modelValue:d.value,"onUpdate:modelValue":m[1]||(m[1]=n=>d.value=n),scrollable:"",size:"lg",title:"使用者詳情",class:"ta-list-modal"},{default:t(()=>[w("div",Gt,[r(" 總數："),w("span",null,$(l.twmIdList.length)+"，有門號："+$(f.value)+" (少 "+$(f.value-l.twmIdList.length)+")，有優惠券："+$(a.value)+" (少 "+$(a.value-l.twmIdList.length)+")",1)]),e(p,{hover:"",small:"",bordered:""},{default:t(()=>[e(T,null,{default:t(()=>[e(k,null,{default:t(()=>[e(L,{class:"text-center align-middle"},{default:t(()=>[r("No")]),_:1}),e(L,{class:"text-center align-middle"},{default:t(()=>[r("台灣大會員編號")]),_:1}),e(L,{class:"text-center align-middle"},{default:t(()=>[r("SubId")]),_:1}),e(L,{class:"text-center align-middle"},{default:t(()=>[r("門號")]),_:1}),e(L,{class:"text-center align-middle"},{default:t(()=>[r("資費")]),_:1}),e(L,{class:"text-center align-middle"},{default:t(()=>[r("優惠券序號")]),_:1})]),_:1})]),_:1}),e(u,null,{default:t(()=>[(g(!0),G(te,null,se(b.value,(n,c)=>(g(),P(k,{key:n.twmId},{default:t(()=>[e(z,{class:"text-center align-middle"},{default:t(()=>[r($(y(c)),1)]),_:2},1024),e(z,{class:"text-center align-middle number"},{default:t(()=>[r($(n.twmId),1)]),_:2},1024),e(z,{class:"text-center align-middle number"},{default:t(()=>[r($(n.subId),1)]),_:2},1024),e(z,{class:"text-center align-middle number"},{default:t(()=>[r($(n.phoneNumber),1)]),_:2},1024),e(z,{class:"text-center align-middle number"},{default:t(()=>[r($(n.params["目前方案專案V+D+V資費"]),1)]),_:2},1024),e(z,{class:"text-center align-middle number"},{default:t(()=>[r($(n.couponCode),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(h,{modelValue:v.value,"onUpdate:modelValue":m[0]||(m[0]=n=>v.value=n),size:"sm","total-rows":l.twmIdList.length,"per-page":oe},null,8,["modelValue","total-rows"])]),_:1},8,["modelValue"])])):j("",!0)}}}),Tt={class:"calc-button"},Bt={key:1,class:"number"},Ft=O({__name:"CalcButton",setup(V){const s=Y(),l=()=>{s.refresh()};return(d,v)=>{const S=xe,b=E,y=Le;return g(),G("div",Tt,[D(s).needReCalc?ae((g(),P(b,{key:0,variant:"outline-success",size:"sm",onClick:l},{default:t(()=>[e(S)]),_:1})),[[y,"重新計算"]]):(g(),G("div",Bt,[Ye(d.$slots,"default")]))])}}}),zt={class:"d-flex flex-column justify-content-end"},Mt=w("br",null,null,-1),Et=w("span",{class:"hint"},"(商務簡訊)",-1),Vt={class:"text-nowrap"},Dt={key:1},Ut={class:"text-nowrap"},Pt={class:"d-flex flex-column"},At=w("span",null,"SubId (DSC)",-1),Rt={class:"d-flex flex-column"},jt=w("span",null,"SubId (DSC)",-1),Ht=w("span",null,"名單總表",-1),ls=O({__name:"SmsGroupList",setup(V){const s=Y(),l=F(!0),d=F(0),v=()=>{if(!s.smsGroupList)return l.value=!1,0;console.time("[SmsGroupList] TotalSubIdCount");const u=new Set;for(let p=0;p<s.smsGroupList.length;p++){const x=s.smsGroupList[p].twmIdList;for(let n=0;n<x.length;n++){const c=x[n];u.add(c)}}console.timeEnd("[SmsGroupList] TotalSubIdCount"),l.value=!1,d.value=u.size},S=A(()=>{let u=0;return s.smsGroupList.forEach(p=>u+=p.smsTwmIdListFilted.length),u}),b=A(()=>{let u=0;return s.smsGroupList.forEach(p=>u+=p.smsPhoneNumberFilted.length),u}),y=A(()=>{let u=0;return s.smsGroupList.forEach(p=>u+=p.tamiDeviceIdCount),u}),C=(u,p)=>{const h=u.smsReadyTwmIdList;if(p>=100)u.smsTwmIdList=h.slice(0);else{const x=new Set;u.smsTwmIdList.forEach(o=>x.add(o));const n=h.length*p/100,c=a(h).slice(0,n);c.forEach(o=>x.add(o)),u.smsTwmIdList=Array.from(x),console.log(`[GroupList] addSmsList: ${n}: ${c.length}`)}s.refreshFilted()},f=u=>{for(let p=0;p<s.smsGroupList.length;p++){const h=s.smsGroupList[p];C(h,u)}},a=u=>{const p=u.slice(0);for(let h=p.length-1;h>0;h--){let x=Math.floor(Math.random()*(h+1));[p[h],p[x]]=[p[x],p[h]]}return p},i=u=>{const p=s.smsGroupList.findIndex(x=>x.name===u.name);p>=0&&s.smsGroupList.splice(p,1);const h=new Ie(u.name,u.twmIdList);s.groupList.push(h),s.refreshFilted(),l.value=!0},m=()=>{L(u=>u.twmIdList)},_=()=>{L(u=>u.smsTwmIdListFilted)},L=u=>{if(!s.smsGroupList)return;const p=[],h=new Set;for(let n=0;n<s.smsGroupList.length;n++){const c=s.smsGroupList[n],o=u(c);for(let I=0;I<o.length;I++){const N=o[I],B=s.twmIdUserMap.get(N);!B||!B.subId||B.phoneNumber&&B.phoneNumber.length>0||h.has(B.subId)||(h.add(B.subId),p.push({SUBSCR_ID:B.subId}))}}console.log(`[SmsGroupList] export ${p.length} subId`);const x=s.partition(p,2e5);for(let n=0;n<x.length;n++){const c=x[n],o=le(new Date,"yyyyMMdd"),I=`${s.campaignName}_DSC_SubId_${o}_${x.length}-${n+1}_${c.length}.csv`,N=Q.unparse(c);s.downloadFile(N,I)}},k=()=>{if(!s.smsGroupList)return;const u=[];for(let n=0;n<s.smsGroupList.length;n++){const c=s.smsGroupList[n],o=c.smsPhoneNumberFilted;for(let I=0;I<o.length;I++){const N=o[I],B=s.phoneNumberUserMap.get(N);B&&u.push({Sms:c.name,TwmId:B.twmId,SubId:B.subId,門號:B.phoneNumber,優惠券:B.couponCode})}}console.log(`[SmsGroupList] export ${u.length} All Sms CSV`);const p=le(new Date,"yyyyMMdd"),h=`${s.campaignName}_發送名單資訊_${p}_${u.length}.csv`,x=Q.unparse(u);s.downloadFile(x,h)},T=u=>u.smsReadyTwmIdList.length<=u.smsTwmIdList.length,z=()=>{for(let u=0;u<s.smsGroupList.length;u++){const p=s.smsGroupList[u];if(!T(p))return!1}return!0};return(u,p)=>{const h=fe,x=ve,n=he,c=Qe,o=ge,I=Ft,N=ke,B=yt,W=be,Z=xe,U=ue,R=pt,J=rt,ce=it,K=ye,q=Se,ee=Le;return g(),G("div",zt,[e(q,{hover:"",small:"",bordered:""},{default:t(()=>[e(n,{"head-variant":"dark"},{default:t(()=>[e(x,null,{default:t(()=>[e(h,{class:"text-center align-middle"},{default:t(()=>[r("刪除")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("分群")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("原數量")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("已發送數")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("可發送數")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("發送")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("欲發送數")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("發送數")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("門號數"),Mt,Et]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("Device ID 數")]),_:1}),e(h,{class:"text-center align-middle"},{default:t(()=>[r("簡訊內容")]),_:1})]),_:1})]),_:1}),e(W,null,{default:t(()=>[(g(!0),G(te,null,se(D(s).smsGroupList,M=>(g(),P(x,{key:M.name},{default:t(()=>[e(o,{class:"text-center align-middle"},{default:t(()=>[e(D(E),{variant:"outline-danger",size:"sm",onClick:H=>i(M)},{default:t(()=>[e(c)]),_:2},1032,["onClick"])]),_:2},1024),e(h,{class:"align-middle"},{default:t(()=>[r($(M.name),1)]),_:2},1024),e(o,{class:"text-end align-middle number"},{default:t(()=>{var H;return[r($((H=M.twmIdList)==null?void 0:H.length),1)]}),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[r($(M.sentCount),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[e(N,{"twm-id-list":M.smsReadyTwmIdList},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[w("div",Vt,[e(D(E),{variant:"outline-primary",size:"sm",onClick:H=>C(M,10),disabled:T(M)},{default:t(()=>[r("+10%")]),_:2},1032,["onClick","disabled"]),e(D(E),{variant:"outline-primary",size:"sm",onClick:H=>C(M,100),class:"ms-1",disabled:T(M)},{default:t(()=>[r("All")]),_:2},1032,["onClick","disabled"])])]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(N,{"twm-id-list":M.smsTwmIdList},null,8,["twm-id-list"])]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[e(N,{"twm-id-list":M.smsTwmIdListFilted},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[r($(M.smsPhoneNumberFilted.length),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(I,null,{default:t(()=>[r($(M.tamiDeviceIdCount),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(B,{"sms-group":M},null,8,["sms-group"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(K,null,{default:t(()=>[e(x,null,{default:t(()=>[e(o),e(o,null,{default:t(()=>[r("共 "+$(D(s).smsGroupList.length)+" 群",1)]),_:1}),e(o,{class:Ce({"text-center":l.value,number:!l.value})},{default:t(()=>[l.value?ae((g(),P(D(E),{key:0,variant:"outline-success",size:"sm",onClick:v},{default:t(()=>[e(Z)]),_:1})),[[ee,"重新計算"]]):(g(),G("span",Dt,$(d.value),1))]),_:1},8,["class"]),e(o),e(o),e(o,null,{default:t(()=>[w("div",Ut,[e(D(E),{variant:"outline-primary",size:"sm",onClick:p[0]||(p[0]=M=>f(10)),disabled:z()},{default:t(()=>[r("+10%")]),_:1},8,["disabled"]),e(D(E),{variant:"outline-primary",size:"sm",onClick:p[1]||(p[1]=M=>f(100)),class:"ms-1",disabled:z()},{default:t(()=>[r("All")]),_:1},8,["disabled"])])]),_:1}),e(o),e(o,{class:"text-center number"},{default:t(()=>[e(I,null,{default:t(()=>[r($(S.value),1)]),_:1})]),_:1}),e(o,{class:"text-center number"},{default:t(()=>[e(I,null,{default:t(()=>[r($(b.value),1)]),_:1})]),_:1}),e(o,{class:"text-center number"},{default:t(()=>[e(I,null,{default:t(()=>[r($(y.value),1)]),_:1})]),_:1}),e(o)]),_:1}),e(x,null,{default:t(()=>[e(o),e(o),e(o,{class:"text-center"},{default:t(()=>[w("div",Pt,[e(D(E),{variant:"outline-primary",size:"sm",onClick:m},{default:t(()=>[e(U),At]),_:1})])]),_:1}),e(o),e(o),e(o),e(o),e(o,{class:"text-center"},{default:t(()=>[w("div",Rt,[ae((g(),P(D(E),{variant:"outline-primary",size:"sm",onClick:_,disabled:S.value<=0},{default:t(()=>[e(U),jt]),_:1},8,["disabled"])),[[ee,`匯出 ${S.value-b.value} 筆沒有電話號碼的 SubID (DSC 用)`,void 0,{hover:!0,top:!0}]])])]),_:1}),e(o,{class:"text-center align-middle"}),e(o,null,{default:t(()=>[e(R,{disabled:y.value===0},null,8,["disabled"])]),_:1}),e(o,{class:"text-center align-middle"},{default:t(()=>[e(J,{disabled:b.value<=0},null,8,["disabled"]),e(ce,{class:"mt-1",disabled:b.value<=0},null,8,["disabled"])]),_:1})]),_:1}),e(x,null,{default:t(()=>[e(o),e(o),e(o),e(o),e(o),e(o),e(o),e(o,{colspan:"2",class:"text-center align-middle"},{default:t(()=>[e(D(E),{variant:"outline-primary",size:"sm",class:"mt-1",onClick:k,disabled:S.value<=0},{default:t(()=>[e(U),Ht]),_:1},8,["disabled"])]),_:1}),e(o),e(o)]),_:1})]),_:1})]),_:1})])}}}),Ot={key:1,class:"number"},as=O({__name:"TaGroupList",setup(V){const s=Y(),l=F(!0),d=F(0),v=A(()=>s.groupList?s.groupList.sort((f,a)=>f.name.localeCompare(a.name)):[]),S=()=>{if(!s.groupList)return l.value=!1,0;console.time("[TaGroupList] TotalSubIdCount");const f=new Set;for(let a=0;a<s.groupList.length;a++){const m=s.groupList[a].twmIdList;for(let _=0;_<m.length;_++){const L=m[_];f.add(L)}}console.timeEnd("[TaGroupList] TotalSubIdCount"),d.value=f.size,l.value=!1},b=f=>{const a=s.groupList.findIndex(m=>m.name===f.name);a>=0&&s.groupList.splice(a,1),console.time("[TaGroupList] addSmsList");const i=new We(f.name,f.twmIdList);console.timeEnd("[TaGroupList] addSmsList"),s.smsGroupList.push(i),s.refreshFilted()},y=()=>{[...s.groupList].forEach(a=>b(a))},C=async()=>{const[f]=await window.showOpenFilePicker({multiple:!1,types:[{accept:{"text/csv":[".csv"]}}]}),a=await f.getFile(),i=await a.text();Q.parse(i,{header:!1,skipEmptyLines:!0,complete:m=>{if(m.errors.length>0){alert("Parse Error");return}console.log(`[TaGroupList] add ${m.data.length} Users begin`);const _=[];for(let k=0;k<m.data.length;k++){const T=m.data[k],z=s.phoneNumberUserMap.get(T[2]);z&&_.push(z.twmId)}console.log(`[TaGroupList] add ${m.data.length} Users Complete`);const L=new Ie(a.name,_);s.groupList.push(L),console.log(`[TaGroupList] complete ${s.groupList.length} TaGroup`)}})};return(f,a)=>{const i=fe,m=ve,_=he,L=ke,k=ge,T=E,z=be,u=xe,p=ye,h=Se,x=Le;return g(),G("div",null,[e(h,{hover:"",small:"",bordered:""},{default:t(()=>[e(_,{"head-variant":"dark"},{default:t(()=>[e(m,null,{default:t(()=>[e(i,{class:"text-center align-middle"},{default:t(()=>[r("分群")]),_:1}),e(i,{class:"text-center align-middle"},{default:t(()=>[r("數量")]),_:1}),e(i,{class:"text-center align-middle"},{default:t(()=>[r("加入發送")]),_:1})]),_:1})]),_:1}),e(z,null,{default:t(()=>[(g(!0),G(te,null,se(v.value,n=>(g(),P(m,{key:n.name},{default:t(()=>[e(i,{class:"align-middle"},{default:t(()=>[r($(n.name),1)]),_:2},1024),e(k,{class:"text-center align-middle"},{default:t(()=>[e(L,{"twm-id-list":n.twmIdList},null,8,["twm-id-list"])]),_:2},1024),e(i,{class:"text-center"},{default:t(()=>[e(T,{variant:"outline-primary",size:"sm",onClick:c=>b(n)},{default:t(()=>[r("加入")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(p,null,{default:t(()=>[e(m,null,{default:t(()=>[e(k,null,{default:t(()=>[r("共 "+$(v.value.length)+" 群",1)]),_:1}),e(k,{class:"text-center"},{default:t(()=>[l.value?ae((g(),P(T,{key:0,variant:"outline-success",size:"sm",onClick:S},{default:t(()=>[e(u)]),_:1})),[[x,"重新計算"]]):(g(),G("span",Ot,$(d.value),1))]),_:1}),e(k,{class:"text-center"},{default:t(()=>[e(T,{variant:"outline-primary",size:"sm",onClick:a[0]||(a[0]=n=>y())},{default:t(()=>[r("加入")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(T,{variant:"outline-primary",size:"sm",onClick:C},{default:t(()=>[r("匯入 91App 受眾")]),_:1})])}}}),Yt={class:"sms-file-wrapper"},Wt=w("label",{for:"sms-file"},"已發送簡訊 (多選)",-1),Zt={class:"d-flex mt-2 align-items-center w-100"},qt={key:0,class:"hint"},is=O({__name:"ImportSmsSent",setup(V){const s=Y(),l=F(0),d=F(0),v=F(0);ie(l,(f,a)=>{f===0&&a>0&&s.refreshFilted()});const S=A(()=>l.value>0),b=async()=>{const f=await window.showOpenFilePicker({id:"market-sms-sent-"+s.hashCode(s.campaignName),multiple:!0,types:[{accept:{"text/plain":[".txt"]}}]});l.value=f.length,f.forEach(async a=>{const m=await(await a.getFile()).text();y(m)})},y=f=>{const a=f==null?void 0:f.split(`
`),i=s.phoneNumberSentSet.size;v.value+=a.length,a.forEach(_=>{const k=_.split("	")[0];s.phoneNumberSentSet.add(k)});const m=s.phoneNumberSentSet.size;console.log(`[SmsFile] load ${m-i} Sent Phone Numbers, Total: ${s.phoneNumberSentSet.size}`),l.value--,d.value++},C=()=>{d.value=0,v.value=0,s.phoneNumberSentSet.clear(),s.refreshFilted()};return(f,a)=>{const i=E,m=$e,_=pe;return g(),G("div",Yt,[Wt,w("div",Zt,[e(i,{variant:"outline-primary",size:"sm",onClick:b},{default:t(()=>[r("匯入")]),_:1}),v.value>0&&!S.value?(g(),P(i,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:C},{default:t(()=>[e(m)]),_:1})):j("",!0),S.value?(g(),P(_,{key:1,variant:"primary",class:"ms-1"})):j("",!0)]),d.value>0?(g(),G("small",qt,$(d.value)+" 檔案, "+$(v.value)+" 筆記錄, 重複 "+$(v.value-D(s).phoneNumberSentSet.size)+" 門號, "+$(D(s).phoneNumberSentSet.size)+" 門號",1)):j("",!0)])}}}),Jt={class:"import-dsc-wrapper"},Qt=w("label",{for:"dsc-file"},"門號 (DSC 轉出 csv)",-1),Kt={class:"d-flex mt-2 align-items-center w-100"},Xt={key:0,class:"hint"},us=O({__name:"ImportDSC",setup(V){const s=Y(),l=F(0),d=F(0),v=F(0);Ne(async()=>{}),ie(l,(a,i)=>{a===0&&i>0&&s.refreshFilted()});const S=A(()=>l.value>0),b=async()=>{const a=await window.showOpenFilePicker({id:"market-dsc",multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]});l.value=a.length,a.forEach(async i=>{const _=await(await i.getFile()).arrayBuffer(),L=Ze.decode(qe.Buffer.from(_),"big5");y(L)})},y=a=>{Q.parse(a,{header:!0,skipEmptyLines:!0,transformHeader:(i,m)=>(console.log(`Header: ${m}`,i),i==="門號"?"phoneNumber":i==="SUBSCR_ID"?"subId":i),complete:i=>{if(i.errors.length>0){alert("Parse Error"),l.value--,d.value++;return}const m=i.data;C(m),l.value--,d.value++}})},C=a=>{v.value+=a.length,a.forEach(i=>{const m=s.subIdUserMap.get(i.subId);m&&(m.phoneNumber=i.phoneNumber,s.phoneNumberUserMap.set(i.phoneNumber,m))}),console.log(`[PhoneNumberFile] read ${a.length} subid <> phone number`)},f=()=>{d.value=0,v.value=0,s.phoneNumberUserMap.clear(),s.refreshFilted()};return(a,i)=>{const m=E,_=$e,L=pe;return g(),G("div",Jt,[Qt,w("div",Kt,[e(m,{variant:"outline-primary",size:"sm",onClick:b,disabled:D(s).isUserEmpty},{default:t(()=>[r("匯入")]),_:1},8,["disabled"]),v.value>0&&!S.value?(g(),P(m,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:f},{default:t(()=>[e(_)]),_:1})):j("",!0),S.value?(g(),P(L,{key:1,variant:"primary",class:"ms-1"})):j("",!0)]),d.value?(g(),G("small",Xt,"已讀取 "+$(d.value)+" 檔案, "+$(v.value)+" 筆記錄",1)):j("",!0)])}}}),es={class:"title-wrapper"},ts=w("label",{for:"compaign-name"},"活動名稱",-1),cs=O({__name:"CampaignName",setup(V){const s=Y(),l=F("");return Ne(()=>{const d=localStorage.getItem("campaign-name");d&&(l.value=d)}),ie(l,d=>{localStorage.setItem("campaign-name",d),s.campaignName=d}),(d,v)=>{const S=Je;return g(),G("div",es,[ts,e(S,{modelValue:l.value,"onUpdate:modelValue":v[0]||(v[0]=b=>l.value=b),type:"text",id:"compaign-name",class:"ms-2"},null,8,["modelValue"])])}}});export{$e as _,cs as a,us as b,is as c,as as d,ls as e};
