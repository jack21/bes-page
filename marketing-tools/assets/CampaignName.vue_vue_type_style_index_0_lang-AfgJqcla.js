import{o as f,a as k,b as $,d as Z,u as W,r as N,c as A,w as ce,P as ie,e,f as t,i as D,j as H,g as l,t as S,q as De,s as Ne,v as ke,S as Ue,x as Pe,k as P,y as Ae,p as Re,l as pe,H as _e,m as je,F as se,h as j,z as ne,A as Te,C as He,E as Oe,B as Ye,Q as Ze,D as We,G as fe,I as ve,O as he,J as ge,K as be,L as Se,M as qe,N as ue,R as Je,U as Le,T as Qe,V as Ge,W as Ke,n as Be,X as Xe,Y as et,Z as tt}from"./index-vj19Cfrc.js";import{_ as Ce}from"./download-J8OWICbF.js";import{_ as st}from"./delete-outline-hLx0hhZc.js";const nt={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},ot=$("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"},null,-1),lt=[ot];function at(U,s){return f(),k("svg",nt,[...lt])}const xe={name:"mdi-close",render:at},it={class:"export-sms-file"},ut=$("span",null,"門號 (商務簡訊)",-1),ct={key:0,class:"ms-4 mt-2"},rt={class:"d-flex mt-2 align-items-center w-100"},dt={key:0,class:"hint"},mt={class:"d-flex justify-content-between w-100"},pt={class:"d-flex align-items-center"},_t={class:"d-flex align-items-center"},ft=Z({__name:"ExportSmsFile",props:{disabled:{type:Boolean}},setup(U){const s=U,n=W(),i=N(!1),g=N([]),C=N([]),h=N(0),T=N(0),x=N(new Set),m=N([]),v=N(0),u=N(!1),c=A(()=>({text:`匯入 91 優惠券 (${p.value} 人缺優惠券)`,value:"upload-file"})),r=A(()=>{const G=Array.from(n.userArgSet).map(_=>({text:_,value:_}));return G.push(c.value),G}),b=A(()=>g.value.findIndex(G=>G===c.value.value)>=0);ce(C,()=>{h.value=C.value.length,C.value.forEach(G=>F(G))});const F=G=>{u.value=!0,ie.parse(G,{header:!0,skipEmptyLines:!0,encoding:"big5",transformHeader:(_,V)=>(console.log(`Header: ${V}`,_),_==="領取券號"?"couponCode":_==="是否領取"?"isRedeem":_),complete:_=>{if(_.errors.length>0){alert("Parse Error"),u.value=!1;return}const V=m.value.length;_.data.forEach(B=>{if(B.isRedeem.indexOf("否")===-1){console.log(`[ExportSmsFile] Coupon Code redeem: ${B.couponCode} -> ${B.isRedeem}`);return}if(x.value.has(B.couponCode)){console.log(`[ExportSmsFile] Coupon Code duplicated: ${B.couponCode}`);return}x.value.add(B.couponCode),m.value.push(B.couponCode)});const M=m.value.length;console.log(`[ExportSmsFile] read ${_.data.length} -> ${M-V} coupon Code`),h.value--,T.value++,u.value=!1}})},a=A(()=>h.value>0),d=()=>{p.value=w(),i.value=!0},p=N(0),w=()=>{let G=0;return console.log(`[ExportSmsFile] noCouponCodeCount, smsGroupList: ${n.smsGroupList.length}`),n.smsGroupList.forEach(_=>{console.log(`[ExportSmsFile] noCouponCodeCount, smsSendInfoList: ${_.smsSendInfoList.length}`),_.smsSendInfoList.forEach(V=>{console.log(`[ExportSmsFile] noCouponCodeCount, phoneNumberList: ${V.phoneNumberList.length}`),V.phoneNumberList.forEach(M=>{const B=n.phoneNumberUserMap.get(M);(!B||!B.couponCode)&&G++})})}),G},z=async()=>{if(!I.value)return;u.value=!0;const G="export-sms-file-"+n.hashCode(n.campaignName);n.saveZip(I.value.fileName,I.value.downloadFileList,G),u.value=!1,i.value=!1},I=N(),o=()=>{u.value=!0,I.value=L(),u.value=!1},L=()=>{v.value=0;const G=[],_=Ne(new Date,"yyyyMMdd");let V=0,M=0;const B=n.smsGroupList,O=[],Y=[],y=[];for(let oe=0;oe<B.length;oe++){const X=B[oe];let we=0;const Ie=[];console.log(`[ExportSmsFile] smsGroup: ${X.name}: ${X.smsSendInfoList.length}`);for(let te=0;te<X.smsSendInfoList.length;te++){const re=X.smsSendInfoList[te];V++;const ee=K(re);M+=ee.length,we+=ee.length,console.log(`[ExportSmsFile] smsGroup: ${X.name}: [${te+1}] ${ee.length}`),y.push(ee.length);const de=n.partition(ee,5e3);for(let le=0;le<de.length;le++){const me=de[le],Me=ie.unparse(me,{delimiter:"	"}),Ee=X.smsSendInfoList.length===1?"":`_${te+1}`,Ve=de.length===1?"":`_${le+1}`,ye=`${n.campaignName}_商務簡訊_${_}_${oe+1}${Ee}${Ve}_${X.name}_${me.length}.txt`;G.push({fileName:ye,data:Me}),O.push({smsText:re.text,phoneNumberFileName:ye,smsCount:me.length})}Ie.push({smsText:re.text,smsCount:ee.length})}Y.push({taName:X.name,smsCount:we,smsItemList:Ie})}const E={};E.sendDate=ke().format("YYYY-MM-DD"),E.sendHour=Ue.Hour20,E.sendMinute=Pe.Minute00,E.smsList=O,E.smsGroupList=Y;const J=`${n.campaignName}_商務簡訊_${_}_${B.length}受眾_${V}群_${M}.cfg`,Q=JSON.stringify(E,null,4);G.push({fileName:J,data:Q});const ze=`${n.campaignName}_商務簡訊_${_}_${B.length}受眾_${V}群_${M}.zip`;return console.log(`受眾表用
${y.join(`
`)}`),{fileName:ze,downloadFileList:G}},R=new Set(["0979940180","0937654385","0937573896","0970646973","0980317712","0970008039","0905364116","0920693530","0920020856","0971068968"]),K=G=>{const _=[],V=G.phoneNumberList;for(let M=0;M<V.length;M++){const B=V[M];if(R.has(B))continue;const O=n.phoneNumberUserMap.get(B);if(!O)continue;const Y=[B];for(let y=0;y<r.value.length;y++){const E=r.value[y];if(g.value.findIndex(Q=>Q===E.value)>=0)if(E.value===c.value.value){let Q=O.couponCode;Q||(Q=m.value[v.value++]),Q?(O.couponCode=Q,Y.push(Q)):Y.push("")}else O.params&&Y.push(O.params[E.value])}_.push(Y)}return _},q=()=>{C.value=[],T.value=0,m.value.length=0,x.value.clear()};return(G,_)=>{const V=Ce,M=P,B=Ae,O=Re,Y=xe,y=pe,E=_e;return f(),k("div",it,[e(M,{variant:"outline-primary",size:"sm",onClick:d,disabled:s.disabled},{default:t(()=>[e(V),ut]),_:1},8,["disabled"]),e(E,{modelValue:i.value,"onUpdate:modelValue":_[2]||(_[2]=J=>i.value=J),title:"參數",class:"args-modal",onClose:_[3]||(_[3]=J=>i.value=!1),onHide:_[4]||(_[4]=De(()=>{},["prevent"]))},{footer:t(()=>[$("div",mt,[$("div",pt,[u.value?(f(),D(y,{key:0})):H("",!0)]),$("div",_t,[e(M,{variant:"primary",size:"sm",onClick:o,disabled:u.value},{default:t(()=>[l("打包")]),_:1},8,["disabled"]),e(M,{variant:"primary",size:"sm",onClick:z,disabled:u.value||!I.value,class:"ml-2"},{default:t(()=>[l("匯出")]),_:1},8,["disabled"])])])]),default:t(()=>[e(B,{modelValue:g.value,"onUpdate:modelValue":_[0]||(_[0]=J=>g.value=J),options:r.value,stacked:""},null,8,["modelValue","options"]),b.value?(f(),k("div",ct,[$("div",rt,[e(O,{modelValue:C.value,"onUpdate:modelValue":_[1]||(_[1]=J=>C.value=J),id:"dsc-file",accept:"text/csv",multiple:""},null,8,["modelValue"]),x.value.size>0&&!a.value?(f(),D(M,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:q},{default:t(()=>[e(Y)]),_:1})):H("",!0),a.value?(f(),D(y,{key:1,variant:"primary",class:"ms-1"})):H("",!0)]),T.value?(f(),k("small",dt,"已讀取 "+S(T.value)+" 檔案, "+S(x.value.size)+" 筆記錄",1)):H("",!0)])):H("",!0)]),_:1},8,["modelValue"])])}}}),vt={class:"export-fb-device-id"},ht=$("span",null,"FB 自訂受眾",-1),gt=Z({__name:"ExportFbAudience",props:{disabled:{type:Boolean}},setup(U){const s=U,n=W(),i=async()=>{const g=new Set;n.smsGroupList.forEach(T=>{T.smsPhoneNumberFilted.forEach(x=>{const m=n.phoneNumberUserMap.get(x);m&&m.deviceId&&g.add(m.deviceId)})});const C=`madid
`+Array.from(g).join(`
`),h=new File([C],"fb-device-id.csv",{type:"text/csv"});await window.showSaveFilePicker({id:"market-fb-audience-export",suggestedName:`${n.campaignName}_FB 自訂受眾_${ke().format("YYYYMMDD")}_${g.size}筆.csv`,types:[{accept:{"text/csv":[".csv"]}}]}).then(async T=>{const x=await T.createWritable();await x.write(h),await x.close()})};return(g,C)=>{const h=Ce,T=P;return f(),k("div",vt,[e(T,{variant:"outline-primary",size:"sm",onClick:i,disabled:s.disabled},{default:t(()=>[e(h),ht]),_:1},8,["disabled"])])}}}),bt={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},St=$("path",{fill:"currentColor",d:"M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 2v4h10V4zm0 6v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2z"},null,-1),Lt=[St];function Ct(U,s){return f(),k("svg",bt,[...Lt])}const $e={name:"mdi-calculator",render:Ct},xt={key:0,class:"sms-send"},$t=$("h6",{class:"title"},"分群測試",-1),wt={class:"section"},It=$("h6",{class:"title"},"簡訊內容",-1),yt={class:"sms-item section"},Nt={class:"sms-header"},kt=["for"],Tt={class:"count"},Gt={class:"sms-footer"},Bt=Z({__name:"SmsSendModal",props:{smsGroup:{}},setup(U){const s=je(),n=W(),i=U,g=N(!1),C=N(1),h=N(["","",""]),T=r=>{const b=i.smsGroup.smsPhoneNumberFilted;if(b.length===0)return[];const F=Math.ceil(b.length/C.value);return n.partition(b,F)[r]},x=()=>{C.value=Math.max(i.smsGroup.smsSendInfoList.length,1),console.log(`[SmsSendModal] smsTestGroupCount: ${C.value}`),h.value.length=0,i.smsGroup.smsSendInfoList.forEach(r=>{h.value.push(r.text)}),g.value=!0},m=()=>{if(!i.smsGroup)return;const r=h.value.splice(0,C.value);n.fillSmsSendInfo(i.smsGroup,r),s.setSmsText(i.smsGroup.name,r)},v=r=>r?r.length:0,u=r=>{const b=v(h.value[r]);return b===0?null:b<=70},c=async(r,b)=>{b.phoneNumber&&await n.sms(b.phoneNumber,h.value[r])};return(r,b)=>{const F=P,a=He,d=Oe,p=Ye,w=Ze,z=We,I=_e;return i.smsGroup?(f(),k("div",xt,[e(F,{variant:"outline-primary",size:"sm",onClick:x,disabled:i.smsGroup.smsPhoneNumberFilted.length===0},{default:t(()=>[$("span",null,"編輯 ("+S(i.smsGroup.smsSendInfoList.length)+")",1)]),_:1},8,["disabled"]),e(I,{modelValue:g.value,"onUpdate:modelValue":b[1]||(b[1]=o=>g.value=o),size:"lg","ok-title":"確定","cancel-title":"取消","cancel-variant":"outline-secondary",onOk:m,class:"sms-send-modal"},{default:t(()=>[$("section",null,[$t,$("div",wt,[e(d,{modelValue:C.value,"onUpdate:modelValue":b[0]||(b[0]=o=>C.value=o),name:"sms-test-group"},{default:t(()=>[e(a,{value:1},{default:t(()=>[l("不測試")]),_:1}),e(a,{value:2},{default:t(()=>[l("2 群")]),_:1}),e(a,{value:3},{default:t(()=>[l("3 群")]),_:1}),e(a,{value:4},{default:t(()=>[l("4 群")]),_:1}),e(a,{value:5},{default:t(()=>[l("5 群")]),_:1}),e(a,{value:6},{default:t(()=>[l("6 群")]),_:1})]),_:1},8,["modelValue"])])]),$("section",null,[It,(f(!0),k(se,null,ne(C.value,o=>(f(),k("div",yt,[$("div",Nt,[$("label",{for:`sms-text-${o}`},"簡訊 "+S(o),9,kt),$("span",Tt,S(T(o-1).length)+" 人",1)]),e(p,{type:"text",size:"sm",id:`sms-text-${o}`,rows:"2",state:u(o-1),placeholder:"簡訊文案",modelValue:h.value[o-1],"onUpdate:modelValue":L=>h.value[o-1]=L},null,8,["id","state","modelValue","onUpdate:modelValue"]),$("div",Gt,[e(z,{right:"",variant:"outline-primary",size:"sm",text:"測試"},{default:t(()=>[(f(!0),k(se,null,ne(j(n).userInfoListTest,L=>(f(),D(w,{onClick:R=>c(o-1,L),key:L.twmId},{default:t(()=>[l(S(L.params.name),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024),$("span",{class:Te(["sms-text",{warn:v(h.value[o-1])>70}])},S(v(h.value[o-1]))+" 個字 ",3)])]))),256))])]),_:1},8,["modelValue"])])):H("",!0)}}}),Ft={key:0,class:"ta-group-list-modal number"},zt={key:0,class:""},Mt={class:"summary"},ae=100,Fe=Z({__name:"TaGroupListModal",props:{twmIdList:{},phoneNumberList:{}},setup(U){const s=W(),n=U,i=N(!1),g=N(1),C=()=>{i.value=!0},h=A(()=>{var c,r;return((c=n.twmIdList)==null?void 0:c.length)||((r=n.phoneNumberList)==null?void 0:r.length)||0}),T=A(()=>{const c=[];if(!i.value)return c;const r=(g.value-1)*ae;return m.value.slice(r,r+ae)}),x=c=>ae*(g.value-1)+c+1,m=A(()=>{const c=[];return i.value&&(console.time("[TaGroupListModal] allUserList"),n.twmIdList&&n.twmIdList.length>0?n.twmIdList.forEach(r=>{const b=s.twmIdUserMap.get(r);b&&c.push(b)}):n.phoneNumberList&&n.phoneNumberList.length>0&&n.phoneNumberList.forEach(r=>{const b=s.phoneNumberUserMap.get(r);b&&c.push(b)}),console.timeEnd("[TaGroupListModal] allUserList")),c}),v=A(()=>i.value?m.value.filter(c=>!!c.phoneNumber).length:0),u=A(()=>i.value?m.value.filter(c=>!!c.couponCode).length:0);return(c,r)=>{const b=P,F=fe,a=ve,d=he,p=ge,w=be,z=Se,I=qe,o=_e;return n.twmIdList||n.phoneNumberList?(f(),k("div",Ft,[h.value===0?(f(),k("span",zt,"0")):(f(),D(b,{key:1,variant:"link",onClick:C,class:""},{default:t(()=>[l(S(h.value),1)]),_:1})),e(o,{modelValue:i.value,"onUpdate:modelValue":r[1]||(r[1]=L=>i.value=L),scrollable:"",size:"lg",title:"使用者詳情",class:"ta-list-modal"},{default:t(()=>[$("div",Mt,[l(" 總數："),$("span",null,S(h.value)+"，有門號："+S(v.value)+" (少 "+S(v.value-h.value)+")，有優惠券："+S(u.value)+" (少 "+S(u.value-h.value)+")",1)]),e(z,{hover:"",small:"",bordered:""},{default:t(()=>[e(d,null,{default:t(()=>[e(a,null,{default:t(()=>[e(F,{class:"text-center align-middle"},{default:t(()=>[l("No")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("台灣大會員編號")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("SubId")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("門號")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("資費")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("優惠券序號")]),_:1})]),_:1})]),_:1}),e(w,null,{default:t(()=>[(f(!0),k(se,null,ne(T.value,(L,R)=>(f(),D(a,{key:L.twmId},{default:t(()=>[e(p,{class:"text-center align-middle"},{default:t(()=>[l(S(x(R)),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(S(L.twmId),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(S(L.subId),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(S(L.phoneNumber),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(S(L.params["目前方案專案V+D+V資費"]),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(S(L.couponCode),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(I,{modelValue:g.value,"onUpdate:modelValue":r[0]||(r[0]=L=>g.value=L),size:"sm","total-rows":h.value,"per-page":ae},null,8,["modelValue","total-rows"])]),_:1},8,["modelValue"])])):H("",!0)}}}),Et={class:"calc-button"},Vt={key:1,class:"number"},Dt=Z({__name:"CalcButton",setup(U){const s=W(),n=()=>{s.refresh()};return(i,g)=>{const C=$e,h=P,T=Le;return f(),k("div",Et,[j(s).needReCalc?ue((f(),D(h,{key:0,variant:"outline-success",size:"sm",onClick:n},{default:t(()=>[e(C)]),_:1})),[[T,"重新計算"]]):(f(),k("div",Vt,[Je(i.$slots,"default")]))])}}}),Ut={class:"d-flex flex-column justify-content-end"},Pt=$("br",null,null,-1),At=$("span",{class:"hint"},"(商務簡訊)",-1),Rt={class:"text-nowrap"},jt={key:1},Ht={class:"text-nowrap"},Ot=$("div",{class:"d-flex flex-column"},null,-1),Yt={class:"d-flex flex-column"},Zt=$("span",null,"SubId (DSC)",-1),us=Z({__name:"SmsGroupList",setup(U){const s=W(),n=N(!0),i=N(0),g=()=>{if(!s.smsGroupList)return n.value=!1,0;console.time("[SmsGroupList] TotalSubIdCount");const a=new Set;for(let d=0;d<s.smsGroupList.length;d++){const w=s.smsGroupList[d].twmIdList;for(let z=0;z<w.length;z++){const I=w[z];a.add(I)}}console.timeEnd("[SmsGroupList] TotalSubIdCount"),n.value=!1,i.value=a.size},C=A(()=>{let a=0;return s.smsGroupList.forEach(d=>a+=d.smsTwmIdListFilted.length),a}),h=A(()=>{let a=0;return s.smsGroupList.forEach(d=>a+=d.smsPhoneNumberFilted.length),a}),T=A(()=>{let a=0;return s.smsGroupList.forEach(d=>a+=d.tamiDeviceIdCount),a}),x=(a,d)=>{const p=a.smsReadyTwmIdList;if(d>=100)a.smsTwmIdList=p.slice(0);else{const w=new Set;a.smsTwmIdList.forEach(o=>w.add(o));const z=p.length*d/100,I=v(p).slice(0,z);I.forEach(o=>w.add(o)),a.smsTwmIdList=Array.from(w),console.log(`[GroupList] addSmsList: ${z}: ${I.length}`)}s.refreshFilted()},m=a=>{for(let d=0;d<s.smsGroupList.length;d++){const p=s.smsGroupList[d];x(p,a)}},v=a=>{const d=a.slice(0);for(let p=d.length-1;p>0;p--){let w=Math.floor(Math.random()*(p+1));[d[p],d[w]]=[d[w],d[p]]}return d},u=a=>{const d=s.smsGroupList.findIndex(w=>w.name===a.name);d>=0&&s.smsGroupList.splice(d,1);const p=new Qe(a.name,a.twmIdList);s.groupList.push(p),s.refreshFilted(),n.value=!0},c=()=>{r(a=>a.smsTwmIdListFilted)},r=a=>{if(!s.smsGroupList)return;const d=[],p=new Set;for(let L=0;L<s.smsGroupList.length;L++){const R=s.smsGroupList[L],K=a(R);for(let q=0;q<K.length;q++){const G=K[q],_=s.twmIdUserMap.get(G);!_||!_.subId||_.phoneNumber&&_.phoneNumber.length>0||p.has(_.subId)||(p.add(_.subId),d.push({SUBSCR_ID:_.subId}))}}console.log(`[SmsGroupList] export ${d.length} subId`);const w=Ne(new Date,"yyyyMMdd"),z=[],I=s.partition(d,1e5);for(let L=0;L<I.length;L++){const R=I[L],K=`${s.campaignName}_DSC_SubId_${w}_${I.length}-${L+1}_${R.length}.csv`,q=ie.unparse(R);z.push({fileName:K,data:q})}const o=`${s.campaignName}_DSC_SubId_${w}_${I.length}份_共${d.length}筆.zip`;s.downloadZip(o,z)},b=a=>a.smsReadyTwmIdList.length<=a.smsTwmIdList.length,F=()=>{for(let a=0;a<s.smsGroupList.length;a++){const d=s.smsGroupList[a];if(!b(d))return!1}return!0};return(a,d)=>{const p=fe,w=ve,z=he,I=st,o=ge,L=Dt,R=Fe,K=Bt,q=be,G=$e,_=Ce,V=gt,M=ft,B=Ge,O=Se,Y=Le;return f(),k("div",Ut,[e(O,{hover:"",small:"",bordered:""},{default:t(()=>[e(z,{"head-variant":"dark"},{default:t(()=>[e(w,null,{default:t(()=>[e(p,{class:"text-center align-middle"},{default:t(()=>[l("刪除")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("分群")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("原數量")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("已發送數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("可發送數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("發送")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("欲發送數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("發送數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("門號數"),Pt,At]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("Device ID 數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("簡訊內容")]),_:1})]),_:1})]),_:1}),e(q,null,{default:t(()=>[(f(!0),k(se,null,ne(j(s).smsGroupList,y=>(f(),D(w,{key:y.name},{default:t(()=>[e(o,{class:"text-center align-middle"},{default:t(()=>[e(j(P),{variant:"outline-danger",size:"sm",onClick:E=>u(y)},{default:t(()=>[e(I)]),_:2},1032,["onClick"])]),_:2},1024),e(p,{class:"align-middle"},{default:t(()=>[l(S(y.name),1)]),_:2},1024),e(o,{class:"text-end align-middle number"},{default:t(()=>{var E;return[l(S((E=y.twmIdList)==null?void 0:E.length),1)]}),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(L,null,{default:t(()=>[l(S(y.sentCount),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(L,null,{default:t(()=>[e(R,{"twm-id-list":y.smsReadyTwmIdList},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[$("div",Rt,[e(j(P),{variant:"outline-primary",size:"sm",onClick:E=>x(y,10),disabled:b(y)},{default:t(()=>[l("+10%")]),_:2},1032,["onClick","disabled"]),e(j(P),{variant:"outline-primary",size:"sm",onClick:E=>x(y,100),class:"ms-1",disabled:b(y)},{default:t(()=>[l("All")]),_:2},1032,["onClick","disabled"])])]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(R,{"twm-id-list":y.smsTwmIdList},null,8,["twm-id-list"])]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(L,null,{default:t(()=>[e(R,{"twm-id-list":y.smsTwmIdListFilted},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(L,null,{default:t(()=>[e(R,{"phone-number-list":y.smsPhoneNumberFilted},null,8,["phone-number-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(L,null,{default:t(()=>[l(S(y.tamiDeviceIdCount),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(K,{"sms-group":y},null,8,["sms-group"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(B,null,{default:t(()=>[e(w,null,{default:t(()=>[e(o),e(o,null,{default:t(()=>[l("共 "+S(j(s).smsGroupList.length)+" 群",1)]),_:1}),e(o,{class:Te({"text-center":n.value,number:!n.value})},{default:t(()=>[n.value?ue((f(),D(j(P),{key:0,variant:"outline-success",size:"sm",onClick:g},{default:t(()=>[e(G)]),_:1})),[[Y,"重新計算"]]):(f(),k("span",jt,S(i.value),1))]),_:1},8,["class"]),e(o),e(o),e(o,null,{default:t(()=>[$("div",Ht,[e(j(P),{variant:"outline-primary",size:"sm",onClick:d[0]||(d[0]=y=>m(10)),disabled:F()},{default:t(()=>[l("+10%")]),_:1},8,["disabled"]),e(j(P),{variant:"outline-primary",size:"sm",onClick:d[1]||(d[1]=y=>m(100)),class:"ms-1",disabled:F()},{default:t(()=>[l("All")]),_:1},8,["disabled"])])]),_:1}),e(o),e(o,{class:"text-center number"},{default:t(()=>[e(L,null,{default:t(()=>[l(S(C.value),1)]),_:1})]),_:1}),e(o,{class:"text-center number"},{default:t(()=>[e(L,null,{default:t(()=>[l(S(h.value),1)]),_:1})]),_:1}),e(o,{class:"text-center number"},{default:t(()=>[e(L,null,{default:t(()=>[l(S(T.value),1)]),_:1})]),_:1}),e(o)]),_:1}),e(w,null,{default:t(()=>[e(o),e(o),e(o,{class:"text-center"},{default:t(()=>[Ot]),_:1}),e(o),e(o),e(o),e(o),e(o,{class:"text-center"},{default:t(()=>[$("div",Yt,[ue((f(),D(j(P),{variant:"outline-primary",size:"sm",onClick:c,disabled:C.value<=0},{default:t(()=>[e(_),Zt]),_:1},8,["disabled"])),[[Y,`匯出 ${C.value-h.value} 筆沒有電話號碼的 SubID (DSC 用)`,void 0,{hover:!0,top:!0}]])])]),_:1}),e(o,{class:"text-center align-middle"}),e(o,null,{default:t(()=>[e(V,{disabled:T.value===0},null,8,["disabled"])]),_:1}),e(o,{class:"text-center align-middle"},{default:t(()=>[e(M,{class:"mt-1",disabled:h.value<=0},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})])}}}),Wt={key:1,class:"number"},cs=Z({__name:"TaGroupList",setup(U){const s=W(),n=N(!0),i=N(0),g=A(()=>s.groupList?s.groupList.sort((x,m)=>x.name.localeCompare(m.name)):[]),C=()=>{if(!s.groupList)return n.value=!1,0;console.time("[TaGroupList] TotalSubIdCount");const x=new Set;for(let m=0;m<s.groupList.length;m++){const u=s.groupList[m].twmIdList;for(let c=0;c<u.length;c++){const r=u[c];x.add(r)}}console.timeEnd("[TaGroupList] TotalSubIdCount"),i.value=x.size,n.value=!1},h=x=>{const m=s.groupList.findIndex(u=>u.name===x.name);m>=0&&s.groupList.splice(m,1),console.time("[TaGroupList] addSmsList");const v=new Ke(x.name,x.twmIdList);console.timeEnd("[TaGroupList] addSmsList"),s.smsGroupList.push(v),s.refreshFilted()},T=()=>{[...s.groupList].forEach(m=>h(m))};return(x,m)=>{const v=fe,u=ve,c=he,r=Fe,b=ge,F=P,a=be,d=$e,p=Ge,w=Se,z=Le;return f(),k("div",null,[e(w,{hover:"",small:"",bordered:""},{default:t(()=>[e(c,{"head-variant":"dark"},{default:t(()=>[e(u,null,{default:t(()=>[e(v,{class:"text-center align-middle"},{default:t(()=>[l("分群")]),_:1}),e(v,{class:"text-center align-middle"},{default:t(()=>[l("數量")]),_:1}),e(v,{class:"text-center align-middle"},{default:t(()=>[l("加入發送")]),_:1})]),_:1})]),_:1}),e(a,null,{default:t(()=>[(f(!0),k(se,null,ne(g.value,I=>(f(),D(u,{key:I.name},{default:t(()=>[e(v,{class:"align-middle"},{default:t(()=>[l(S(I.name),1)]),_:2},1024),e(b,{class:"text-center align-middle"},{default:t(()=>[e(r,{"twm-id-list":I.twmIdList},null,8,["twm-id-list"])]),_:2},1024),e(v,{class:"text-center"},{default:t(()=>[e(F,{variant:"outline-primary",size:"sm",onClick:o=>h(I)},{default:t(()=>[l("加入")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(p,null,{default:t(()=>[e(u,null,{default:t(()=>[e(b,null,{default:t(()=>[l("共 "+S(g.value.length)+" 群",1)]),_:1}),e(b,{class:"text-center"},{default:t(()=>[n.value?ue((f(),D(F,{key:0,variant:"outline-success",size:"sm",onClick:C},{default:t(()=>[e(d)]),_:1})),[[z,"重新計算"]]):(f(),k("span",Wt,S(i.value),1))]),_:1}),e(b,{class:"text-center"},{default:t(()=>[e(F,{variant:"outline-primary",size:"sm",onClick:m[0]||(m[0]=I=>T())},{default:t(()=>[l("加入")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})])}}}),qt={class:"sms-file-wrapper"},Jt=$("label",{for:"sms-file"},"已發送簡訊 (多選)",-1),Qt={class:"d-flex mt-2 align-items-center w-100"},Kt={key:0,class:"hint"},rs=Z({__name:"ImportSmsSent",setup(U){const s=W(),n=N(0),i=N(0),g=N(0);ce(n,(m,v)=>{m===0&&v>0&&s.refreshFilted()});const C=A(()=>n.value>0),h=async()=>{const m=await window.showOpenFilePicker({id:"market-sms-sent-"+s.hashCode(s.campaignName),multiple:!0,types:[{accept:{"text/plain":[".txt"]}}]});n.value=m.length,m.forEach(async v=>{const c=await(await v.getFile()).text();T(c)})},T=m=>{const v=m==null?void 0:m.split(`
`),u=s.phoneNumberSentSet.size;g.value+=v.length,v.forEach(r=>{const F=r.split("	")[0];s.phoneNumberSentSet.add(F)});const c=s.phoneNumberSentSet.size;console.log(`[SmsFile] load ${c-u} Sent Phone Numbers, Total: ${s.phoneNumberSentSet.size}`),n.value--,i.value++},x=()=>{i.value=0,g.value=0,s.phoneNumberSentSet.clear(),s.refreshFilted()};return(m,v)=>{const u=P,c=xe,r=pe;return f(),k("div",qt,[Jt,$("div",Qt,[e(u,{variant:"outline-primary",size:"sm",onClick:h},{default:t(()=>[l("匯入")]),_:1}),g.value>0&&!C.value?(f(),D(u,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:x},{default:t(()=>[e(c)]),_:1})):H("",!0),C.value?(f(),D(r,{key:1,variant:"primary",class:"ms-1"})):H("",!0)]),i.value>0?(f(),k("small",Kt,S(i.value)+" 檔案, "+S(g.value)+" 筆記錄, 重複 "+S(g.value-j(s).phoneNumberSentSet.size)+" 門號, "+S(j(s).phoneNumberSentSet.size)+" 門號",1)):H("",!0)])}}}),Xt={class:"import-dsc-wrapper"},es=$("label",{for:"dsc-file"},"門號 (DSC 轉出 csv)",-1),ts={class:"d-flex mt-2 align-items-center w-100"},ss={key:0,class:"hint"},ds=Z({__name:"ImportDSC",setup(U){const s=W(),n=N(0),i=N(0),g=N(0);Be(async()=>{}),ce(n,(v,u)=>{v===0&&u>0&&s.refreshFilted()});const C=A(()=>n.value>0),h=async()=>{const v=await window.showOpenFilePicker({id:"market-dsc",multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]});n.value=v.length,v.forEach(async u=>{const r=await(await u.getFile()).arrayBuffer(),b=Xe.decode(et.Buffer.from(r),"big5");T(b)})},T=v=>{ie.parse(v,{header:!0,skipEmptyLines:!0,transformHeader:(u,c)=>(console.log(`Header: ${c}`,u),u==="門號"?"phoneNumber":u==="SUBSCR_ID"?"subId":u),complete:u=>{if(u.errors.length>0){alert("Parse Error"),n.value--,i.value++;return}const c=u.data;x(c),n.value--,i.value++}})},x=v=>{g.value+=v.length,v.forEach(u=>{const c=s.subIdUserMap.get(u.subId);c&&(c.phoneNumber=u.phoneNumber,s.phoneNumberUserMap.set(u.phoneNumber,c))}),console.log(`[PhoneNumberFile] read ${v.length} subid <> phone number`)},m=()=>{i.value=0,g.value=0,s.phoneNumberUserMap.clear(),s.refreshFilted()};return(v,u)=>{const c=P,r=xe,b=pe;return f(),k("div",Xt,[es,$("div",ts,[e(c,{variant:"outline-primary",size:"sm",onClick:h,disabled:j(s).isUserEmpty},{default:t(()=>[l("匯入")]),_:1},8,["disabled"]),g.value>0&&!C.value?(f(),D(c,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:m},{default:t(()=>[e(r)]),_:1})):H("",!0),C.value?(f(),D(b,{key:1,variant:"primary",class:"ms-1"})):H("",!0)]),i.value?(f(),k("small",ss,"已讀取 "+S(i.value)+" 檔案, "+S(g.value)+" 筆記錄",1)):H("",!0)])}}}),ns={class:"title-wrapper"},os=$("label",{for:"compaign-name"},"活動名稱",-1),ms=Z({__name:"CampaignName",setup(U){const s=W(),n=N("");return Be(()=>{const i=localStorage.getItem("campaign-name");i&&(n.value=i)}),ce(n,i=>{localStorage.setItem("campaign-name",i),s.campaignName=i}),(i,g)=>{const C=tt;return f(),k("div",ns,[os,e(C,{modelValue:n.value,"onUpdate:modelValue":g[0]||(g[0]=h=>n.value=h),type:"text",id:"compaign-name",class:"ms-2"},null,8,["modelValue"])])}}});export{xe as _,ms as a,ds as b,rs as c,cs as d,us as e};
