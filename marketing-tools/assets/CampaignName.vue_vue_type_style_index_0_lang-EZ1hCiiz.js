import{o as b,a as B,b as I,d as J,u as Q,r as F,c as A,w as re,P as X,e,f as t,i as R,j as W,t as $,s as Ee,v as ie,x as Ve,z as Ue,p as E,A as De,y as Pe,k as _e,B as fe,C as Ae,n as Re,g as c,F as se,h as P,D as ne,E as Ne,G as je,I as He,H as Oe,Q as Ye,J as We,K as ve,L as he,O as ge,M as be,N as Se,R as Le,Y as Ze,U as ue,V as qe,W as Ce,T as ke,X as Ge,S as Je,q as Te,Z as Qe,$ as Ke,a0 as Xe}from"./index-Ephi6Fwh.js";import{_ as ce}from"./download-TzXogVwD.js";import{_ as et}from"./delete-outline-ndH7RiAZ.js";const tt={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},st=I("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"},null,-1),nt=[st];function ot(V,s){return b(),B("svg",tt,[...nt])}const $e={name:"mdi-close",render:ot},lt={class:"export-sms-file"},at=I("span",null,"門號 (商務簡訊)",-1),it={key:0,class:"ms-4 mt-2"},ut={class:"d-flex mt-2 align-items-center w-100"},rt={key:0,class:"hint"},ct=J({__name:"ExportSmsFile",props:{disabled:{type:Boolean}},setup(V){const s=V,n=Q(),u=F(!1),h=F([]),S=F([]),f=F(0),N=F(0),G=F(new Set),v=F([]),r=F(0),d=F(!1),l=A(()=>({text:`匯入 91 優惠券 (${o.value} 人缺優惠券)`,value:"upload-file"})),i=A(()=>{const C=Array.from(n.userArgSet).map(_=>({text:_,value:_}));return C.push(l.value),C}),L=A(()=>h.value.findIndex(C=>C===l.value.value)>=0);re(S,()=>{f.value=S.value.length,S.value.forEach(C=>k(C))});const k=C=>{d.value=!0,X.parse(C,{header:!0,skipEmptyLines:!0,encoding:"big5",transformHeader:(_,y)=>(console.log(`Header: ${y}`,_),_==="領取券號"?"couponCode":_==="是否領取"?"isRedeem":_),complete:_=>{if(_.errors.length>0){alert("Parse Error"),d.value=!1;return}const y=v.value.length;_.data.forEach(z=>{if(z.isRedeem.indexOf("否")===-1){console.log(`[ExportSmsFile] Coupon Code redeem: ${z.couponCode} -> ${z.isRedeem}`);return}if(G.value.has(z.couponCode)){console.log(`[ExportSmsFile] Coupon Code duplicated: ${z.couponCode}`);return}G.value.add(z.couponCode),v.value.push(z.couponCode)});const D=v.value.length;console.log(`[ExportSmsFile] read ${_.data.length} -> ${D-y} coupon Code`),f.value--,N.value++,d.value=!1}})},T=A(()=>f.value>0),U=()=>{o.value=m(),u.value=!0},o=F(0),m=()=>{let C=0;return console.log(`[ExportSmsFile] noCouponCodeCount, smsGroupList: ${n.smsGroupList.length}`),n.smsGroupList.forEach(_=>{console.log(`[ExportSmsFile] noCouponCodeCount, smsSendInfoList: ${_.smsSendInfoList.length}`),_.smsSendInfoList.forEach(y=>{console.log(`[ExportSmsFile] noCouponCodeCount, phoneNumberList: ${y.phoneNumberList.length}`),y.phoneNumberList.forEach(D=>{const z=n.phoneNumberUserMap.get(D);(!z||!z.couponCode)&&C++})})}),C},g=async()=>{d.value=!0;const C=w(),_="export-sms-file-"+n.hashCode(n.campaignName);n.saveZip(C.fileName,C.downloadFileList,_),d.value=!1,u.value=!1},w=()=>{r.value=0;const C=[],_=ie(new Date,"yyyyMMdd");let y=0,D=0;const z=n.smsGroupList,j=[],Z=[],K=[];for(let M=0;M<z.length;M++){const H=z[M];let we=0;const Ie=[];console.log(`[ExportSmsFile] smsGroup: ${H.name}: ${H.smsSendInfoList.length}`);for(let te=0;te<H.smsSendInfoList.length;te++){const de=H.smsSendInfoList[te];y++;const ee=x(de);D+=ee.length,we+=ee.length,console.log(`[ExportSmsFile] smsGroup: ${H.name}: [${te+1}] ${ee.length}`),K.push(ee.length);const me=n.partition(ee,5e3);for(let le=0;le<me.length;le++){const pe=me[le],Fe=X.unparse(pe,{delimiter:"	"}),ze=H.smsSendInfoList.length===1?"":`_${te+1}`,Me=me.length===1?"":`_${le+1}`,ye=`${n.campaignName}_商務簡訊_${_}_${M+1}${ze}${Me}_${H.name}_${pe.length}.txt`;C.push({fileName:ye,data:Fe}),j.push({smsText:de.text,phoneNumberFileName:ye,smsCount:pe.length})}Ie.push({smsText:de.text,smsCount:ee.length})}Z.push({taName:H.name,smsCount:we,smsItemList:Ie})}const O={};O.sendHour=Ve.Hour20,O.sendMinute=Ue.Minute00,O.smsList=j,O.smsGroupList=Z;const Y=`${n.campaignName}_商務簡訊_${_}_${z.length}受眾_${y}群_${D}.cfg`,q=JSON.stringify(O);C.push({fileName:Y,data:q});const oe=`${n.campaignName}_商務簡訊_${_}_${z.length}受眾_${y}群_${D}.zip`;return console.log(`受眾表用
${K.join(`
`)}`),{fileName:oe,downloadFileList:C}},p=new Set(["0979940180","0937654385","0937573896","0970646973","0980317712"]),x=C=>{const _=[],y=C.phoneNumberList;for(let D=0;D<y.length;D++){const z=y[D];if(p.has(z))continue;const j=n.phoneNumberUserMap.get(z);if(!j)continue;const Z=[z];for(let K=0;K<i.value.length;K++){const O=i.value[K];if(h.value.findIndex(q=>q===O.value)>=0)if(O.value===l.value.value){let q=j.couponCode;q||(q=v.value[r.value++]),q?(j.couponCode=q,Z.push(q)):Z.push("")}else j.params&&Z.push(j.params[O.value])}_.push(Z)}return _},a=()=>{S.value=[],N.value=0,v.value.length=0,G.value.clear()};return(C,_)=>{const y=ce,D=E,z=De,j=Pe,Z=$e,K=_e,O=fe;return b(),B("div",lt,[e(D,{variant:"outline-primary",size:"sm",onClick:U,disabled:s.disabled},{default:t(()=>[e(y),at]),_:1},8,["disabled"]),e(O,{modelValue:u.value,"onUpdate:modelValue":_[2]||(_[2]=Y=>u.value=Y),"ok-title":"匯出","cancel-title":"取消","cancel-variant":"outline-secondary",title:"參數",class:"args-modal",busy:d.value,onOk:g,onCancel:_[3]||(_[3]=Y=>u.value=!1),onClose:_[4]||(_[4]=Y=>u.value=!1),onHide:_[5]||(_[5]=Ee(()=>{},["prevent"]))},{default:t(()=>[e(z,{modelValue:h.value,"onUpdate:modelValue":_[0]||(_[0]=Y=>h.value=Y),options:i.value,stacked:""},null,8,["modelValue","options"]),L.value?(b(),B("div",it,[I("div",ut,[e(j,{modelValue:S.value,"onUpdate:modelValue":_[1]||(_[1]=Y=>S.value=Y),id:"dsc-file",accept:"text/csv",multiple:""},null,8,["modelValue"]),G.value.size>0&&!T.value?(b(),R(D,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:a},{default:t(()=>[e(Z)]),_:1})):W("",!0),T.value?(b(),R(K,{key:1,variant:"primary",class:"ms-1"})):W("",!0)]),N.value?(b(),B("small",rt,"已讀取 "+$(N.value)+" 檔案, "+$(G.value.size)+" 筆記錄",1)):W("",!0)])):W("",!0)]),_:1},8,["modelValue","busy"])])}}}),dt={class:"export-sms-file"},mt=I("span",null,"門號 (客服)",-1),pt=J({__name:"ExportCustomServiceFile",props:{disabled:{type:Boolean}},setup(V){const s=V,n=Q(),u=()=>{const h=ie(new Date,"yyyyMMdd"),S=n.smsGroupList.filter(r=>r.smsPhoneNumberFilted.length>0),f=[];let N=0,G=0;for(let r=0;r<S.length;r++){const d=S[r];for(let l=0;l<d.smsSendInfoList.length;l++){G++;const i=d.smsSendInfoList[l],L=`用戶分群: ${d.name}\r
簡訊內容: ${i.text}\r
發送數量: ${i.phoneNumberList.length}\r
`,k=`${n.campaignName}_客服_${h}_${G}_發送資訊.txt`;f.push({fileName:k,data:L});const T=[];i.phoneNumberList.forEach(o=>T.push([o])),N+=i.phoneNumberList.length;const U=n.partition(T,5e4);for(let o=0;o<U.length;o++){const m=U[o],g=X.unparse(m),w=U.length===1?"":`_${o+1}`,p=`${n.campaignName}_客服_${h}_${G}_門號${w}_${m.length}.txt`;f.push({fileName:p,data:g})}}}const v=`${n.campaignName}_客服_${h}_${G}群_${N}人.zip`;n.downloadZip(v,f)};return(h,S)=>{const f=ce,N=E;return b(),B("div",dt,[e(N,{variant:"outline-primary",size:"sm",class:"mt-1",onClick:u,disabled:s.disabled},{default:t(()=>[e(f),mt]),_:1},8,["disabled"])])}}}),_t={class:"export-fb-device-id"},ft=I("span",null,"FB 自訂受眾",-1),vt=J({__name:"ExportFbAudience",props:{disabled:{type:Boolean}},setup(V){const s=V,n=Q(),u=async()=>{const h=new Set;n.smsGroupList.forEach(N=>{N.smsPhoneNumberFilted.forEach(G=>{const v=n.phoneNumberUserMap.get(G);v&&v.deviceId&&h.add(v.deviceId)})});const S=`madid
`+Array.from(h).join(`
`),f=new File([S],"fb-device-id.csv",{type:"text/csv"});await window.showSaveFilePicker({id:"market-fb-audience-export",suggestedName:`${n.campaignName}_FB 自訂受眾_${Ae().format("YYYYMMDD")}_${h.size}筆.csv`,types:[{accept:{"text/csv":[".csv"]}}]}).then(async N=>{const G=await N.createWritable();await G.write(f),await G.close()})};return(h,S)=>{const f=ce,N=E;return b(),B("div",_t,[e(N,{variant:"outline-primary",size:"sm",onClick:u,disabled:s.disabled},{default:t(()=>[e(f),ft]),_:1},8,["disabled"])])}}}),ht={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},gt=I("path",{fill:"currentColor",d:"M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 2v4h10V4zm0 6v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2z"},null,-1),bt=[gt];function St(V,s){return b(),B("svg",ht,[...bt])}const xe={name:"mdi-calculator",render:St},Lt={key:0,class:"sms-send"},Ct=I("h6",{class:"title"},"分群測試",-1),$t={class:"section"},xt=I("h6",{class:"title"},"簡訊內容",-1),wt={class:"sms-item section"},It={class:"sms-header"},yt=["for"],Nt={class:"count"},kt={class:"sms-footer"},Gt=J({__name:"SmsSendModal",props:{smsGroup:{}},setup(V){const s=Re(),n=Q(),u=V,h=F(!1),S=F(1),f=F(["","",""]),N=i=>{const L=u.smsGroup.smsPhoneNumberFilted;if(L.length===0)return[];const k=Math.ceil(L.length/S.value);return n.partition(L,k)[i]},G=()=>{S.value=Math.max(u.smsGroup.smsSendInfoList.length,1),console.log(`[SmsSendModal] smsTestGroupCount: ${S.value}`),f.value.length=0,u.smsGroup.smsSendInfoList.forEach(i=>{f.value.push(i.text)}),h.value=!0},v=()=>{if(!u.smsGroup)return;const i=f.value.splice(0,S.value);n.fillSmsSendInfo(u.smsGroup,i),s.setSmsText(u.smsGroup.name,i)},r=i=>i?i.length:0,d=i=>{const L=r(f.value[i]);return L===0?null:L<=70},l=(i,L)=>{if(L.phoneNumber){const k=n.sms(f.value[i],L.phoneNumber);console.log(`[SmsSend] URL: ${k}`),window.open(k,"_blank")}};return(i,L)=>{const k=E,T=je,U=He,o=Oe,m=Ye,g=We,w=fe;return u.smsGroup?(b(),B("div",Lt,[e(k,{variant:"outline-primary",size:"sm",onClick:G,disabled:u.smsGroup.smsPhoneNumberFilted.length===0},{default:t(()=>[I("span",null,"編輯 ("+$(u.smsGroup.smsSendInfoList.length)+")",1)]),_:1},8,["disabled"]),e(w,{modelValue:h.value,"onUpdate:modelValue":L[1]||(L[1]=p=>h.value=p),size:"lg","ok-title":"確定","cancel-title":"取消","cancel-variant":"outline-secondary",onOk:v,class:"sms-send-modal"},{default:t(()=>[I("section",null,[Ct,I("div",$t,[e(U,{modelValue:S.value,"onUpdate:modelValue":L[0]||(L[0]=p=>S.value=p),name:"sms-test-group"},{default:t(()=>[e(T,{value:1},{default:t(()=>[c("不測試")]),_:1}),e(T,{value:2},{default:t(()=>[c("2 群")]),_:1}),e(T,{value:3},{default:t(()=>[c("3 群")]),_:1}),e(T,{value:4},{default:t(()=>[c("4 群")]),_:1}),e(T,{value:5},{default:t(()=>[c("5 群")]),_:1}),e(T,{value:6},{default:t(()=>[c("6 群")]),_:1})]),_:1},8,["modelValue"])])]),I("section",null,[xt,(b(!0),B(se,null,ne(S.value,p=>(b(),B("div",wt,[I("div",It,[I("label",{for:`sms-text-${p}`},"簡訊 "+$(p),9,yt),I("span",Nt,$(N(p-1).length)+" 人",1)]),e(o,{type:"text",size:"sm",id:`sms-text-${p}`,rows:"2",state:d(p-1),placeholder:"簡訊文案",modelValue:f.value[p-1],"onUpdate:modelValue":x=>f.value[p-1]=x},null,8,["id","state","modelValue","onUpdate:modelValue"]),I("div",kt,[e(g,{right:"",variant:"outline-primary",size:"sm",text:"測試"},{default:t(()=>[(b(!0),B(se,null,ne(P(n).userInfoListTest,x=>(b(),R(m,{onClick:a=>l(p-1,x),key:x.twmId},{default:t(()=>[c($(x.params.name),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024),I("span",{class:Ne(["sms-text",{warn:r(f.value[p-1])>70}])},$(r(f.value[p-1]))+" 個字 ",3)])]))),256))])]),_:1},8,["modelValue"])])):W("",!0)}}}),Tt={key:0,class:"ta-group-list-modal number"},Bt={key:0,class:""},Ft={class:"summary"},ae=100,Be=J({__name:"TaGroupListModal",props:{twmIdList:{},phoneNumberList:{}},setup(V){const s=Q(),n=V,u=F(!1),h=F(1),S=()=>{u.value=!0},f=A(()=>{var l,i;return((l=n.twmIdList)==null?void 0:l.length)||((i=n.phoneNumberList)==null?void 0:i.length)||0}),N=A(()=>{const l=[];if(!u.value)return l;const i=(h.value-1)*ae;return v.value.slice(i,i+ae)}),G=l=>ae*(h.value-1)+l+1,v=A(()=>{const l=[];return u.value&&(console.time("[TaGroupListModal] allUserList"),n.twmIdList&&n.twmIdList.length>0?n.twmIdList.forEach(i=>{const L=s.twmIdUserMap.get(i);L&&l.push(L)}):n.phoneNumberList&&n.phoneNumberList.length>0&&n.phoneNumberList.forEach(i=>{const L=s.phoneNumberUserMap.get(i);L&&l.push(L)}),console.timeEnd("[TaGroupListModal] allUserList")),l}),r=A(()=>u.value?v.value.filter(l=>!!l.phoneNumber).length:0),d=A(()=>u.value?v.value.filter(l=>!!l.couponCode).length:0);return(l,i)=>{const L=E,k=ve,T=he,U=ge,o=be,m=Se,g=Le,w=Ze,p=fe;return n.twmIdList||n.phoneNumberList?(b(),B("div",Tt,[f.value===0?(b(),B("span",Bt,"0")):(b(),R(L,{key:1,variant:"link",onClick:S,class:""},{default:t(()=>[c($(f.value),1)]),_:1})),e(p,{modelValue:u.value,"onUpdate:modelValue":i[1]||(i[1]=x=>u.value=x),scrollable:"",size:"lg",title:"使用者詳情",class:"ta-list-modal"},{default:t(()=>[I("div",Ft,[c(" 總數："),I("span",null,$(f.value)+"，有門號："+$(r.value)+" (少 "+$(r.value-f.value)+")，有優惠券："+$(d.value)+" (少 "+$(d.value-f.value)+")",1)]),e(g,{hover:"",small:"",bordered:""},{default:t(()=>[e(U,null,{default:t(()=>[e(T,null,{default:t(()=>[e(k,{class:"text-center align-middle"},{default:t(()=>[c("No")]),_:1}),e(k,{class:"text-center align-middle"},{default:t(()=>[c("台灣大會員編號")]),_:1}),e(k,{class:"text-center align-middle"},{default:t(()=>[c("SubId")]),_:1}),e(k,{class:"text-center align-middle"},{default:t(()=>[c("門號")]),_:1}),e(k,{class:"text-center align-middle"},{default:t(()=>[c("資費")]),_:1}),e(k,{class:"text-center align-middle"},{default:t(()=>[c("優惠券序號")]),_:1})]),_:1})]),_:1}),e(m,null,{default:t(()=>[(b(!0),B(se,null,ne(N.value,(x,a)=>(b(),R(T,{key:x.twmId},{default:t(()=>[e(o,{class:"text-center align-middle"},{default:t(()=>[c($(G(a)),1)]),_:2},1024),e(o,{class:"text-center align-middle number"},{default:t(()=>[c($(x.twmId),1)]),_:2},1024),e(o,{class:"text-center align-middle number"},{default:t(()=>[c($(x.subId),1)]),_:2},1024),e(o,{class:"text-center align-middle number"},{default:t(()=>[c($(x.phoneNumber),1)]),_:2},1024),e(o,{class:"text-center align-middle number"},{default:t(()=>[c($(x.params["目前方案專案V+D+V資費"]),1)]),_:2},1024),e(o,{class:"text-center align-middle number"},{default:t(()=>[c($(x.couponCode),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(w,{modelValue:h.value,"onUpdate:modelValue":i[0]||(i[0]=x=>h.value=x),size:"sm","total-rows":f.value,"per-page":ae},null,8,["modelValue","total-rows"])]),_:1},8,["modelValue"])])):W("",!0)}}}),zt={class:"calc-button"},Mt={key:1,class:"number"},Et=J({__name:"CalcButton",setup(V){const s=Q(),n=()=>{s.refresh()};return(u,h)=>{const S=xe,f=E,N=Ce;return b(),B("div",zt,[P(s).needReCalc?ue((b(),R(f,{key:0,variant:"outline-success",size:"sm",onClick:n},{default:t(()=>[e(S)]),_:1})),[[N,"重新計算"]]):(b(),B("div",Mt,[qe(u.$slots,"default")]))])}}}),Vt={class:"d-flex flex-column justify-content-end"},Ut=I("br",null,null,-1),Dt=I("span",{class:"hint"},"(商務簡訊)",-1),Pt={class:"text-nowrap"},At={key:1},Rt={class:"text-nowrap"},jt={class:"d-flex flex-column"},Ht=I("span",null,"SubId (DSC)",-1),Ot={class:"d-flex flex-column"},Yt=I("span",null,"SubId (DSC)",-1),Wt=I("span",null,"名單總表",-1),us=J({__name:"SmsGroupList",setup(V){const s=Q(),n=F(!0),u=F(0),h=()=>{if(!s.smsGroupList)return n.value=!1,0;console.time("[SmsGroupList] TotalSubIdCount");const o=new Set;for(let m=0;m<s.smsGroupList.length;m++){const w=s.smsGroupList[m].twmIdList;for(let p=0;p<w.length;p++){const x=w[p];o.add(x)}}console.timeEnd("[SmsGroupList] TotalSubIdCount"),n.value=!1,u.value=o.size},S=A(()=>{let o=0;return s.smsGroupList.forEach(m=>o+=m.smsTwmIdListFilted.length),o}),f=A(()=>{let o=0;return s.smsGroupList.forEach(m=>o+=m.smsPhoneNumberFilted.length),o}),N=A(()=>{let o=0;return s.smsGroupList.forEach(m=>o+=m.tamiDeviceIdCount),o}),G=(o,m)=>{const g=o.smsReadyTwmIdList;if(m>=100)o.smsTwmIdList=g.slice(0);else{const w=new Set;o.smsTwmIdList.forEach(a=>w.add(a));const p=g.length*m/100,x=r(g).slice(0,p);x.forEach(a=>w.add(a)),o.smsTwmIdList=Array.from(w),console.log(`[GroupList] addSmsList: ${p}: ${x.length}`)}s.refreshFilted()},v=o=>{for(let m=0;m<s.smsGroupList.length;m++){const g=s.smsGroupList[m];G(g,o)}},r=o=>{const m=o.slice(0);for(let g=m.length-1;g>0;g--){let w=Math.floor(Math.random()*(g+1));[m[g],m[w]]=[m[w],m[g]]}return m},d=o=>{const m=s.smsGroupList.findIndex(w=>w.name===o.name);m>=0&&s.smsGroupList.splice(m,1);const g=new ke(o.name,o.twmIdList);s.groupList.push(g),s.refreshFilted(),n.value=!0},l=()=>{L(o=>o.twmIdList)},i=()=>{L(o=>o.smsTwmIdListFilted)},L=o=>{if(!s.smsGroupList)return;const m=[],g=new Set;for(let p=0;p<s.smsGroupList.length;p++){const x=s.smsGroupList[p],a=o(x);for(let C=0;C<a.length;C++){const _=a[C],y=s.twmIdUserMap.get(_);!y||!y.subId||y.phoneNumber&&y.phoneNumber.length>0||g.has(y.subId)||(g.add(y.subId),m.push({SUBSCR_ID:y.subId}))}}console.log(`[SmsGroupList] export ${m.length} subId`);const w=s.partition(m,2e5);for(let p=0;p<w.length;p++){const x=w[p],a=ie(new Date,"yyyyMMdd"),C=`${s.campaignName}_DSC_SubId_${a}_${w.length}-${p+1}_${x.length}.csv`,_=X.unparse(x);s.downloadFile(_,C)}},k=()=>{if(!s.smsGroupList)return;const o=[];for(let p=0;p<s.smsGroupList.length;p++){const x=s.smsGroupList[p],a=x.smsPhoneNumberFilted;for(let C=0;C<a.length;C++){const _=a[C],y=s.phoneNumberUserMap.get(_);y&&o.push({Sms:x.name,TwmId:y.twmId,SubId:y.subId,門號:y.phoneNumber,優惠券:y.couponCode})}}console.log(`[SmsGroupList] export ${o.length} All Sms CSV`);const m=ie(new Date,"yyyyMMdd"),g=`${s.campaignName}_發送名單資訊_${m}_${o.length}.csv`,w=X.unparse(o);s.downloadFile(w,g)},T=o=>o.smsReadyTwmIdList.length<=o.smsTwmIdList.length,U=()=>{for(let o=0;o<s.smsGroupList.length;o++){const m=s.smsGroupList[o];if(!T(m))return!1}return!0};return(o,m)=>{const g=ve,w=he,p=ge,x=et,a=be,C=Et,_=Be,y=Gt,D=Se,z=xe,j=ce,Z=vt,K=pt,O=ct,Y=Ge,q=Le,oe=Ce;return b(),B("div",Vt,[e(q,{hover:"",small:"",bordered:""},{default:t(()=>[e(p,{"head-variant":"dark"},{default:t(()=>[e(w,null,{default:t(()=>[e(g,{class:"text-center align-middle"},{default:t(()=>[c("刪除")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("分群")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("原數量")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("已發送數")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("可發送數")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("發送")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("欲發送數")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("發送數")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("門號數"),Ut,Dt]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("Device ID 數")]),_:1}),e(g,{class:"text-center align-middle"},{default:t(()=>[c("簡訊內容")]),_:1})]),_:1})]),_:1}),e(D,null,{default:t(()=>[(b(!0),B(se,null,ne(P(s).smsGroupList,M=>(b(),R(w,{key:M.name},{default:t(()=>[e(a,{class:"text-center align-middle"},{default:t(()=>[e(P(E),{variant:"outline-danger",size:"sm",onClick:H=>d(M)},{default:t(()=>[e(x)]),_:2},1032,["onClick"])]),_:2},1024),e(g,{class:"align-middle"},{default:t(()=>[c($(M.name),1)]),_:2},1024),e(a,{class:"text-end align-middle number"},{default:t(()=>{var H;return[c($((H=M.twmIdList)==null?void 0:H.length),1)]}),_:2},1024),e(a,{class:"text-center align-middle"},{default:t(()=>[e(C,null,{default:t(()=>[c($(M.sentCount),1)]),_:2},1024)]),_:2},1024),e(a,{class:"text-center align-middle"},{default:t(()=>[e(C,null,{default:t(()=>[e(_,{"twm-id-list":M.smsReadyTwmIdList},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(a,{class:"text-center align-middle"},{default:t(()=>[I("div",Pt,[e(P(E),{variant:"outline-primary",size:"sm",onClick:H=>G(M,10),disabled:T(M)},{default:t(()=>[c("+10%")]),_:2},1032,["onClick","disabled"]),e(P(E),{variant:"outline-primary",size:"sm",onClick:H=>G(M,100),class:"ms-1",disabled:T(M)},{default:t(()=>[c("All")]),_:2},1032,["onClick","disabled"])])]),_:2},1024),e(a,{class:"text-center align-middle"},{default:t(()=>[e(_,{"twm-id-list":M.smsTwmIdList},null,8,["twm-id-list"])]),_:2},1024),e(a,{class:"text-center align-middle"},{default:t(()=>[e(C,null,{default:t(()=>[e(_,{"twm-id-list":M.smsTwmIdListFilted},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(a,{class:"text-center align-middle"},{default:t(()=>[e(C,null,{default:t(()=>[e(_,{"phone-number-list":M.smsPhoneNumberFilted},null,8,["phone-number-list"])]),_:2},1024)]),_:2},1024),e(a,{class:"text-center align-middle"},{default:t(()=>[e(C,null,{default:t(()=>[c($(M.tamiDeviceIdCount),1)]),_:2},1024)]),_:2},1024),e(a,{class:"text-center align-middle"},{default:t(()=>[e(y,{"sms-group":M},null,8,["sms-group"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(Y,null,{default:t(()=>[e(w,null,{default:t(()=>[e(a),e(a,null,{default:t(()=>[c("共 "+$(P(s).smsGroupList.length)+" 群",1)]),_:1}),e(a,{class:Ne({"text-center":n.value,number:!n.value})},{default:t(()=>[n.value?ue((b(),R(P(E),{key:0,variant:"outline-success",size:"sm",onClick:h},{default:t(()=>[e(z)]),_:1})),[[oe,"重新計算"]]):(b(),B("span",At,$(u.value),1))]),_:1},8,["class"]),e(a),e(a),e(a,null,{default:t(()=>[I("div",Rt,[e(P(E),{variant:"outline-primary",size:"sm",onClick:m[0]||(m[0]=M=>v(10)),disabled:U()},{default:t(()=>[c("+10%")]),_:1},8,["disabled"]),e(P(E),{variant:"outline-primary",size:"sm",onClick:m[1]||(m[1]=M=>v(100)),class:"ms-1",disabled:U()},{default:t(()=>[c("All")]),_:1},8,["disabled"])])]),_:1}),e(a),e(a,{class:"text-center number"},{default:t(()=>[e(C,null,{default:t(()=>[c($(S.value),1)]),_:1})]),_:1}),e(a,{class:"text-center number"},{default:t(()=>[e(C,null,{default:t(()=>[c($(f.value),1)]),_:1})]),_:1}),e(a,{class:"text-center number"},{default:t(()=>[e(C,null,{default:t(()=>[c($(N.value),1)]),_:1})]),_:1}),e(a)]),_:1}),e(w,null,{default:t(()=>[e(a),e(a),e(a,{class:"text-center"},{default:t(()=>[I("div",jt,[e(P(E),{variant:"outline-primary",size:"sm",onClick:l},{default:t(()=>[e(j),Ht]),_:1})])]),_:1}),e(a),e(a),e(a),e(a),e(a,{class:"text-center"},{default:t(()=>[I("div",Ot,[ue((b(),R(P(E),{variant:"outline-primary",size:"sm",onClick:i,disabled:S.value<=0},{default:t(()=>[e(j),Yt]),_:1},8,["disabled"])),[[oe,`匯出 ${S.value-f.value} 筆沒有電話號碼的 SubID (DSC 用)`,void 0,{hover:!0,top:!0}]])])]),_:1}),e(a,{class:"text-center align-middle"}),e(a,null,{default:t(()=>[e(Z,{disabled:N.value===0},null,8,["disabled"])]),_:1}),e(a,{class:"text-center align-middle"},{default:t(()=>[e(K,{disabled:f.value<=0},null,8,["disabled"]),e(O,{class:"mt-1",disabled:f.value<=0},null,8,["disabled"])]),_:1})]),_:1}),e(w,null,{default:t(()=>[e(a),e(a),e(a),e(a),e(a),e(a),e(a),e(a,{colspan:"2",class:"text-center align-middle"},{default:t(()=>[e(P(E),{variant:"outline-primary",size:"sm",class:"mt-1",onClick:k,disabled:S.value<=0},{default:t(()=>[e(j),Wt]),_:1},8,["disabled"])]),_:1}),e(a),e(a)]),_:1})]),_:1})]),_:1})])}}}),Zt={key:1,class:"number"},rs=J({__name:"TaGroupList",setup(V){const s=Q(),n=F(!0),u=F(0),h=A(()=>s.groupList?s.groupList.sort((v,r)=>v.name.localeCompare(r.name)):[]),S=()=>{if(!s.groupList)return n.value=!1,0;console.time("[TaGroupList] TotalSubIdCount");const v=new Set;for(let r=0;r<s.groupList.length;r++){const l=s.groupList[r].twmIdList;for(let i=0;i<l.length;i++){const L=l[i];v.add(L)}}console.timeEnd("[TaGroupList] TotalSubIdCount"),u.value=v.size,n.value=!1},f=v=>{const r=s.groupList.findIndex(l=>l.name===v.name);r>=0&&s.groupList.splice(r,1),console.time("[TaGroupList] addSmsList");const d=new Je(v.name,v.twmIdList);console.timeEnd("[TaGroupList] addSmsList"),s.smsGroupList.push(d),s.refreshFilted()},N=()=>{[...s.groupList].forEach(r=>f(r))},G=async()=>{const[v]=await window.showOpenFilePicker({multiple:!1,types:[{accept:{"text/csv":[".csv"]}}]}),r=await v.getFile(),d=await r.text();X.parse(d,{header:!1,skipEmptyLines:!0,complete:l=>{if(l.errors.length>0){alert("Parse Error");return}console.log(`[TaGroupList] add ${l.data.length} Users begin`);const i=[];for(let k=0;k<l.data.length;k++){const T=l.data[k],U=s.phoneNumberUserMap.get(T[2]);U&&i.push(U.twmId)}console.log(`[TaGroupList] add ${l.data.length} Users Complete`);const L=new ke(r.name,i);s.groupList.push(L),console.log(`[TaGroupList] complete ${s.groupList.length} TaGroup`)}})};return(v,r)=>{const d=ve,l=he,i=ge,L=Be,k=be,T=E,U=Se,o=xe,m=Ge,g=Le,w=Ce;return b(),B("div",null,[e(g,{hover:"",small:"",bordered:""},{default:t(()=>[e(i,{"head-variant":"dark"},{default:t(()=>[e(l,null,{default:t(()=>[e(d,{class:"text-center align-middle"},{default:t(()=>[c("分群")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[c("數量")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[c("加入發送")]),_:1})]),_:1})]),_:1}),e(U,null,{default:t(()=>[(b(!0),B(se,null,ne(h.value,p=>(b(),R(l,{key:p.name},{default:t(()=>[e(d,{class:"align-middle"},{default:t(()=>[c($(p.name),1)]),_:2},1024),e(k,{class:"text-center align-middle"},{default:t(()=>[e(L,{"twm-id-list":p.twmIdList},null,8,["twm-id-list"])]),_:2},1024),e(d,{class:"text-center"},{default:t(()=>[e(T,{variant:"outline-primary",size:"sm",onClick:x=>f(p)},{default:t(()=>[c("加入")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(m,null,{default:t(()=>[e(l,null,{default:t(()=>[e(k,null,{default:t(()=>[c("共 "+$(h.value.length)+" 群",1)]),_:1}),e(k,{class:"text-center"},{default:t(()=>[n.value?ue((b(),R(T,{key:0,variant:"outline-success",size:"sm",onClick:S},{default:t(()=>[e(o)]),_:1})),[[w,"重新計算"]]):(b(),B("span",Zt,$(u.value),1))]),_:1}),e(k,{class:"text-center"},{default:t(()=>[e(T,{variant:"outline-primary",size:"sm",onClick:r[0]||(r[0]=p=>N())},{default:t(()=>[c("加入")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(T,{variant:"outline-primary",size:"sm",onClick:G},{default:t(()=>[c("匯入 91App 受眾")]),_:1})])}}}),qt={class:"sms-file-wrapper"},Jt=I("label",{for:"sms-file"},"已發送簡訊 (多選)",-1),Qt={class:"d-flex mt-2 align-items-center w-100"},Kt={key:0,class:"hint"},cs=J({__name:"ImportSmsSent",setup(V){const s=Q(),n=F(0),u=F(0),h=F(0);re(n,(v,r)=>{v===0&&r>0&&s.refreshFilted()});const S=A(()=>n.value>0),f=async()=>{const v=await window.showOpenFilePicker({id:"market-sms-sent-"+s.hashCode(s.campaignName),multiple:!0,types:[{accept:{"text/plain":[".txt"]}}]});n.value=v.length,v.forEach(async r=>{const l=await(await r.getFile()).text();N(l)})},N=v=>{const r=v==null?void 0:v.split(`
`),d=s.phoneNumberSentSet.size;h.value+=r.length,r.forEach(i=>{const k=i.split("	")[0];s.phoneNumberSentSet.add(k)});const l=s.phoneNumberSentSet.size;console.log(`[SmsFile] load ${l-d} Sent Phone Numbers, Total: ${s.phoneNumberSentSet.size}`),n.value--,u.value++},G=()=>{u.value=0,h.value=0,s.phoneNumberSentSet.clear(),s.refreshFilted()};return(v,r)=>{const d=E,l=$e,i=_e;return b(),B("div",qt,[Jt,I("div",Qt,[e(d,{variant:"outline-primary",size:"sm",onClick:f},{default:t(()=>[c("匯入")]),_:1}),h.value>0&&!S.value?(b(),R(d,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:G},{default:t(()=>[e(l)]),_:1})):W("",!0),S.value?(b(),R(i,{key:1,variant:"primary",class:"ms-1"})):W("",!0)]),u.value>0?(b(),B("small",Kt,$(u.value)+" 檔案, "+$(h.value)+" 筆記錄, 重複 "+$(h.value-P(s).phoneNumberSentSet.size)+" 門號, "+$(P(s).phoneNumberSentSet.size)+" 門號",1)):W("",!0)])}}}),Xt={class:"import-dsc-wrapper"},es=I("label",{for:"dsc-file"},"門號 (DSC 轉出 csv)",-1),ts={class:"d-flex mt-2 align-items-center w-100"},ss={key:0,class:"hint"},ds=J({__name:"ImportDSC",setup(V){const s=Q(),n=F(0),u=F(0),h=F(0);Te(async()=>{}),re(n,(r,d)=>{r===0&&d>0&&s.refreshFilted()});const S=A(()=>n.value>0),f=async()=>{const r=await window.showOpenFilePicker({id:"market-dsc",multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]});n.value=r.length,r.forEach(async d=>{const i=await(await d.getFile()).arrayBuffer(),L=Qe.decode(Ke.Buffer.from(i),"big5");N(L)})},N=r=>{X.parse(r,{header:!0,skipEmptyLines:!0,transformHeader:(d,l)=>(console.log(`Header: ${l}`,d),d==="門號"?"phoneNumber":d==="SUBSCR_ID"?"subId":d),complete:d=>{if(d.errors.length>0){alert("Parse Error"),n.value--,u.value++;return}const l=d.data;G(l),n.value--,u.value++}})},G=r=>{h.value+=r.length,r.forEach(d=>{const l=s.subIdUserMap.get(d.subId);l&&(l.phoneNumber=d.phoneNumber,s.phoneNumberUserMap.set(d.phoneNumber,l))}),console.log(`[PhoneNumberFile] read ${r.length} subid <> phone number`)},v=()=>{u.value=0,h.value=0,s.phoneNumberUserMap.clear(),s.refreshFilted()};return(r,d)=>{const l=E,i=$e,L=_e;return b(),B("div",Xt,[es,I("div",ts,[e(l,{variant:"outline-primary",size:"sm",onClick:f,disabled:P(s).isUserEmpty},{default:t(()=>[c("匯入")]),_:1},8,["disabled"]),h.value>0&&!S.value?(b(),R(l,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:v},{default:t(()=>[e(i)]),_:1})):W("",!0),S.value?(b(),R(L,{key:1,variant:"primary",class:"ms-1"})):W("",!0)]),u.value?(b(),B("small",ss,"已讀取 "+$(u.value)+" 檔案, "+$(h.value)+" 筆記錄",1)):W("",!0)])}}}),ns={class:"title-wrapper"},os=I("label",{for:"compaign-name"},"活動名稱",-1),ms=J({__name:"CampaignName",setup(V){const s=Q(),n=F("");return Te(()=>{const u=localStorage.getItem("campaign-name");u&&(n.value=u)}),re(n,u=>{localStorage.setItem("campaign-name",u),s.campaignName=u}),(u,h)=>{const S=Xe;return b(),B("div",ns,[os,e(S,{modelValue:n.value,"onUpdate:modelValue":h[0]||(h[0]=f=>n.value=f),type:"text",id:"compaign-name",class:"ms-2"},null,8,["modelValue"])])}}});export{$e as _,ms as a,ds as b,cs as c,rs as d,us as e};
