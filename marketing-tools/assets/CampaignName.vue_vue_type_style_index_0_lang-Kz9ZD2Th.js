import{o as v,a as T,b as C,d as W,u as Z,r as k,c as V,w as ne,P as pe,e,f as t,i as D,j as O,g as a,t as b,q as Pe,s as Ne,v as Ge,S as Ae,x as Re,k as A,y as je,p as He,l as _e,H as fe,m as Oe,F as oe,h as j,z as le,A as Te,C as Ye,E as We,B as Ze,Q as qe,D as Je,G as ve,I as he,O as ge,J as be,K as Se,L as Ce,M as Qe,N as ce,R as Ke,U as Le,T as Xe,V as Be,W as et,n as Fe,X as ze}from"./index-sOLuNDXu.js";import{_ as xe}from"./download-y6wuiZhm.js";import{_ as tt}from"./delete-outline-4R7BY_Kd.js";import{u as st}from"./store_file-u2ykShbN.js";const nt={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},ot=C("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"},null,-1),lt=[ot];function at(U,s){return v(),T("svg",nt,[...lt])}const we={name:"mdi-close",render:at},it={class:"export-sms-file"},ut=C("span",null,"門號 (商務簡訊)",-1),ct={key:0,class:"ms-4 mt-2"},rt={class:"d-flex mt-2 align-items-center w-100"},dt={key:0,class:"hint"},mt={class:"d-flex justify-content-between w-100"},pt={class:"d-flex align-items-center"},_t={class:"d-flex align-items-center"},ft=W({__name:"ExportSmsFile",props:{disabled:{type:Boolean}},setup(U){const s=U,n=Z(),i=k(!1),h=k([]),g=k([]),_=k(0),w=k(0),L=k(new Set),r=k([]),$=k(0),f=k(!1),m=V(()=>({text:`匯入 91 優惠券 (${d.value} 人缺優惠券)`,value:"upload-file"})),c=V(()=>{const I=Array.from(n.userArgSet).map(x=>({text:x,value:x}));return I.push(m.value),I}),p=V(()=>h.value.findIndex(I=>I===m.value.value)>=0);ne(g,()=>{_.value=g.value.length,g.value.forEach(I=>B(I))});const B=I=>{f.value=!0,pe.parse(I,{header:!0,skipEmptyLines:!0,encoding:"big5",transformHeader:(x,E)=>(console.log(`Header: ${E}`,x),x==="領取券號"?"couponCode":x==="是否領取"?"isRedeem":x),complete:x=>{if(x.errors.length>0){alert("Parse Error"),f.value=!1;return}const E=r.value.length;x.data.forEach(F=>{if(F.isRedeem.indexOf("否")===-1){console.log(`[ExportSmsFile] Coupon Code redeem: ${F.couponCode} -> ${F.isRedeem}`);return}if(L.value.has(F.couponCode)){console.log(`[ExportSmsFile] Coupon Code duplicated: ${F.couponCode}`);return}L.value.add(F.couponCode),r.value.push(F.couponCode)});const M=r.value.length;console.log(`[ExportSmsFile] read ${x.data.length} -> ${M-E} coupon Code`),_.value--,w.value++,f.value=!1}})},l=V(()=>_.value>0),u=()=>{d.value=N(),i.value=!0},d=k(0),N=()=>{let I=0;return console.log(`[ExportSmsFile] noCouponCodeCount, smsGroupList: ${n.smsGroupList.length}`),n.smsGroupList.forEach(x=>{console.log(`[ExportSmsFile] noCouponCodeCount, smsSendInfoList: ${x.smsSendInfoList.length}`),x.smsSendInfoList.forEach(E=>{console.log(`[ExportSmsFile] noCouponCodeCount, phoneNumberList: ${E.phoneNumberList.length}`),E.phoneNumberList.forEach(M=>{const F=n.phoneNumberUserMap.get(M);(!F||!F.couponCode)&&I++})})}),I},z=async()=>{if(!y.value)return;f.value=!0;const I="export-sms-file-"+n.hashCode(n.campaignName);n.saveZip(y.value.fileName,y.value.downloadFileList,I),f.value=!1,i.value=!1},y=k(),o=()=>{f.value||(f.value=!0,y.value=S(),f.value=!1,alert("打包完成"))},S=()=>{$.value=0;const I=[],x=Ne(new Date,"yyyyMMdd");let E=0,M=0;const F=n.smsGroupList,H=[],G=[],P=[];for(let ae=0;ae<F.length;ae++){const X=F[ae];let Ie=0;const ye=[];console.log(`[ExportSmsFile] smsGroup: ${X.name}: ${X.smsSendInfoList.length}`);for(let se=0;se<X.smsSendInfoList.length;se++){const re=X.smsSendInfoList[se];E++;const ee=K(re);M+=ee.length,Ie+=ee.length,console.log(`[ExportSmsFile] smsGroup: ${X.name}: [${se+1}] ${ee.length}`),P.push(ee.length);const de=n.partition(ee,5e3);for(let ie=0;ie<de.length;ie++){const me=de[ie],Ve=pe.unparse(me,{delimiter:"	"}),De=X.smsSendInfoList.length===1?"":`_${se+1}`,Ue=de.length===1?"":`_${ie+1}`,ke=`${n.campaignName}_商務簡訊_${x}_${ae+1}${De}${Ue}_${X.name}_${me.length}.txt`;I.push({fileName:ke,data:Ve}),H.push({smsText:re.text,phoneNumberFileName:ke,smsCount:me.length})}ye.push({smsText:re.text,smsCount:ee.length})}G.push({taName:X.name,smsCount:Ie,smsItemList:ye})}const Y={};Y.sendDate=Ge().format("YYYY-MM-DD"),Y.sendHour=Ae.Hour20,Y.sendMinute=Re.Minute00,Y.smsList=H,Y.smsGroupList=G;const J=`${n.campaignName}_商務簡訊_${x}_${F.length}受眾_${E}群_${M}.cfg`,Q=JSON.stringify(Y,null,4);I.push({fileName:J,data:Q});const Ee=`${n.campaignName}_商務簡訊_${x}_${F.length}受眾_${E}群_${M}.zip`;return console.log(`受眾表用
${P.join(`
`)}`),{fileName:Ee,downloadFileList:I}},R=new Set(["0979940180","0937654385","0937573896","0970646973","0980317712","0970008039","0905364116","0920693530","0920020856","0971068968","0922750299"]),K=I=>{const x=[],E=I.phoneNumberList;for(let M=0;M<E.length;M++){const F=E[M];if(R.has(F))continue;const H=n.phoneNumberUserMap.get(F);if(!H)continue;const G=[F];for(let P=0;P<c.value.length;P++){const Y=c.value[P];if(h.value.findIndex(Q=>Q===Y.value)>=0)if(Y.value===m.value.value){let Q=H.couponCode;Q||(Q=r.value[$.value++]),Q?(H.couponCode=Q,G.push(Q)):G.push("")}else H.params&&G.push(H.params[Y.value])}x.push(G)}return x},q=()=>{g.value=[],w.value=0,r.value.length=0,L.value.clear()},te=V(()=>y.value?"primary":"outline-secondary");return(I,x)=>{const E=xe,M=A,F=je,H=He,G=we,P=_e,Y=fe;return v(),T("div",it,[e(M,{variant:"outline-primary",size:"sm",onClick:u,disabled:s.disabled},{default:t(()=>[e(E),ut]),_:1},8,["disabled"]),e(Y,{modelValue:i.value,"onUpdate:modelValue":x[2]||(x[2]=J=>i.value=J),title:"參數",class:"args-modal",onClose:x[3]||(x[3]=J=>i.value=!1),onHide:x[4]||(x[4]=Pe(()=>{},["prevent"]))},{footer:t(()=>[C("div",mt,[C("div",pt,[f.value?(v(),D(P,{key:0})):O("",!0)]),C("div",_t,[e(M,{variant:"primary",size:"sm",onClick:o,disabled:f.value},{default:t(()=>[a("打包")]),_:1},8,["disabled"]),e(M,{variant:te.value,size:"sm",onClick:z,disabled:f.value||!y.value,class:"ml-2"},{default:t(()=>[a("匯出")]),_:1},8,["variant","disabled"])])])]),default:t(()=>[e(F,{modelValue:h.value,"onUpdate:modelValue":x[0]||(x[0]=J=>h.value=J),options:c.value,stacked:""},null,8,["modelValue","options"]),p.value?(v(),T("div",ct,[C("div",rt,[e(H,{modelValue:g.value,"onUpdate:modelValue":x[1]||(x[1]=J=>g.value=J),id:"dsc-file",accept:"text/csv",multiple:""},null,8,["modelValue"]),L.value.size>0&&!l.value?(v(),D(M,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:q},{default:t(()=>[e(G)]),_:1})):O("",!0),l.value?(v(),D(P,{key:1,variant:"primary",class:"ms-1"})):O("",!0)]),w.value?(v(),T("small",dt,"已讀取 "+b(w.value)+" 檔案, "+b(L.value.size)+" 筆記錄",1)):O("",!0)])):O("",!0)]),_:1},8,["modelValue"])])}}}),vt={class:"export-fb-device-id"},ht=C("span",null,"FB 自訂受眾",-1),gt=W({__name:"ExportFbAudience",props:{disabled:{type:Boolean}},setup(U){const s=U,n=Z(),i=async()=>{const h=new Set;n.smsGroupList.forEach(w=>{w.smsPhoneNumberFilted.forEach(L=>{const r=n.phoneNumberUserMap.get(L);r&&r.deviceId&&h.add(r.deviceId)})});const g=`madid
`+Array.from(h).join(`
`),_=new File([g],"fb-device-id.csv",{type:"text/csv"});await window.showSaveFilePicker({id:"market-fb-audience-export",suggestedName:`${n.campaignName}_FB 自訂受眾_${Ge().format("YYYYMMDD")}_${h.size}筆.csv`,types:[{accept:{"text/csv":[".csv"]}}]}).then(async w=>{const L=await w.createWritable();await L.write(_),await L.close()})};return(h,g)=>{const _=xe,w=A;return v(),T("div",vt,[e(w,{variant:"outline-primary",size:"sm",onClick:i,disabled:s.disabled},{default:t(()=>[e(_),ht]),_:1},8,["disabled"])])}}}),bt={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},St=C("path",{fill:"currentColor",d:"M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 2v4h10V4zm0 6v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2z"},null,-1),Ct=[St];function Lt(U,s){return v(),T("svg",bt,[...Ct])}const $e={name:"mdi-calculator",render:Lt},xt={key:0,class:"sms-send"},wt=C("h6",{class:"title"},"分群測試",-1),$t={class:"section"},It=C("h6",{class:"title"},"簡訊內容",-1),yt={class:"sms-item section"},kt={class:"sms-header"},Nt=["for"],Gt={class:"count"},Tt={class:"sms-footer"},Bt=W({__name:"SmsSendModal",props:{smsGroup:{}},setup(U){const s=Oe(),n=Z(),i=U,h=k(!1),g=k(1),_=k(["","",""]),w=c=>{const p=i.smsGroup.smsPhoneNumberFilted;if(p.length===0)return[];const B=Math.ceil(p.length/g.value);return n.partition(p,B)[c]},L=()=>{g.value=Math.max(i.smsGroup.smsSendInfoList.length,1),console.log(`[SmsSendModal] smsTestGroupCount: ${g.value}`),_.value.length=0,i.smsGroup.smsSendInfoList.forEach(c=>{_.value.push(c.text)}),h.value=!0},r=()=>{if(!i.smsGroup)return;const c=_.value.splice(0,g.value);n.fillSmsSendInfo(i.smsGroup,c),s.setSmsText(i.smsGroup.name,c)},$=c=>c?c.length:0,f=c=>{const p=$(_.value[c]);return p===0?null:p<=70},m=async(c,p)=>{p.phoneNumber&&await n.sms(p.phoneNumber,_.value[c])};return(c,p)=>{const B=A,l=Ye,u=We,d=Ze,N=qe,z=Je,y=fe;return i.smsGroup?(v(),T("div",xt,[e(B,{variant:"outline-primary",size:"sm",onClick:L,disabled:i.smsGroup.smsPhoneNumberFilted.length===0},{default:t(()=>[C("span",null,"編輯 ("+b(i.smsGroup.smsSendInfoList.length)+")",1)]),_:1},8,["disabled"]),e(y,{modelValue:h.value,"onUpdate:modelValue":p[1]||(p[1]=o=>h.value=o),size:"lg","ok-title":"確定","cancel-title":"取消","cancel-variant":"outline-secondary",onOk:r,class:"sms-send-modal"},{default:t(()=>[C("section",null,[wt,C("div",$t,[e(u,{modelValue:g.value,"onUpdate:modelValue":p[0]||(p[0]=o=>g.value=o),name:"sms-test-group"},{default:t(()=>[e(l,{value:1},{default:t(()=>[a("不測試")]),_:1}),e(l,{value:2},{default:t(()=>[a("2 群")]),_:1}),e(l,{value:3},{default:t(()=>[a("3 群")]),_:1}),e(l,{value:4},{default:t(()=>[a("4 群")]),_:1}),e(l,{value:5},{default:t(()=>[a("5 群")]),_:1}),e(l,{value:6},{default:t(()=>[a("6 群")]),_:1})]),_:1},8,["modelValue"])])]),C("section",null,[It,(v(!0),T(oe,null,le(g.value,o=>(v(),T("div",yt,[C("div",kt,[C("label",{for:`sms-text-${o}`},"簡訊 "+b(o),9,Nt),C("span",Gt,b(w(o-1).length)+" 人",1)]),e(d,{type:"text",size:"sm",id:`sms-text-${o}`,rows:"2",state:f(o-1),placeholder:"簡訊文案",modelValue:_.value[o-1],"onUpdate:modelValue":S=>_.value[o-1]=S},null,8,["id","state","modelValue","onUpdate:modelValue"]),C("div",Tt,[e(z,{right:"",variant:"outline-primary",size:"sm",text:"測試"},{default:t(()=>[(v(!0),T(oe,null,le(j(n).userInfoListTest,S=>(v(),D(N,{onClick:R=>m(o-1,S),key:S.twmId},{default:t(()=>[a(b(S.params.name),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024),C("span",{class:Te(["sms-text",{warn:$(_.value[o-1])>70}])},b($(_.value[o-1]))+" 個字 ",3)])]))),256))])]),_:1},8,["modelValue"])])):O("",!0)}}}),Ft={key:0,class:"ta-group-list-modal number"},zt={key:0,class:""},Mt={class:"summary"},ue=100,Me=W({__name:"TaGroupListModal",props:{twmIdList:{},phoneNumberList:{}},setup(U){const s=Z(),n=U,i=k(!1),h=k(1),g=()=>{i.value=!0},_=V(()=>{var m,c;return((m=n.twmIdList)==null?void 0:m.length)||((c=n.phoneNumberList)==null?void 0:c.length)||0}),w=V(()=>{const m=[];if(!i.value)return m;const c=(h.value-1)*ue;return r.value.slice(c,c+ue)}),L=m=>ue*(h.value-1)+m+1,r=V(()=>{const m=[];return i.value&&(console.time("[TaGroupListModal] allUserList"),n.twmIdList&&n.twmIdList.length>0?n.twmIdList.forEach(c=>{const p=s.twmIdUserMap.get(c);p&&m.push(p)}):n.phoneNumberList&&n.phoneNumberList.length>0&&n.phoneNumberList.forEach(c=>{const p=s.phoneNumberUserMap.get(c);p&&m.push(p)}),console.timeEnd("[TaGroupListModal] allUserList")),m}),$=V(()=>i.value?r.value.filter(m=>!!m.phoneNumber).length:0),f=V(()=>i.value?r.value.filter(m=>!!m.couponCode).length:0);return(m,c)=>{const p=A,B=ve,l=he,u=ge,d=be,N=Se,z=Ce,y=Qe,o=fe;return n.twmIdList||n.phoneNumberList?(v(),T("div",Ft,[_.value===0?(v(),T("span",zt,"0")):(v(),D(p,{key:1,variant:"link",onClick:g,class:""},{default:t(()=>[a(b(_.value),1)]),_:1})),e(o,{modelValue:i.value,"onUpdate:modelValue":c[1]||(c[1]=S=>i.value=S),scrollable:"",size:"lg",title:"使用者詳情",class:"ta-list-modal"},{default:t(()=>[C("div",Mt,[a(" 總數："),C("span",null,b(_.value)+"，有門號："+b($.value)+" (少 "+b($.value-_.value)+")，有優惠券："+b(f.value)+" (少 "+b(f.value-_.value)+")",1)]),e(z,{hover:"",small:"",bordered:""},{default:t(()=>[e(u,null,{default:t(()=>[e(l,null,{default:t(()=>[e(B,{class:"text-center align-middle"},{default:t(()=>[a("No")]),_:1}),e(B,{class:"text-center align-middle"},{default:t(()=>[a("台灣大會員編號")]),_:1}),e(B,{class:"text-center align-middle"},{default:t(()=>[a("SubId")]),_:1}),e(B,{class:"text-center align-middle"},{default:t(()=>[a("門號")]),_:1}),e(B,{class:"text-center align-middle"},{default:t(()=>[a("資費")]),_:1}),e(B,{class:"text-center align-middle"},{default:t(()=>[a("優惠券序號")]),_:1})]),_:1})]),_:1}),e(N,null,{default:t(()=>[(v(!0),T(oe,null,le(w.value,(S,R)=>(v(),D(l,{key:S.twmId},{default:t(()=>[e(d,{class:"text-center align-middle"},{default:t(()=>[a(b(L(R)),1)]),_:2},1024),e(d,{class:"text-center align-middle number"},{default:t(()=>[a(b(S.twmId),1)]),_:2},1024),e(d,{class:"text-center align-middle number"},{default:t(()=>[a(b(S.subId),1)]),_:2},1024),e(d,{class:"text-center align-middle number"},{default:t(()=>[a(b(S.phoneNumber),1)]),_:2},1024),e(d,{class:"text-center align-middle number"},{default:t(()=>[a(b(S.params["目前方案專案V+D+V資費"]),1)]),_:2},1024),e(d,{class:"text-center align-middle number"},{default:t(()=>[a(b(S.couponCode),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(y,{modelValue:h.value,"onUpdate:modelValue":c[0]||(c[0]=S=>h.value=S),size:"sm","total-rows":_.value,"per-page":ue},null,8,["modelValue","total-rows"])]),_:1},8,["modelValue"])])):O("",!0)}}}),Et={class:"calc-button"},Vt={key:1,class:"number"},Dt=W({__name:"CalcButton",setup(U){const s=Z(),n=()=>{s.refresh()};return(i,h)=>{const g=$e,_=A,w=Le;return v(),T("div",Et,[j(s).needReCalc?ce((v(),D(_,{key:0,variant:"outline-success",size:"sm",onClick:n},{default:t(()=>[e(g)]),_:1})),[[w,"重新計算"]]):(v(),T("div",Vt,[Ke(i.$slots,"default")]))])}}}),Ut={class:"d-flex flex-column justify-content-end"},Pt=C("br",null,null,-1),At=C("span",{class:"hint"},"(商務簡訊)",-1),Rt={class:"text-nowrap"},jt={key:1},Ht={class:"text-nowrap"},Ot=C("div",{class:"d-flex flex-column"},null,-1),Yt={class:"d-flex flex-column"},Wt=C("span",null,"SubId (DSC)",-1),ds=W({__name:"SmsGroupList",setup(U){const s=Z(),n=k(!0),i=k(0),h=()=>{if(!s.smsGroupList)return n.value=!1,0;console.time("[SmsGroupList] TotalSubIdCount");const l=new Set;for(let u=0;u<s.smsGroupList.length;u++){const N=s.smsGroupList[u].twmIdList;for(let z=0;z<N.length;z++){const y=N[z];l.add(y)}}console.timeEnd("[SmsGroupList] TotalSubIdCount"),n.value=!1,i.value=l.size},g=V(()=>{let l=0;return s.smsGroupList.forEach(u=>l+=u.smsTwmIdListFilted.length),l}),_=V(()=>{let l=0;return s.smsGroupList.forEach(u=>l+=u.smsPhoneNumberFilted.length),l}),w=V(()=>{let l=0;return s.smsGroupList.forEach(u=>l+=u.tamiDeviceIdCount),l}),L=(l,u)=>{const d=l.smsReadyTwmIdList;if(u>=100)l.smsTwmIdList=d.slice(0);else{const N=new Set;l.smsTwmIdList.forEach(o=>N.add(o));const z=d.length*u/100,y=$(d).slice(0,z);y.forEach(o=>N.add(o)),l.smsTwmIdList=Array.from(N),console.log(`[GroupList] addSmsList: ${z}: ${y.length}`)}s.refreshFilted()},r=l=>{for(let u=0;u<s.smsGroupList.length;u++){const d=s.smsGroupList[u];L(d,l)}},$=l=>{const u=l.slice(0);for(let d=u.length-1;d>0;d--){let N=Math.floor(Math.random()*(d+1));[u[d],u[N]]=[u[N],u[d]]}return u},f=l=>{const u=s.smsGroupList.findIndex(N=>N.name===l.name);u>=0&&s.smsGroupList.splice(u,1);const d=new Xe(l.name,l.twmIdList);s.groupList.push(d),s.refreshFilted(),n.value=!0},m=()=>{c(l=>l.smsTwmIdListFilted)},c=l=>{if(!s.smsGroupList)return;const u=[],d=new Set;for(let S=0;S<s.smsGroupList.length;S++){const R=s.smsGroupList[S],K=l(R);for(let q=0;q<K.length;q++){const te=K[q],I=s.twmIdUserMap.get(te);!I||!I.subId||I.phoneNumber&&I.phoneNumber.length>0||d.has(I.subId)||(d.add(I.subId),u.push({SUBSCR_ID:I.subId}))}}console.log(`[SmsGroupList] export ${u.length} subId`);const N=Ne(new Date,"yyyyMMdd"),z=[],y=s.partition(u,1e5);for(let S=0;S<y.length;S++){const R=y[S],K=`${s.campaignName}_DSC_SubId_${N}_${y.length}-${S+1}_${R.length}.csv`,q=pe.unparse(R);z.push({fileName:K,data:q})}const o=`${s.campaignName}_DSC_SubId_${N}_${y.length}份_共${u.length}筆.zip`;s.downloadZip(o,z)},p=l=>l.smsReadyTwmIdList.length<=l.smsTwmIdList.length,B=()=>{for(let l=0;l<s.smsGroupList.length;l++){const u=s.smsGroupList[l];if(!p(u))return!1}return!0};return(l,u)=>{const d=ve,N=he,z=ge,y=tt,o=be,S=Dt,R=Me,K=Bt,q=Se,te=$e,I=xe,x=gt,E=ft,M=Be,F=Ce,H=Le;return v(),T("div",Ut,[e(F,{hover:"",small:"",bordered:""},{default:t(()=>[e(z,{"head-variant":"dark"},{default:t(()=>[e(N,null,{default:t(()=>[e(d,{class:"text-center align-middle"},{default:t(()=>[a("刪除")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("分群")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("原數量")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("已發送數")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("可發送數")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("發送")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("欲發送數")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("發送數")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("門號數"),Pt,At]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("Device ID 數")]),_:1}),e(d,{class:"text-center align-middle"},{default:t(()=>[a("簡訊內容")]),_:1})]),_:1})]),_:1}),e(q,null,{default:t(()=>[(v(!0),T(oe,null,le(j(s).smsGroupList,G=>(v(),D(N,{key:G.name},{default:t(()=>[e(o,{class:"text-center align-middle"},{default:t(()=>[e(j(A),{variant:"outline-danger",size:"sm",onClick:P=>f(G)},{default:t(()=>[e(y)]),_:2},1032,["onClick"])]),_:2},1024),e(d,{class:"align-middle"},{default:t(()=>[a(b(G.name),1)]),_:2},1024),e(o,{class:"text-end align-middle number"},{default:t(()=>{var P;return[a(b((P=G.twmIdList)==null?void 0:P.length),1)]}),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[a(b(G.sentCount),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[e(R,{"twm-id-list":G.smsReadyTwmIdList},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[C("div",Rt,[e(j(A),{variant:"outline-primary",size:"sm",onClick:P=>L(G,10),disabled:p(G)},{default:t(()=>[a("+10%")]),_:2},1032,["onClick","disabled"]),e(j(A),{variant:"outline-primary",size:"sm",onClick:P=>L(G,100),class:"ms-1",disabled:p(G)},{default:t(()=>[a("All")]),_:2},1032,["onClick","disabled"])])]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(R,{"twm-id-list":G.smsTwmIdList},null,8,["twm-id-list"])]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[e(R,{"twm-id-list":G.smsTwmIdListFilted},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[e(R,{"phone-number-list":G.smsPhoneNumberFilted},null,8,["phone-number-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[a(b(G.tamiDeviceIdCount),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(K,{"sms-group":G},null,8,["sms-group"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(M,null,{default:t(()=>[e(N,null,{default:t(()=>[e(o),e(o,null,{default:t(()=>[a("共 "+b(j(s).smsGroupList.length)+" 群",1)]),_:1}),e(o,{class:Te({"text-center":n.value,number:!n.value})},{default:t(()=>[n.value?ce((v(),D(j(A),{key:0,variant:"outline-success",size:"sm",onClick:h},{default:t(()=>[e(te)]),_:1})),[[H,"重新計算"]]):(v(),T("span",jt,b(i.value),1))]),_:1},8,["class"]),e(o),e(o),e(o,null,{default:t(()=>[C("div",Ht,[e(j(A),{variant:"outline-primary",size:"sm",onClick:u[0]||(u[0]=G=>r(10)),disabled:B()},{default:t(()=>[a("+10%")]),_:1},8,["disabled"]),e(j(A),{variant:"outline-primary",size:"sm",onClick:u[1]||(u[1]=G=>r(100)),class:"ms-1",disabled:B()},{default:t(()=>[a("All")]),_:1},8,["disabled"])])]),_:1}),e(o),e(o,{class:"text-center number"},{default:t(()=>[e(S,null,{default:t(()=>[a(b(g.value),1)]),_:1})]),_:1}),e(o,{class:"text-center number"},{default:t(()=>[e(S,null,{default:t(()=>[a(b(_.value),1)]),_:1})]),_:1}),e(o,{class:"text-center number"},{default:t(()=>[e(S,null,{default:t(()=>[a(b(w.value),1)]),_:1})]),_:1}),e(o)]),_:1}),e(N,null,{default:t(()=>[e(o),e(o),e(o,{class:"text-center"},{default:t(()=>[Ot]),_:1}),e(o),e(o),e(o),e(o),e(o,{class:"text-center"},{default:t(()=>[C("div",Yt,[ce((v(),D(j(A),{variant:"outline-primary",size:"sm",onClick:m,disabled:g.value<=0},{default:t(()=>[e(I),Wt]),_:1},8,["disabled"])),[[H,`匯出 ${g.value-_.value} 筆沒有電話號碼的 SubID (DSC 用)`,void 0,{hover:!0,top:!0}]])])]),_:1}),e(o,{class:"text-center align-middle"}),e(o,null,{default:t(()=>[e(x,{disabled:w.value===0},null,8,["disabled"])]),_:1}),e(o,{class:"text-center align-middle"},{default:t(()=>[e(E,{class:"mt-1",disabled:_.value<=0},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})])}}}),Zt={key:1,class:"number"},ms=W({__name:"TaGroupList",setup(U){const s=Z(),n=k(!0),i=k(0),h=V(()=>s.groupList?s.groupList.sort((L,r)=>L.name.localeCompare(r.name)):[]),g=()=>{if(!s.groupList)return n.value=!1,0;console.time("[TaGroupList] TotalSubIdCount");const L=new Set;for(let r=0;r<s.groupList.length;r++){const f=s.groupList[r].twmIdList;for(let m=0;m<f.length;m++){const c=f[m];L.add(c)}}console.timeEnd("[TaGroupList] TotalSubIdCount"),i.value=L.size,n.value=!1},_=L=>{const r=s.groupList.findIndex(f=>f.name===L.name);r>=0&&s.groupList.splice(r,1),console.time("[TaGroupList] addSmsList");const $=new et(L.name,L.twmIdList);console.timeEnd("[TaGroupList] addSmsList"),s.smsGroupList.push($),s.refreshFilted()},w=()=>{[...s.groupList].forEach(r=>_(r))};return(L,r)=>{const $=ve,f=he,m=ge,c=Me,p=be,B=A,l=Se,u=$e,d=Be,N=Ce,z=Le;return v(),T("div",null,[e(N,{hover:"",small:"",bordered:""},{default:t(()=>[e(m,{"head-variant":"dark"},{default:t(()=>[e(f,null,{default:t(()=>[e($,{class:"text-center align-middle"},{default:t(()=>[a("分群")]),_:1}),e($,{class:"text-center align-middle"},{default:t(()=>[a("數量")]),_:1}),e($,{class:"text-center align-middle"},{default:t(()=>[a("加入發送")]),_:1})]),_:1})]),_:1}),e(l,null,{default:t(()=>[(v(!0),T(oe,null,le(h.value,y=>(v(),D(f,{key:y.name},{default:t(()=>[e($,{class:"align-middle"},{default:t(()=>[a(b(y.name),1)]),_:2},1024),e(p,{class:"text-center align-middle"},{default:t(()=>[e(c,{"twm-id-list":y.twmIdList},null,8,["twm-id-list"])]),_:2},1024),e($,{class:"text-center"},{default:t(()=>[e(B,{variant:"outline-primary",size:"sm",onClick:o=>_(y)},{default:t(()=>[a("加入")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(d,null,{default:t(()=>[e(f,null,{default:t(()=>[e(p,null,{default:t(()=>[a("共 "+b(h.value.length)+" 群",1)]),_:1}),e(p,{class:"text-center"},{default:t(()=>[n.value?ce((v(),D(B,{key:0,variant:"outline-success",size:"sm",onClick:g},{default:t(()=>[e(u)]),_:1})),[[z,"重新計算"]]):(v(),T("span",Zt,b(i.value),1))]),_:1}),e(p,{class:"text-center"},{default:t(()=>[e(B,{variant:"outline-primary",size:"sm",onClick:r[0]||(r[0]=y=>w())},{default:t(()=>[a("加入")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})])}}}),qt={class:"sms-file-wrapper"},Jt=C("h6",null,"已發送簡訊 (多選)",-1),Qt={class:"d-flex mt-2 align-items-center w-100"},Kt={key:0,class:"hint"},ps=W({__name:"ImportSmsSent",setup(U){const s=Z(),n=k(0),i=k(0),h=k(0);ne(n,(r,$)=>{r===0&&$>0&&s.refreshFilted()});const g=V(()=>n.value>0),_=async()=>{const r=await window.showOpenFilePicker({id:"market-sms-sent-"+s.hashCode(s.campaignName),multiple:!0,types:[{accept:{"text/plain":[".txt"]}}]});n.value=r.length,r.forEach(async $=>{const m=await(await $.getFile()).text();w(m)})},w=r=>{const $=r==null?void 0:r.split(`
`),f=s.phoneNumberSentSet.size;h.value+=$.length,$.forEach(c=>{const B=c.split("	")[0];s.phoneNumberSentSet.add(B)});const m=s.phoneNumberSentSet.size;console.log(`[SmsFile] load ${m-f} Sent Phone Numbers, Total: ${s.phoneNumberSentSet.size}`),n.value--,i.value++},L=()=>{i.value=0,h.value=0,s.phoneNumberSentSet.clear(),s.refreshFilted()};return(r,$)=>{const f=A,m=we,c=_e;return v(),T("div",qt,[Jt,C("div",Qt,[e(f,{variant:"outline-primary",size:"sm",onClick:_},{default:t(()=>[a("匯入")]),_:1}),h.value>0&&!g.value?(v(),D(f,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:L},{default:t(()=>[e(m)]),_:1})):O("",!0),g.value?(v(),D(c,{key:1,variant:"primary",class:"ms-1"})):O("",!0)]),i.value>0?(v(),T("small",Kt,b(i.value)+" 檔案, "+b(h.value)+" 筆記錄, 重複 "+b(h.value-j(s).phoneNumberSentSet.size)+" 門號, "+b(j(s).phoneNumberSentSet.size)+" 門號",1)):O("",!0)])}}}),Xt={class:"import-dsc-wrapper"},es=C("h6",null,"門號 (打包的 *.dsc)",-1),ts={class:"password"},ss=C("label",{for:"pw"},"檔案密碼：",-1),ns={class:"d-flex mt-2 align-items-center w-100"},os={key:0,class:"hint"},_s=W({__name:"ImportDSC",emits:["onImport"],setup(U,{emit:s}){const n=st(),i=Z(),h=k(0),g=k(0),_=k(0),w=k("");Fe(()=>{const f=localStorage.getItem("marketing_import_dsc_password");f&&(w.value=f)}),ne(w,()=>{localStorage.setItem("marketing_import_dsc_password",w.value)}),ne(h,(f,m)=>{f===0&&m>0&&i.refreshFilted()});const L=V(()=>h.value>0),r=async()=>{const f=await window.showOpenFilePicker({id:"market-dsc",multiple:!1,types:[{accept:{"application/dsc":[".dsc"]}}]});h.value=f.length,f.forEach(async m=>{const c=await m.getFile();try{const p=await n.decodeDSCFile(c,w.value);_.value+=p.lineCount;for(const[B,l]of p.dataMap){const u=i.subIdUserMap.get(B);u&&(u.phoneNumber=l,i.phoneNumberUserMap.set(l,u))}h.value--,g.value++,console.log(`[PhoneNumberFile] read ${p.lineCount} subid <> phone number`)}catch(p){alert(`解開 DSC 檔案發生錯誤: ${p}`)}})},$=()=>{g.value=0,_.value=0,i.phoneNumberUserMap.clear(),i.refreshFilted()};return(f,m)=>{const c=ze,p=A,B=we,l=_e;return v(),T("div",Xt,[es,C("div",ts,[ss,e(c,{type:"password",id:"pw",modelValue:w.value,"onUpdate:modelValue":m[0]||(m[0]=u=>w.value=u)},null,8,["modelValue"])]),C("div",ns,[e(p,{variant:"outline-primary",size:"sm",onClick:r,disabled:!w.value||j(i).isUserEmpty},{default:t(()=>[a("匯入")]),_:1},8,["disabled"]),_.value>0&&!L.value?(v(),D(p,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:$},{default:t(()=>[e(B)]),_:1})):O("",!0),L.value?(v(),D(l,{key:1,variant:"primary",class:"ms-1"})):O("",!0)]),g.value?(v(),T("small",os,"已讀取 "+b(g.value)+" 檔案, "+b(_.value)+" 筆記錄",1)):O("",!0)])}}}),ls={class:"title-wrapper"},as=C("label",{for:"compaign-name"},"活動名稱",-1),fs=W({__name:"CampaignName",setup(U){const s=Z(),n=k("");return Fe(()=>{const i=localStorage.getItem("campaign-name");i&&(n.value=i)}),ne(n,i=>{localStorage.setItem("campaign-name",i),s.campaignName=i}),(i,h)=>{const g=ze;return v(),T("div",ls,[as,e(g,{modelValue:n.value,"onUpdate:modelValue":h[0]||(h[0]=_=>n.value=_),type:"text",id:"compaign-name",class:"ms-2"},null,8,["modelValue"])])}}});export{we as _,fs as a,_s as b,ps as c,ms as d,ds as e};
