import{o as _,a as T,b as $,d as Z,u as W,r as k,c as V,w as re,P as ue,e,f as t,i as D,j as O,g as l,t as b,q as Ue,s as ke,v as Te,S as Pe,x as Ae,k as A,y as Re,p as je,l as _e,H as fe,m as He,F as ne,h as j,z as oe,A as Ge,C as Oe,E as Ye,B as Ze,Q as We,D as qe,G as ve,I as he,O as ge,J as be,K as Se,L as Le,M as Je,N as ce,R as Qe,U as Ce,T as Ke,V as Be,W as Xe,n as Fe,X as et,Y as tt,Z as st}from"./index-nLyFgQjX.js";import{_ as xe}from"./download-k__T3b8W.js";import{_ as nt}from"./delete-outline-refY5Mpb.js";const ot={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},lt=$("path",{fill:"currentColor",d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"},null,-1),at=[lt];function it(U,s){return _(),T("svg",ot,[...at])}const $e={name:"mdi-close",render:it},ut={class:"export-sms-file"},ct=$("span",null,"門號 (商務簡訊)",-1),rt={key:0,class:"ms-4 mt-2"},dt={class:"d-flex mt-2 align-items-center w-100"},mt={key:0,class:"hint"},pt={class:"d-flex justify-content-between w-100"},_t={class:"d-flex align-items-center"},ft={class:"d-flex align-items-center"},vt=Z({__name:"ExportSmsFile",props:{disabled:{type:Boolean}},setup(U){const s=U,n=W(),i=k(!1),h=k([]),L=k([]),v=k(0),G=k(0),x=k(new Set),m=k([]),f=k(0),u=k(!1),c=V(()=>({text:`匯入 91 優惠券 (${p.value} 人缺優惠券)`,value:"upload-file"})),r=V(()=>{const w=Array.from(n.userArgSet).map(C=>({text:C,value:C}));return w.push(c.value),w}),g=V(()=>h.value.findIndex(w=>w===c.value.value)>=0);re(L,()=>{v.value=L.value.length,L.value.forEach(w=>F(w))});const F=w=>{u.value=!0,ue.parse(w,{header:!0,skipEmptyLines:!0,encoding:"big5",transformHeader:(C,E)=>(console.log(`Header: ${E}`,C),C==="領取券號"?"couponCode":C==="是否領取"?"isRedeem":C),complete:C=>{if(C.errors.length>0){alert("Parse Error"),u.value=!1;return}const E=m.value.length;C.data.forEach(B=>{if(B.isRedeem.indexOf("否")===-1){console.log(`[ExportSmsFile] Coupon Code redeem: ${B.couponCode} -> ${B.isRedeem}`);return}if(x.value.has(B.couponCode)){console.log(`[ExportSmsFile] Coupon Code duplicated: ${B.couponCode}`);return}x.value.add(B.couponCode),m.value.push(B.couponCode)});const M=m.value.length;console.log(`[ExportSmsFile] read ${C.data.length} -> ${M-E} coupon Code`),v.value--,G.value++,u.value=!1}})},a=V(()=>v.value>0),d=()=>{p.value=y(),i.value=!0},p=k(0),y=()=>{let w=0;return console.log(`[ExportSmsFile] noCouponCodeCount, smsGroupList: ${n.smsGroupList.length}`),n.smsGroupList.forEach(C=>{console.log(`[ExportSmsFile] noCouponCodeCount, smsSendInfoList: ${C.smsSendInfoList.length}`),C.smsSendInfoList.forEach(E=>{console.log(`[ExportSmsFile] noCouponCodeCount, phoneNumberList: ${E.phoneNumberList.length}`),E.phoneNumberList.forEach(M=>{const B=n.phoneNumberUserMap.get(M);(!B||!B.couponCode)&&w++})})}),w},z=async()=>{if(!I.value)return;u.value=!0;const w="export-sms-file-"+n.hashCode(n.campaignName);n.saveZip(I.value.fileName,I.value.downloadFileList,w),u.value=!1,i.value=!1},I=k(),o=()=>{u.value||(u.value=!0,I.value=S(),u.value=!1,alert("打包完成"))},S=()=>{f.value=0;const w=[],C=ke(new Date,"yyyyMMdd");let E=0,M=0;const B=n.smsGroupList,H=[],N=[],P=[];for(let le=0;le<B.length;le++){const X=B[le];let Ie=0;const ye=[];console.log(`[ExportSmsFile] smsGroup: ${X.name}: ${X.smsSendInfoList.length}`);for(let se=0;se<X.smsSendInfoList.length;se++){const de=X.smsSendInfoList[se];E++;const ee=K(de);M+=ee.length,Ie+=ee.length,console.log(`[ExportSmsFile] smsGroup: ${X.name}: [${se+1}] ${ee.length}`),P.push(ee.length);const me=n.partition(ee,5e3);for(let ae=0;ae<me.length;ae++){const pe=me[ae],Ee=ue.unparse(pe,{delimiter:"	"}),Ve=X.smsSendInfoList.length===1?"":`_${se+1}`,De=me.length===1?"":`_${ae+1}`,Ne=`${n.campaignName}_商務簡訊_${C}_${le+1}${Ve}${De}_${X.name}_${pe.length}.txt`;w.push({fileName:Ne,data:Ee}),H.push({smsText:de.text,phoneNumberFileName:Ne,smsCount:pe.length})}ye.push({smsText:de.text,smsCount:ee.length})}N.push({taName:X.name,smsCount:Ie,smsItemList:ye})}const Y={};Y.sendDate=Te().format("YYYY-MM-DD"),Y.sendHour=Pe.Hour20,Y.sendMinute=Ae.Minute00,Y.smsList=H,Y.smsGroupList=N;const J=`${n.campaignName}_商務簡訊_${C}_${B.length}受眾_${E}群_${M}.cfg`,Q=JSON.stringify(Y,null,4);w.push({fileName:J,data:Q});const Me=`${n.campaignName}_商務簡訊_${C}_${B.length}受眾_${E}群_${M}.zip`;return console.log(`受眾表用
${P.join(`
`)}`),{fileName:Me,downloadFileList:w}},R=new Set(["0979940180","0937654385","0937573896","0970646973","0980317712","0970008039","0905364116","0920693530","0920020856","0971068968"]),K=w=>{const C=[],E=w.phoneNumberList;for(let M=0;M<E.length;M++){const B=E[M];if(R.has(B))continue;const H=n.phoneNumberUserMap.get(B);if(!H)continue;const N=[B];for(let P=0;P<r.value.length;P++){const Y=r.value[P];if(h.value.findIndex(Q=>Q===Y.value)>=0)if(Y.value===c.value.value){let Q=H.couponCode;Q||(Q=m.value[f.value++]),Q?(H.couponCode=Q,N.push(Q)):N.push("")}else H.params&&N.push(H.params[Y.value])}C.push(N)}return C},q=()=>{L.value=[],G.value=0,m.value.length=0,x.value.clear()},te=V(()=>I.value?"primary":"outline-secondary");return(w,C)=>{const E=xe,M=A,B=Re,H=je,N=$e,P=_e,Y=fe;return _(),T("div",ut,[e(M,{variant:"outline-primary",size:"sm",onClick:d,disabled:s.disabled},{default:t(()=>[e(E),ct]),_:1},8,["disabled"]),e(Y,{modelValue:i.value,"onUpdate:modelValue":C[2]||(C[2]=J=>i.value=J),title:"參數",class:"args-modal",onClose:C[3]||(C[3]=J=>i.value=!1),onHide:C[4]||(C[4]=Ue(()=>{},["prevent"]))},{footer:t(()=>[$("div",pt,[$("div",_t,[u.value?(_(),D(P,{key:0})):O("",!0)]),$("div",ft,[e(M,{variant:"primary",size:"sm",onClick:o,disabled:u.value},{default:t(()=>[l("打包")]),_:1},8,["disabled"]),e(M,{variant:te.value,size:"sm",onClick:z,disabled:u.value||!I.value,class:"ml-2"},{default:t(()=>[l("匯出")]),_:1},8,["variant","disabled"])])])]),default:t(()=>[e(B,{modelValue:h.value,"onUpdate:modelValue":C[0]||(C[0]=J=>h.value=J),options:r.value,stacked:""},null,8,["modelValue","options"]),g.value?(_(),T("div",rt,[$("div",dt,[e(H,{modelValue:L.value,"onUpdate:modelValue":C[1]||(C[1]=J=>L.value=J),id:"dsc-file",accept:"text/csv",multiple:""},null,8,["modelValue"]),x.value.size>0&&!a.value?(_(),D(M,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:q},{default:t(()=>[e(N)]),_:1})):O("",!0),a.value?(_(),D(P,{key:1,variant:"primary",class:"ms-1"})):O("",!0)]),G.value?(_(),T("small",mt,"已讀取 "+b(G.value)+" 檔案, "+b(x.value.size)+" 筆記錄",1)):O("",!0)])):O("",!0)]),_:1},8,["modelValue"])])}}}),ht={class:"export-fb-device-id"},gt=$("span",null,"FB 自訂受眾",-1),bt=Z({__name:"ExportFbAudience",props:{disabled:{type:Boolean}},setup(U){const s=U,n=W(),i=async()=>{const h=new Set;n.smsGroupList.forEach(G=>{G.smsPhoneNumberFilted.forEach(x=>{const m=n.phoneNumberUserMap.get(x);m&&m.deviceId&&h.add(m.deviceId)})});const L=`madid
`+Array.from(h).join(`
`),v=new File([L],"fb-device-id.csv",{type:"text/csv"});await window.showSaveFilePicker({id:"market-fb-audience-export",suggestedName:`${n.campaignName}_FB 自訂受眾_${Te().format("YYYYMMDD")}_${h.size}筆.csv`,types:[{accept:{"text/csv":[".csv"]}}]}).then(async G=>{const x=await G.createWritable();await x.write(v),await x.close()})};return(h,L)=>{const v=xe,G=A;return _(),T("div",ht,[e(G,{variant:"outline-primary",size:"sm",onClick:i,disabled:s.disabled},{default:t(()=>[e(v),gt]),_:1},8,["disabled"])])}}}),St={class:"icon",viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"},Lt=$("path",{fill:"currentColor",d:"M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 2v4h10V4zm0 6v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2zm-8 4v2h2v-2zm4 0v2h2v-2zm4 0v2h2v-2z"},null,-1),Ct=[Lt];function xt(U,s){return _(),T("svg",St,[...Ct])}const we={name:"mdi-calculator",render:xt},$t={key:0,class:"sms-send"},wt=$("h6",{class:"title"},"分群測試",-1),It={class:"section"},yt=$("h6",{class:"title"},"簡訊內容",-1),Nt={class:"sms-item section"},kt={class:"sms-header"},Tt=["for"],Gt={class:"count"},Bt={class:"sms-footer"},Ft=Z({__name:"SmsSendModal",props:{smsGroup:{}},setup(U){const s=He(),n=W(),i=U,h=k(!1),L=k(1),v=k(["","",""]),G=r=>{const g=i.smsGroup.smsPhoneNumberFilted;if(g.length===0)return[];const F=Math.ceil(g.length/L.value);return n.partition(g,F)[r]},x=()=>{L.value=Math.max(i.smsGroup.smsSendInfoList.length,1),console.log(`[SmsSendModal] smsTestGroupCount: ${L.value}`),v.value.length=0,i.smsGroup.smsSendInfoList.forEach(r=>{v.value.push(r.text)}),h.value=!0},m=()=>{if(!i.smsGroup)return;const r=v.value.splice(0,L.value);n.fillSmsSendInfo(i.smsGroup,r),s.setSmsText(i.smsGroup.name,r)},f=r=>r?r.length:0,u=r=>{const g=f(v.value[r]);return g===0?null:g<=70},c=async(r,g)=>{g.phoneNumber&&await n.sms(g.phoneNumber,v.value[r])};return(r,g)=>{const F=A,a=Oe,d=Ye,p=Ze,y=We,z=qe,I=fe;return i.smsGroup?(_(),T("div",$t,[e(F,{variant:"outline-primary",size:"sm",onClick:x,disabled:i.smsGroup.smsPhoneNumberFilted.length===0},{default:t(()=>[$("span",null,"編輯 ("+b(i.smsGroup.smsSendInfoList.length)+")",1)]),_:1},8,["disabled"]),e(I,{modelValue:h.value,"onUpdate:modelValue":g[1]||(g[1]=o=>h.value=o),size:"lg","ok-title":"確定","cancel-title":"取消","cancel-variant":"outline-secondary",onOk:m,class:"sms-send-modal"},{default:t(()=>[$("section",null,[wt,$("div",It,[e(d,{modelValue:L.value,"onUpdate:modelValue":g[0]||(g[0]=o=>L.value=o),name:"sms-test-group"},{default:t(()=>[e(a,{value:1},{default:t(()=>[l("不測試")]),_:1}),e(a,{value:2},{default:t(()=>[l("2 群")]),_:1}),e(a,{value:3},{default:t(()=>[l("3 群")]),_:1}),e(a,{value:4},{default:t(()=>[l("4 群")]),_:1}),e(a,{value:5},{default:t(()=>[l("5 群")]),_:1}),e(a,{value:6},{default:t(()=>[l("6 群")]),_:1})]),_:1},8,["modelValue"])])]),$("section",null,[yt,(_(!0),T(ne,null,oe(L.value,o=>(_(),T("div",Nt,[$("div",kt,[$("label",{for:`sms-text-${o}`},"簡訊 "+b(o),9,Tt),$("span",Gt,b(G(o-1).length)+" 人",1)]),e(p,{type:"text",size:"sm",id:`sms-text-${o}`,rows:"2",state:u(o-1),placeholder:"簡訊文案",modelValue:v.value[o-1],"onUpdate:modelValue":S=>v.value[o-1]=S},null,8,["id","state","modelValue","onUpdate:modelValue"]),$("div",Bt,[e(z,{right:"",variant:"outline-primary",size:"sm",text:"測試"},{default:t(()=>[(_(!0),T(ne,null,oe(j(n).userInfoListTest,S=>(_(),D(y,{onClick:R=>c(o-1,S),key:S.twmId},{default:t(()=>[l(b(S.params.name),1)]),_:2},1032,["onClick"]))),128))]),_:2},1024),$("span",{class:Ge(["sms-text",{warn:f(v.value[o-1])>70}])},b(f(v.value[o-1]))+" 個字 ",3)])]))),256))])]),_:1},8,["modelValue"])])):O("",!0)}}}),zt={key:0,class:"ta-group-list-modal number"},Mt={key:0,class:""},Et={class:"summary"},ie=100,ze=Z({__name:"TaGroupListModal",props:{twmIdList:{},phoneNumberList:{}},setup(U){const s=W(),n=U,i=k(!1),h=k(1),L=()=>{i.value=!0},v=V(()=>{var c,r;return((c=n.twmIdList)==null?void 0:c.length)||((r=n.phoneNumberList)==null?void 0:r.length)||0}),G=V(()=>{const c=[];if(!i.value)return c;const r=(h.value-1)*ie;return m.value.slice(r,r+ie)}),x=c=>ie*(h.value-1)+c+1,m=V(()=>{const c=[];return i.value&&(console.time("[TaGroupListModal] allUserList"),n.twmIdList&&n.twmIdList.length>0?n.twmIdList.forEach(r=>{const g=s.twmIdUserMap.get(r);g&&c.push(g)}):n.phoneNumberList&&n.phoneNumberList.length>0&&n.phoneNumberList.forEach(r=>{const g=s.phoneNumberUserMap.get(r);g&&c.push(g)}),console.timeEnd("[TaGroupListModal] allUserList")),c}),f=V(()=>i.value?m.value.filter(c=>!!c.phoneNumber).length:0),u=V(()=>i.value?m.value.filter(c=>!!c.couponCode).length:0);return(c,r)=>{const g=A,F=ve,a=he,d=ge,p=be,y=Se,z=Le,I=Je,o=fe;return n.twmIdList||n.phoneNumberList?(_(),T("div",zt,[v.value===0?(_(),T("span",Mt,"0")):(_(),D(g,{key:1,variant:"link",onClick:L,class:""},{default:t(()=>[l(b(v.value),1)]),_:1})),e(o,{modelValue:i.value,"onUpdate:modelValue":r[1]||(r[1]=S=>i.value=S),scrollable:"",size:"lg",title:"使用者詳情",class:"ta-list-modal"},{default:t(()=>[$("div",Et,[l(" 總數："),$("span",null,b(v.value)+"，有門號："+b(f.value)+" (少 "+b(f.value-v.value)+")，有優惠券："+b(u.value)+" (少 "+b(u.value-v.value)+")",1)]),e(z,{hover:"",small:"",bordered:""},{default:t(()=>[e(d,null,{default:t(()=>[e(a,null,{default:t(()=>[e(F,{class:"text-center align-middle"},{default:t(()=>[l("No")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("台灣大會員編號")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("SubId")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("門號")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("資費")]),_:1}),e(F,{class:"text-center align-middle"},{default:t(()=>[l("優惠券序號")]),_:1})]),_:1})]),_:1}),e(y,null,{default:t(()=>[(_(!0),T(ne,null,oe(G.value,(S,R)=>(_(),D(a,{key:S.twmId},{default:t(()=>[e(p,{class:"text-center align-middle"},{default:t(()=>[l(b(x(R)),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(b(S.twmId),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(b(S.subId),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(b(S.phoneNumber),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(b(S.params["目前方案專案V+D+V資費"]),1)]),_:2},1024),e(p,{class:"text-center align-middle number"},{default:t(()=>[l(b(S.couponCode),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(I,{modelValue:h.value,"onUpdate:modelValue":r[0]||(r[0]=S=>h.value=S),size:"sm","total-rows":v.value,"per-page":ie},null,8,["modelValue","total-rows"])]),_:1},8,["modelValue"])])):O("",!0)}}}),Vt={class:"calc-button"},Dt={key:1,class:"number"},Ut=Z({__name:"CalcButton",setup(U){const s=W(),n=()=>{s.refresh()};return(i,h)=>{const L=we,v=A,G=Ce;return _(),T("div",Vt,[j(s).needReCalc?ce((_(),D(v,{key:0,variant:"outline-success",size:"sm",onClick:n},{default:t(()=>[e(L)]),_:1})),[[G,"重新計算"]]):(_(),T("div",Dt,[Qe(i.$slots,"default")]))])}}}),Pt={class:"d-flex flex-column justify-content-end"},At=$("br",null,null,-1),Rt=$("span",{class:"hint"},"(商務簡訊)",-1),jt={class:"text-nowrap"},Ht={key:1},Ot={class:"text-nowrap"},Yt=$("div",{class:"d-flex flex-column"},null,-1),Zt={class:"d-flex flex-column"},Wt=$("span",null,"SubId (DSC)",-1),cs=Z({__name:"SmsGroupList",setup(U){const s=W(),n=k(!0),i=k(0),h=()=>{if(!s.smsGroupList)return n.value=!1,0;console.time("[SmsGroupList] TotalSubIdCount");const a=new Set;for(let d=0;d<s.smsGroupList.length;d++){const y=s.smsGroupList[d].twmIdList;for(let z=0;z<y.length;z++){const I=y[z];a.add(I)}}console.timeEnd("[SmsGroupList] TotalSubIdCount"),n.value=!1,i.value=a.size},L=V(()=>{let a=0;return s.smsGroupList.forEach(d=>a+=d.smsTwmIdListFilted.length),a}),v=V(()=>{let a=0;return s.smsGroupList.forEach(d=>a+=d.smsPhoneNumberFilted.length),a}),G=V(()=>{let a=0;return s.smsGroupList.forEach(d=>a+=d.tamiDeviceIdCount),a}),x=(a,d)=>{const p=a.smsReadyTwmIdList;if(d>=100)a.smsTwmIdList=p.slice(0);else{const y=new Set;a.smsTwmIdList.forEach(o=>y.add(o));const z=p.length*d/100,I=f(p).slice(0,z);I.forEach(o=>y.add(o)),a.smsTwmIdList=Array.from(y),console.log(`[GroupList] addSmsList: ${z}: ${I.length}`)}s.refreshFilted()},m=a=>{for(let d=0;d<s.smsGroupList.length;d++){const p=s.smsGroupList[d];x(p,a)}},f=a=>{const d=a.slice(0);for(let p=d.length-1;p>0;p--){let y=Math.floor(Math.random()*(p+1));[d[p],d[y]]=[d[y],d[p]]}return d},u=a=>{const d=s.smsGroupList.findIndex(y=>y.name===a.name);d>=0&&s.smsGroupList.splice(d,1);const p=new Ke(a.name,a.twmIdList);s.groupList.push(p),s.refreshFilted(),n.value=!0},c=()=>{r(a=>a.smsTwmIdListFilted)},r=a=>{if(!s.smsGroupList)return;const d=[],p=new Set;for(let S=0;S<s.smsGroupList.length;S++){const R=s.smsGroupList[S],K=a(R);for(let q=0;q<K.length;q++){const te=K[q],w=s.twmIdUserMap.get(te);!w||!w.subId||w.phoneNumber&&w.phoneNumber.length>0||p.has(w.subId)||(p.add(w.subId),d.push({SUBSCR_ID:w.subId}))}}console.log(`[SmsGroupList] export ${d.length} subId`);const y=ke(new Date,"yyyyMMdd"),z=[],I=s.partition(d,1e5);for(let S=0;S<I.length;S++){const R=I[S],K=`${s.campaignName}_DSC_SubId_${y}_${I.length}-${S+1}_${R.length}.csv`,q=ue.unparse(R);z.push({fileName:K,data:q})}const o=`${s.campaignName}_DSC_SubId_${y}_${I.length}份_共${d.length}筆.zip`;s.downloadZip(o,z)},g=a=>a.smsReadyTwmIdList.length<=a.smsTwmIdList.length,F=()=>{for(let a=0;a<s.smsGroupList.length;a++){const d=s.smsGroupList[a];if(!g(d))return!1}return!0};return(a,d)=>{const p=ve,y=he,z=ge,I=nt,o=be,S=Ut,R=ze,K=Ft,q=Se,te=we,w=xe,C=bt,E=vt,M=Be,B=Le,H=Ce;return _(),T("div",Pt,[e(B,{hover:"",small:"",bordered:""},{default:t(()=>[e(z,{"head-variant":"dark"},{default:t(()=>[e(y,null,{default:t(()=>[e(p,{class:"text-center align-middle"},{default:t(()=>[l("刪除")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("分群")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("原數量")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("已發送數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("可發送數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("發送")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("欲發送數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("發送數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("門號數"),At,Rt]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("Device ID 數")]),_:1}),e(p,{class:"text-center align-middle"},{default:t(()=>[l("簡訊內容")]),_:1})]),_:1})]),_:1}),e(q,null,{default:t(()=>[(_(!0),T(ne,null,oe(j(s).smsGroupList,N=>(_(),D(y,{key:N.name},{default:t(()=>[e(o,{class:"text-center align-middle"},{default:t(()=>[e(j(A),{variant:"outline-danger",size:"sm",onClick:P=>u(N)},{default:t(()=>[e(I)]),_:2},1032,["onClick"])]),_:2},1024),e(p,{class:"align-middle"},{default:t(()=>[l(b(N.name),1)]),_:2},1024),e(o,{class:"text-end align-middle number"},{default:t(()=>{var P;return[l(b((P=N.twmIdList)==null?void 0:P.length),1)]}),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[l(b(N.sentCount),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[e(R,{"twm-id-list":N.smsReadyTwmIdList},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[$("div",jt,[e(j(A),{variant:"outline-primary",size:"sm",onClick:P=>x(N,10),disabled:g(N)},{default:t(()=>[l("+10%")]),_:2},1032,["onClick","disabled"]),e(j(A),{variant:"outline-primary",size:"sm",onClick:P=>x(N,100),class:"ms-1",disabled:g(N)},{default:t(()=>[l("All")]),_:2},1032,["onClick","disabled"])])]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(R,{"twm-id-list":N.smsTwmIdList},null,8,["twm-id-list"])]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[e(R,{"twm-id-list":N.smsTwmIdListFilted},null,8,["twm-id-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[e(R,{"phone-number-list":N.smsPhoneNumberFilted},null,8,["phone-number-list"])]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(S,null,{default:t(()=>[l(b(N.tamiDeviceIdCount),1)]),_:2},1024)]),_:2},1024),e(o,{class:"text-center align-middle"},{default:t(()=>[e(K,{"sms-group":N},null,8,["sms-group"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(M,null,{default:t(()=>[e(y,null,{default:t(()=>[e(o),e(o,null,{default:t(()=>[l("共 "+b(j(s).smsGroupList.length)+" 群",1)]),_:1}),e(o,{class:Ge({"text-center":n.value,number:!n.value})},{default:t(()=>[n.value?ce((_(),D(j(A),{key:0,variant:"outline-success",size:"sm",onClick:h},{default:t(()=>[e(te)]),_:1})),[[H,"重新計算"]]):(_(),T("span",Ht,b(i.value),1))]),_:1},8,["class"]),e(o),e(o),e(o,null,{default:t(()=>[$("div",Ot,[e(j(A),{variant:"outline-primary",size:"sm",onClick:d[0]||(d[0]=N=>m(10)),disabled:F()},{default:t(()=>[l("+10%")]),_:1},8,["disabled"]),e(j(A),{variant:"outline-primary",size:"sm",onClick:d[1]||(d[1]=N=>m(100)),class:"ms-1",disabled:F()},{default:t(()=>[l("All")]),_:1},8,["disabled"])])]),_:1}),e(o),e(o,{class:"text-center number"},{default:t(()=>[e(S,null,{default:t(()=>[l(b(L.value),1)]),_:1})]),_:1}),e(o,{class:"text-center number"},{default:t(()=>[e(S,null,{default:t(()=>[l(b(v.value),1)]),_:1})]),_:1}),e(o,{class:"text-center number"},{default:t(()=>[e(S,null,{default:t(()=>[l(b(G.value),1)]),_:1})]),_:1}),e(o)]),_:1}),e(y,null,{default:t(()=>[e(o),e(o),e(o,{class:"text-center"},{default:t(()=>[Yt]),_:1}),e(o),e(o),e(o),e(o),e(o,{class:"text-center"},{default:t(()=>[$("div",Zt,[ce((_(),D(j(A),{variant:"outline-primary",size:"sm",onClick:c,disabled:L.value<=0},{default:t(()=>[e(w),Wt]),_:1},8,["disabled"])),[[H,`匯出 ${L.value-v.value} 筆沒有電話號碼的 SubID (DSC 用)`,void 0,{hover:!0,top:!0}]])])]),_:1}),e(o,{class:"text-center align-middle"}),e(o,null,{default:t(()=>[e(C,{disabled:G.value===0},null,8,["disabled"])]),_:1}),e(o,{class:"text-center align-middle"},{default:t(()=>[e(E,{class:"mt-1",disabled:v.value<=0},null,8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})])}}}),qt={key:1,class:"number"},rs=Z({__name:"TaGroupList",setup(U){const s=W(),n=k(!0),i=k(0),h=V(()=>s.groupList?s.groupList.sort((x,m)=>x.name.localeCompare(m.name)):[]),L=()=>{if(!s.groupList)return n.value=!1,0;console.time("[TaGroupList] TotalSubIdCount");const x=new Set;for(let m=0;m<s.groupList.length;m++){const u=s.groupList[m].twmIdList;for(let c=0;c<u.length;c++){const r=u[c];x.add(r)}}console.timeEnd("[TaGroupList] TotalSubIdCount"),i.value=x.size,n.value=!1},v=x=>{const m=s.groupList.findIndex(u=>u.name===x.name);m>=0&&s.groupList.splice(m,1),console.time("[TaGroupList] addSmsList");const f=new Xe(x.name,x.twmIdList);console.timeEnd("[TaGroupList] addSmsList"),s.smsGroupList.push(f),s.refreshFilted()},G=()=>{[...s.groupList].forEach(m=>v(m))};return(x,m)=>{const f=ve,u=he,c=ge,r=ze,g=be,F=A,a=Se,d=we,p=Be,y=Le,z=Ce;return _(),T("div",null,[e(y,{hover:"",small:"",bordered:""},{default:t(()=>[e(c,{"head-variant":"dark"},{default:t(()=>[e(u,null,{default:t(()=>[e(f,{class:"text-center align-middle"},{default:t(()=>[l("分群")]),_:1}),e(f,{class:"text-center align-middle"},{default:t(()=>[l("數量")]),_:1}),e(f,{class:"text-center align-middle"},{default:t(()=>[l("加入發送")]),_:1})]),_:1})]),_:1}),e(a,null,{default:t(()=>[(_(!0),T(ne,null,oe(h.value,I=>(_(),D(u,{key:I.name},{default:t(()=>[e(f,{class:"align-middle"},{default:t(()=>[l(b(I.name),1)]),_:2},1024),e(g,{class:"text-center align-middle"},{default:t(()=>[e(r,{"twm-id-list":I.twmIdList},null,8,["twm-id-list"])]),_:2},1024),e(f,{class:"text-center"},{default:t(()=>[e(F,{variant:"outline-primary",size:"sm",onClick:o=>v(I)},{default:t(()=>[l("加入")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1}),e(p,null,{default:t(()=>[e(u,null,{default:t(()=>[e(g,null,{default:t(()=>[l("共 "+b(h.value.length)+" 群",1)]),_:1}),e(g,{class:"text-center"},{default:t(()=>[n.value?ce((_(),D(F,{key:0,variant:"outline-success",size:"sm",onClick:L},{default:t(()=>[e(d)]),_:1})),[[z,"重新計算"]]):(_(),T("span",qt,b(i.value),1))]),_:1}),e(g,{class:"text-center"},{default:t(()=>[e(F,{variant:"outline-primary",size:"sm",onClick:m[0]||(m[0]=I=>G())},{default:t(()=>[l("加入")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})])}}}),Jt={class:"sms-file-wrapper"},Qt=$("label",{for:"sms-file"},"已發送簡訊 (多選)",-1),Kt={class:"d-flex mt-2 align-items-center w-100"},Xt={key:0,class:"hint"},ds=Z({__name:"ImportSmsSent",setup(U){const s=W(),n=k(0),i=k(0),h=k(0);re(n,(m,f)=>{m===0&&f>0&&s.refreshFilted()});const L=V(()=>n.value>0),v=async()=>{const m=await window.showOpenFilePicker({id:"market-sms-sent-"+s.hashCode(s.campaignName),multiple:!0,types:[{accept:{"text/plain":[".txt"]}}]});n.value=m.length,m.forEach(async f=>{const c=await(await f.getFile()).text();G(c)})},G=m=>{const f=m==null?void 0:m.split(`
`),u=s.phoneNumberSentSet.size;h.value+=f.length,f.forEach(r=>{const F=r.split("	")[0];s.phoneNumberSentSet.add(F)});const c=s.phoneNumberSentSet.size;console.log(`[SmsFile] load ${c-u} Sent Phone Numbers, Total: ${s.phoneNumberSentSet.size}`),n.value--,i.value++},x=()=>{i.value=0,h.value=0,s.phoneNumberSentSet.clear(),s.refreshFilted()};return(m,f)=>{const u=A,c=$e,r=_e;return _(),T("div",Jt,[Qt,$("div",Kt,[e(u,{variant:"outline-primary",size:"sm",onClick:v},{default:t(()=>[l("匯入")]),_:1}),h.value>0&&!L.value?(_(),D(u,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:x},{default:t(()=>[e(c)]),_:1})):O("",!0),L.value?(_(),D(r,{key:1,variant:"primary",class:"ms-1"})):O("",!0)]),i.value>0?(_(),T("small",Xt,b(i.value)+" 檔案, "+b(h.value)+" 筆記錄, 重複 "+b(h.value-j(s).phoneNumberSentSet.size)+" 門號, "+b(j(s).phoneNumberSentSet.size)+" 門號",1)):O("",!0)])}}}),es={class:"import-dsc-wrapper"},ts=$("label",{for:"dsc-file"},"門號 (DSC 轉出 csv)",-1),ss={class:"d-flex mt-2 align-items-center w-100"},ns={key:0,class:"hint"},ms=Z({__name:"ImportDSC",setup(U){const s=W(),n=k(0),i=k(0),h=k(0);Fe(async()=>{}),re(n,(f,u)=>{f===0&&u>0&&s.refreshFilted()});const L=V(()=>n.value>0),v=async()=>{const f=await window.showOpenFilePicker({id:"market-dsc",multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]});n.value=f.length,f.forEach(async u=>{const r=await(await u.getFile()).arrayBuffer(),g=et.decode(tt.Buffer.from(r),"big5");G(g)})},G=f=>{ue.parse(f,{header:!0,skipEmptyLines:!0,transformHeader:(u,c)=>(console.log(`Header: ${c}`,u),u==="門號"?"phoneNumber":u==="SUBSCR_ID"?"subId":u),complete:u=>{if(u.errors.length>0){alert("Parse Error"),n.value--,i.value++;return}const c=u.data;x(c),n.value--,i.value++}})},x=f=>{h.value+=f.length,f.forEach(u=>{const c=s.subIdUserMap.get(u.subId);c&&(c.phoneNumber=u.phoneNumber,s.phoneNumberUserMap.set(u.phoneNumber,c))}),console.log(`[PhoneNumberFile] read ${f.length} subid <> phone number`)},m=()=>{i.value=0,h.value=0,s.phoneNumberUserMap.clear(),s.refreshFilted()};return(f,u)=>{const c=A,r=$e,g=_e;return _(),T("div",es,[ts,$("div",ss,[e(c,{variant:"outline-primary",size:"sm",onClick:v,disabled:j(s).isUserEmpty},{default:t(()=>[l("匯入")]),_:1},8,["disabled"]),h.value>0&&!L.value?(_(),D(c,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:m},{default:t(()=>[e(r)]),_:1})):O("",!0),L.value?(_(),D(g,{key:1,variant:"primary",class:"ms-1"})):O("",!0)]),i.value?(_(),T("small",ns,"已讀取 "+b(i.value)+" 檔案, "+b(h.value)+" 筆記錄",1)):O("",!0)])}}}),os={class:"title-wrapper"},ls=$("label",{for:"compaign-name"},"活動名稱",-1),ps=Z({__name:"CampaignName",setup(U){const s=W(),n=k("");return Fe(()=>{const i=localStorage.getItem("campaign-name");i&&(n.value=i)}),re(n,i=>{localStorage.setItem("campaign-name",i),s.campaignName=i}),(i,h)=>{const L=st;return _(),T("div",os,[ls,e(L,{modelValue:n.value,"onUpdate:modelValue":h[0]||(h[0]=v=>n.value=v),type:"text",id:"compaign-name",class:"ms-2"},null,8,["modelValue"])])}}});export{$e as _,ps as a,ms as b,ds as c,rs as d,cs as e};
