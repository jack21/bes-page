import{_ as E,a as M,b as A,c as R,d as P,e as U}from"./CampaignName.vue_vue_type_style_index_0_lang-8Esa-V2m.js";import{d as L,u as S,r as h,w as N,c as x,o as _,a as y,b as g,e as m,f as $,g as G,h as B,i as b,j as I,t as k,p as C,k as V,P as z,T as D,S as H,l as O,_ as j,m as W,y as q,n as J,q as K}from"./index-yJRNPwA5.js";import"./download-lUU2CSuZ.js";import"./delete-outline-JDy_see7.js";const Q={class:"sms-file-wrapper"},X=g("label",{for:"sms-file"},"TAMI DeviceID (多選)",-1),Y={class:"d-flex mt-2 align-items-center w-100"},Z={key:0,class:"hint"},ee=L({__name:"ImportTamiDeviceId",setup(T){const t=S(),r=h(0),p=h(0),d=h(0),v=h(0);N(r,(s,n)=>{s===0&&n>0&&t.refreshFilted()});const w=x(()=>r.value>0),i=async()=>{const s=await window.showOpenFilePicker({id:"market-tami-deviceid-"+t.hashCode(t.campaignName),multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]});!s||s.length===0||(r.value=s.length,s.forEach(async n=>{const c=await(await n.getFile()).text();e(c)}))},e=s=>{const n=s.split(`
`);d.value+=n.length;let a=n.map(c=>{const u=c.split(",");return{subId:u[1],deviceId:u[2]}});a=a.filter(c=>c.deviceId&&c.deviceId!=="00000000-0000-0000-0000-000000000000"),v.value+=a.length,a.forEach(c=>{const u=t.subIdUserMap.get(c.subId);u&&(u.deviceId=c.deviceId)}),console.log(`[SmsFile] load ${a.length}`),r.value--,p.value++},o=()=>{p.value=0,d.value=0,t.phoneNumberSentSet.clear(),t.refreshFilted()};return(s,n)=>{const a=C,c=E,u=V;return _(),y("div",Q,[X,g("div",Y,[m(a,{variant:"outline-primary",size:"sm",onClick:i,disabled:B(t).isUserEmpty},{default:$(()=>[G("匯入")]),_:1},8,["disabled"]),d.value>0&&!w.value?(_(),b(a,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:o},{default:$(()=>[m(c)]),_:1})):I("",!0),w.value?(_(),b(u,{key:1,variant:"primary",class:"ms-1"})):I("",!0)]),p.value>0?(_(),y("small",Z,k(p.value)+" 檔案, "+k(d.value)+" 筆記錄, 有效 "+k(v.value)+" 筆 Device ID ",1)):I("",!0)])}}}),te={class:"ta-file-wrapper"},se=g("label",{for:"ta-file"},"受眾 (BOE 匯出 csv)",-1),oe={class:"d-flex mt-2 align-items-center w-100"},ne={key:0,class:"hint"},ae=L({__name:"ImportTa",setup(T){const t=S(),r=h(0),p=h(0),d=async()=>{(await window.showOpenFilePicker({id:"market-import-ta-"+t.hashCode(t.campaignName),multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]})).forEach(async e=>{const s=await(await e.getFile()).text();v(s)})},v=i=>{z.parse(i,{header:!0,skipEmptyLines:!0,transformHeader:(e,o)=>(console.log(`Header: ${o}`,e),e==="特定用戶名單(TAMI專用)"?"groupName":e.startsWith("Subscr Id")?"subId":e==="台灣大會員編號"?"twmId":(e.startsWith('"')||t.userArgSet.add(e),e)),complete:e=>{if(e.errors.length>0){alert("Parse Error");return}console.log(`[TaFile] add ${e.data.length} Users begin`),p.value+=e.data.length;for(let o=0;o<e.data.length;o++){const s=e.data[o],n={};t.userArgSet.forEach(a=>{n[a]=s[a]}),t.addUser(s.twmId,s.subId,void 0,n)}console.log(`[TaFile] add ${e.data.length} Users Complete`),t.groupList.push(...w(e.data)),r.value+=t.groupList.length,console.log(`[TaFile] complete ${t.groupList.length} TaGroup`)}})},w=i=>{const e=new Map;return i.forEach(o=>{let s;e.has(o.groupName)?s=e.get(o.groupName):(s=new D(o.groupName),e.set(o.groupName,s)),s==null||s.addTwmId(o.twmId)}),Array.from(e.values())};return(i,e)=>{const o=C;return _(),y("div",te,[se,g("div",oe,[m(o,{variant:"outline-primary",size:"sm",onClick:d},{default:$(()=>[G("匯入")]),_:1})]),p.value>0?(_(),y("small",ne," 載入 "+k(r.value)+" 群, "+k(p.value)+" 筆記錄, "+k(B(t).userArgSet.size)+" 參數 ",1)):I("",!0)])}}}),ie={class:"campaign-config-wrapper"},ce=g("span",null,"匯出設定檔",-1),re=g("span",null,"匯入設定檔",-1),le=L({__name:"MarketingConfigFile",setup(T){const t=S(),r=h(),p=h(null);N(r,()=>{r.value&&d(r.value)});const d=i=>{const e=new FileReader;e.onload=function(o){var u;const s=(u=o.target)==null?void 0:u.result,n=JSON.parse(s);t.campaignName=n.name;const a=new Map;n.groupList.forEach(l=>a.set(l.name,l)),t.groupList.length=0,n.taGroupNameList.forEach(l=>{const f=a.get(l);f&&t.groupList.push(new D(f.name,f.twmIdList))}),t.smsGroupList.length=0,n.smsGroupNameList.forEach(l=>{const f=a.get(l);if(f){const F=new H(f.name,f.twmIdList);F.smsTwmIdList=f.smsTwmIdList.slice(0),t.smsGroupList.push(F)}}),n.userInfoList.slice(0).forEach(l=>{l.subId&&l.subId.length>0&&t.subIdUserMap.set(l.subId,l),l.twmId&&l.twmId.length>0&&t.twmIdUserMap.set(l.twmId,l)}),t.refreshFilted()},e.readAsText(i)},v=async()=>{var i;[i]=await window.showOpenFilePicker({multiple:!0,types:[{description:"Images",accept:{"image/*":[".png",".gif",".jpeg",".jpg"]}}]}),console.log(i);const e=await i.getFile();console.log(e);const o=await e.text();console.log(o)},w=async()=>{const o=`http://bizsms.taiwanmobile.com:18994/send.cgi?username=VCST011400&password=7499639952&rateplan=A&srcaddr=8708246&dstaddr=0932087196&smbody=${encodeURI(`⏰台灣大%field1%資費用戶
符合您59折資格4h後結束！日本麗克特三明治機送18道食譜及環保袋https://twm5g.co/eoDP`)}`,{data:s}=await O.get(o);console.log(s)};return(i,e)=>{const o=j,s=C,n=W,a=q;return _(),y("div",ie,[m(s,{variant:"outline-primary",size:"sm",onClick:w,class:"ms-1"},{default:$(()=>[m(o),ce]),_:1}),m(s,{variant:"outline-primary",size:"sm",onClick:v,class:"ms-1"},{default:$(()=>[m(n),re]),_:1}),m(a,{ref_key:"configFileRef",ref:p,id:"import-campaign-config",modelValue:r.value,"onUpdate:modelValue":e[0]||(e[0]=c=>r.value=c),accept:"application/json"},null,8,["modelValue"])])}}}),me={class:"marketing"},pe=g("h1",null,"行銷管理小平台",-1),ue={class:"main"},de={class:"title-wrapper section"},_e={class:"file-wrapper"},ge={key:0,class:"main-wrapper section"},Ie=L({__name:"Marketing",setup(T){const t=S(),r=J();K(async()=>{await r.initDB()});const p=x(()=>t.groupList&&t.groupList.length>0),d=x(()=>t.smsGroupList&&t.smsGroupList.length>0);return(v,w)=>{const i=M,e=le,o=ae,s=A,n=R,a=ee,c=P,u=U;return _(),y("div",me,[pe,g("div",ue,[g("section",de,[m(i),m(e)]),g("section",_e,[m(o,{class:"section"}),m(s,{class:"section"}),m(n,{class:"section"}),m(a,{class:"section"})]),p.value||d.value?(_(),y("section",ge,[p.value?(_(),b(c,{key:0})):I("",!0),d.value?(_(),b(u,{key:1})):I("",!0)])):I("",!0)])])}}});export{Ie as default};
