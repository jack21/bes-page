import{_ as E,a as M,b as P,c as U,d as R,e as z}from"./CampaignName.vue_vue_type_style_index_0_lang-AfgJqcla.js";import{d as $,u as b,r as v,w as D,c as C,o as u,a as I,b as f,e as _,f as k,g as T,h as x,i as y,j as h,t as g,k as N,l as L,P as H,T as O,m as V,n as W}from"./index-vj19Cfrc.js";import"./download-J8OWICbF.js";import"./delete-outline-hLx0hhZc.js";const j={class:"import-coupon"},q=f("label",{for:"sms-file"},"已發送優惠券",-1),J={class:"d-flex mt-2 align-items-center w-100"},K={key:0,class:"hint"},Q=$({__name:"ImportCoupon",setup(S){const t=b(),r=v(0),c=v(0),l=v(0),p=v(0);D(r,(e,a)=>{e===0&&a>0&&t.refreshFilted()});const w=C(()=>r.value>0),d=async()=>{const e=await window.showOpenFilePicker({id:"market-import-coupon-"+t.hashCode(t.campaignName),multiple:!0,types:[{accept:{"text/plain":[".txt"]}}]});r.value=e.length,e.forEach(async a=>{const i=await(await a.getFile()).text();s(i)})},s=e=>{const a=e==null?void 0:e.split(`
`),n=p.value;l.value+=a.length,a.forEach(m=>{const F=m.split("	"),A=F[0],G=F[2].trim(),B=t.phoneNumberUserMap.get(A);B&&(B.couponCode=G,p.value++)});const i=p.value;console.log(`[SmsFile] load ${i-n} Sent Phone Numbers, Total: ${p.value}`),r.value--,c.value++},o=()=>{c.value=0,l.value=0,p.value=0,t.phoneNumberUserMap.forEach(e=>{e.couponCode=void 0}),t.refreshFilted()};return(e,a)=>{const n=N,i=E,m=L;return u(),I("div",j,[q,f("div",J,[_(n,{variant:"outline-primary",size:"sm",onClick:d,disabled:x(t).isUserEmpty},{default:k(()=>[T("匯入")]),_:1},8,["disabled"]),l.value>0&&!w.value?(u(),y(n,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:o},{default:k(()=>[_(i)]),_:1})):h("",!0),w.value?(u(),y(m,{key:1,variant:"primary",class:"ms-1"})):h("",!0)]),c.value>0?(u(),I("small",K,g(c.value)+" 檔案, "+g(l.value)+" 筆記錄, "+g(p.value)+" 有效優惠券",1)):h("",!0)])}}}),X={class:"sms-file-wrapper"},Y=f("label",{for:"sms-file"},"TAMI DeviceID (多選)",-1),Z={class:"d-flex mt-2 align-items-center w-100"},ee={key:0,class:"hint"},te=$({__name:"ImportTamiDeviceId",setup(S){const t=b(),r=v(0),c=v(0),l=v(0),p=v(0);D(r,(e,a)=>{e===0&&a>0&&t.refreshFilted()});const w=C(()=>r.value>0),d=async()=>{const e=await window.showOpenFilePicker({id:"market-tami-deviceid-"+t.hashCode(t.campaignName),multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]});!e||e.length===0||(r.value=e.length,e.forEach(async a=>{const i=await(await a.getFile()).text();s(i)}))},s=e=>{const a=e.split(`
`);l.value+=a.length;let n=a.map(i=>{const m=i.split(",");return{subId:m[1],deviceId:m[2]}});n=n.filter(i=>i.deviceId&&i.deviceId!=="00000000-0000-0000-0000-000000000000"),p.value+=n.length,n.forEach(i=>{const m=t.subIdUserMap.get(i.subId);m&&(m.deviceId=i.deviceId)}),console.log(`[SmsFile] load ${n.length}`),r.value--,c.value++},o=()=>{c.value=0,l.value=0,t.phoneNumberSentSet.clear(),t.refreshFilted()};return(e,a)=>{const n=N,i=E,m=L;return u(),I("div",X,[Y,f("div",Z,[_(n,{variant:"outline-primary",size:"sm",onClick:d,disabled:x(t).isUserEmpty},{default:k(()=>[T("匯入")]),_:1},8,["disabled"]),l.value>0&&!w.value?(u(),y(n,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:o},{default:k(()=>[_(i)]),_:1})):h("",!0),w.value?(u(),y(m,{key:1,variant:"primary",class:"ms-1"})):h("",!0)]),c.value>0?(u(),I("small",ee,g(c.value)+" 檔案, "+g(l.value)+" 筆記錄, 有效 "+g(p.value)+" 筆 Device ID ",1)):h("",!0)])}}}),se={class:"ta-file-wrapper"},oe=f("label",{for:"ta-file"},"受眾 (BOE 匯出 csv)",-1),ae={class:"d-flex mt-2 align-items-center w-100"},ne={key:0,class:"hint"},ie=$({__name:"ImportTa",setup(S){const t=b(),r=v(0),c=v(0),l=async()=>{(await window.showOpenFilePicker({id:"market-import-ta-"+t.hashCode(t.campaignName),multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]})).forEach(async s=>{const e=await(await s.getFile()).text();p(e)})},p=d=>{H.parse(d,{header:!0,skipEmptyLines:!0,transformHeader:(s,o)=>(console.log(`Header: ${o}`,s),s==="特定用戶名單(TAMI專用)"?"groupName":s.startsWith("Subscr Id")?"subId":s==="台灣大會員編號"?"twmId":(s.startsWith('"')||t.userArgSet.add(s),s)),complete:s=>{if(s.errors.length>0){alert("Parse Error");return}console.log(`[TaFile] add ${s.data.length} Users begin`),c.value+=s.data.length;for(let o=0;o<s.data.length;o++){const e=s.data[o],a={};t.userArgSet.forEach(n=>{a[n]=e[n]}),e.twmId||(e.twmId=e.subId),t.addUser(e.twmId,e.subId,void 0,a)}console.log(`[TaFile] add ${s.data.length} Users Complete`),t.groupList.push(...w(s.data)),r.value+=t.groupList.length,console.log(`[TaFile] complete ${t.groupList.length} TaGroup`)}})},w=d=>{const s=new Map;return d.forEach(o=>{let e;s.has(o.groupName)?e=s.get(o.groupName):(e=new O(o.groupName),s.set(o.groupName,e)),e==null||e.addTwmId(o.twmId)}),Array.from(s.values())};return(d,s)=>{const o=N;return u(),I("div",se,[oe,f("div",ae,[_(o,{variant:"outline-primary",size:"sm",onClick:l},{default:k(()=>[T("匯入")]),_:1})]),c.value>0?(u(),I("small",ne," 載入 "+g(r.value)+" 群, "+g(c.value)+" 筆記錄, "+g(x(t).userArgSet.size)+" 參數 ",1)):h("",!0)])}}}),ce={class:"marketing"},re=f("h1",null,"行銷管理小平台",-1),le={class:"main"},ue={class:"title-wrapper section"},me={class:"file-wrapper"},pe={key:0,class:"main-wrapper section"},he=$({__name:"Marketing",setup(S){const t=b(),r=V();W(async()=>{await r.initDB()});const c=C(()=>t.groupList&&t.groupList.length>0),l=C(()=>t.smsGroupList&&t.smsGroupList.length>0);return(p,w)=>{const d=M,s=ie,o=P,e=U,a=te,n=Q,i=R,m=z;return u(),I("div",ce,[re,f("div",le,[f("section",ue,[_(d)]),f("section",me,[_(s,{class:"section"}),_(o,{class:"section"}),_(e,{class:"section"}),_(a,{class:"section"}),_(n,{class:"section"})]),c.value||l.value?(u(),I("section",pe,[c.value?(u(),y(i,{key:0})):h("",!0),l.value?(u(),y(m,{key:1})):h("",!0)])):h("",!0)])])}}});export{he as default};
