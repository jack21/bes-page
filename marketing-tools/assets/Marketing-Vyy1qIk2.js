import{_ as M,a as R,b as U,c as P,d as z,e as V}from"./CampaignName.vue_vue_type_style_index_0_lang-K60b2WQU.js";import{d as b,u as S,r as g,w as N,c as F,o as _,a as C,b as v,e as u,f as k,g as E,h as B,i as $,j as I,t as y,p as L,k as D,P as H,T as A,S as O,l as j,_ as W,m as q,y as J,n as K,q as Q}from"./index-yzqIMuRr.js";import"./download-0Vphgf6G.js";import"./delete-outline-n4iW_rRp.js";const X={class:"import-coupon"},Y=v("label",{for:"sms-file"},"已發送優惠券",-1),Z={class:"d-flex mt-2 align-items-center w-100"},ee={key:0,class:"hint"},te=b({__name:"ImportCoupon",setup(x){const t=S(),c=g(0),p=g(0),m=g(0),f=g(0);N(c,(e,n)=>{e===0&&n>0&&t.refreshFilted()});const h=F(()=>c.value>0),l=async()=>{const e=await window.showOpenFilePicker({id:"market-import-coupon-"+t.hashCode(t.campaignName),multiple:!0,types:[{accept:{"text/plain":[".txt"]}}]});c.value=e.length,e.forEach(async n=>{const i=await(await n.getFile()).text();s(i)})},s=e=>{const n=e==null?void 0:e.split(`
`),a=f.value;m.value+=n.length,n.forEach(d=>{const r=d.split("	"),w=r[0],T=r[2].trim(),G=t.phoneNumberUserMap.get(w);G&&(G.couponCode=T,f.value++)});const i=f.value;console.log(`[SmsFile] load ${i-a} Sent Phone Numbers, Total: ${f.value}`),c.value--,p.value++},o=()=>{p.value=0,m.value=0,f.value=0,t.phoneNumberUserMap.forEach(e=>{e.couponCode=void 0}),t.refreshFilted()};return(e,n)=>{const a=L,i=M,d=D;return _(),C("div",X,[Y,v("div",Z,[u(a,{variant:"outline-primary",size:"sm",onClick:l,disabled:B(t).isUserEmpty},{default:k(()=>[E("匯入")]),_:1},8,["disabled"]),m.value>0&&!h.value?(_(),$(a,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:o},{default:k(()=>[u(i)]),_:1})):I("",!0),h.value?(_(),$(d,{key:1,variant:"primary",class:"ms-1"})):I("",!0)]),p.value>0?(_(),C("small",ee,y(p.value)+" 檔案, "+y(m.value)+" 筆記錄, "+y(f.value)+" 有效優惠券",1)):I("",!0)])}}}),se={class:"sms-file-wrapper"},oe=v("label",{for:"sms-file"},"TAMI DeviceID (多選)",-1),ne={class:"d-flex mt-2 align-items-center w-100"},ae={key:0,class:"hint"},ie=b({__name:"ImportTamiDeviceId",setup(x){const t=S(),c=g(0),p=g(0),m=g(0),f=g(0);N(c,(e,n)=>{e===0&&n>0&&t.refreshFilted()});const h=F(()=>c.value>0),l=async()=>{const e=await window.showOpenFilePicker({id:"market-tami-deviceid-"+t.hashCode(t.campaignName),multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]});!e||e.length===0||(c.value=e.length,e.forEach(async n=>{const i=await(await n.getFile()).text();s(i)}))},s=e=>{const n=e.split(`
`);m.value+=n.length;let a=n.map(i=>{const d=i.split(",");return{subId:d[1],deviceId:d[2]}});a=a.filter(i=>i.deviceId&&i.deviceId!=="00000000-0000-0000-0000-000000000000"),f.value+=a.length,a.forEach(i=>{const d=t.subIdUserMap.get(i.subId);d&&(d.deviceId=i.deviceId)}),console.log(`[SmsFile] load ${a.length}`),c.value--,p.value++},o=()=>{p.value=0,m.value=0,t.phoneNumberSentSet.clear(),t.refreshFilted()};return(e,n)=>{const a=L,i=M,d=D;return _(),C("div",se,[oe,v("div",ne,[u(a,{variant:"outline-primary",size:"sm",onClick:l,disabled:B(t).isUserEmpty},{default:k(()=>[E("匯入")]),_:1},8,["disabled"]),m.value>0&&!h.value?(_(),$(a,{key:0,variant:"outline-primary",size:"sm",class:"remove ms-1",onClick:o},{default:k(()=>[u(i)]),_:1})):I("",!0),h.value?(_(),$(d,{key:1,variant:"primary",class:"ms-1"})):I("",!0)]),p.value>0?(_(),C("small",ae,y(p.value)+" 檔案, "+y(m.value)+" 筆記錄, 有效 "+y(f.value)+" 筆 Device ID ",1)):I("",!0)])}}}),ce={class:"ta-file-wrapper"},re=v("label",{for:"ta-file"},"受眾 (BOE 匯出 csv)",-1),le={class:"d-flex mt-2 align-items-center w-100"},pe={key:0,class:"hint"},ue=b({__name:"ImportTa",setup(x){const t=S(),c=g(0),p=g(0),m=async()=>{(await window.showOpenFilePicker({id:"market-import-ta-"+t.hashCode(t.campaignName),multiple:!0,types:[{accept:{"text/csv":[".csv"]}}]})).forEach(async s=>{const e=await(await s.getFile()).text();f(e)})},f=l=>{H.parse(l,{header:!0,skipEmptyLines:!0,transformHeader:(s,o)=>(console.log(`Header: ${o}`,s),s==="特定用戶名單(TAMI專用)"?"groupName":s.startsWith("Subscr Id")?"subId":s==="台灣大會員編號"?"twmId":(s.startsWith('"')||t.userArgSet.add(s),s)),complete:s=>{if(s.errors.length>0){alert("Parse Error");return}console.log(`[TaFile] add ${s.data.length} Users begin`),p.value+=s.data.length;for(let o=0;o<s.data.length;o++){const e=s.data[o],n={};t.userArgSet.forEach(a=>{n[a]=e[a]}),t.addUser(e.twmId,e.subId,void 0,n)}console.log(`[TaFile] add ${s.data.length} Users Complete`),t.groupList.push(...h(s.data)),c.value+=t.groupList.length,console.log(`[TaFile] complete ${t.groupList.length} TaGroup`)}})},h=l=>{const s=new Map;return l.forEach(o=>{let e;s.has(o.groupName)?e=s.get(o.groupName):(e=new A(o.groupName),s.set(o.groupName,e)),e==null||e.addTwmId(o.twmId)}),Array.from(s.values())};return(l,s)=>{const o=L;return _(),C("div",ce,[re,v("div",le,[u(o,{variant:"outline-primary",size:"sm",onClick:m},{default:k(()=>[E("匯入")]),_:1})]),p.value>0?(_(),C("small",pe," 載入 "+y(c.value)+" 群, "+y(p.value)+" 筆記錄, "+y(B(t).userArgSet.size)+" 參數 ",1)):I("",!0)])}}}),me={class:"campaign-config-wrapper"},de=v("span",null,"匯出設定檔",-1),_e=v("span",null,"匯入設定檔",-1),fe=b({__name:"MarketingConfigFile",setup(x){const t=S(),c=g(),p=g(null);N(c,()=>{c.value&&m(c.value)});const m=l=>{const s=new FileReader;s.onload=function(o){var d;const e=(d=o.target)==null?void 0:d.result,n=JSON.parse(e);t.campaignName=n.name;const a=new Map;n.groupList.forEach(r=>a.set(r.name,r)),t.groupList.length=0,n.taGroupNameList.forEach(r=>{const w=a.get(r);w&&t.groupList.push(new A(w.name,w.twmIdList))}),t.smsGroupList.length=0,n.smsGroupNameList.forEach(r=>{const w=a.get(r);if(w){const T=new O(w.name,w.twmIdList);T.smsTwmIdList=w.smsTwmIdList.slice(0),t.smsGroupList.push(T)}}),n.userInfoList.slice(0).forEach(r=>{r.subId&&r.subId.length>0&&t.subIdUserMap.set(r.subId,r),r.twmId&&r.twmId.length>0&&t.twmIdUserMap.set(r.twmId,r)}),t.refreshFilted()},s.readAsText(l)},f=async()=>{var l;[l]=await window.showOpenFilePicker({multiple:!0,types:[{description:"Images",accept:{"image/*":[".png",".gif",".jpeg",".jpg"]}}]}),console.log(l);const s=await l.getFile();console.log(s);const o=await s.text();console.log(o)},h=async()=>{const o=`http://bizsms.taiwanmobile.com:18994/send.cgi?username=VCST011400&password=7499639952&rateplan=A&srcaddr=8708246&dstaddr=0932087196&smbody=${encodeURI(`⏰台灣大%field1%資費用戶
符合您59折資格4h後結束！日本麗克特三明治機送18道食譜及環保袋https://twm5g.co/eoDP`)}`,{data:e}=await j.get(o);console.log(e)};return(l,s)=>{const o=W,e=L,n=q,a=J;return _(),C("div",me,[u(e,{variant:"outline-primary",size:"sm",onClick:h,class:"ms-1"},{default:k(()=>[u(o),de]),_:1}),u(e,{variant:"outline-primary",size:"sm",onClick:f,class:"ms-1"},{default:k(()=>[u(n),_e]),_:1}),u(a,{ref_key:"configFileRef",ref:p,id:"import-campaign-config",modelValue:c.value,"onUpdate:modelValue":s[0]||(s[0]=i=>c.value=i),accept:"application/json"},null,8,["modelValue"])])}}}),ge={class:"marketing"},ve=v("h1",null,"行銷管理小平台",-1),he={class:"main"},we={class:"title-wrapper section"},Ie={class:"file-wrapper"},ye={key:0,class:"main-wrapper section"},Se=b({__name:"Marketing",setup(x){const t=S(),c=K();Q(async()=>{await c.initDB()});const p=F(()=>t.groupList&&t.groupList.length>0),m=F(()=>t.smsGroupList&&t.smsGroupList.length>0);return(f,h)=>{const l=R,s=fe,o=ue,e=U,n=P,a=ie,i=te,d=z,r=V;return _(),C("div",ge,[ve,v("div",he,[v("section",we,[u(l),u(s)]),v("section",Ie,[u(o,{class:"section"}),u(e,{class:"section"}),u(n,{class:"section"}),u(a,{class:"section"}),u(i,{class:"section"})]),p.value||m.value?(_(),C("section",ye,[p.value?(_(),$(d,{key:0})):I("",!0),m.value?(_(),$(r,{key:1})):I("",!0)])):I("",!0)])])}}});export{Se as default};
